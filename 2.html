<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calculadora Nutricional</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html::-webkit-scrollbar,
body::-webkit-scrollbar,
*::-webkit-scrollbar {
  width: 0px !important;
  height: 0px !important;
  background: transparent !important;
}
html, body { user-select: none !important; -webkit-user-select: none !important; -ms-user-select: none !important; }
html,body{margin:0;padding:0;width:100%;font-family:sans-serif;background: transparent !important;}
body.panel-abierto,html.panel-abierto { overflow: hidden; height: 100%; }
h1,h2,h3,h4,h5,h6{text-align:center;margin:0.5rem 0}
.hidden { display: none !important; }
table{width:100%;font-size:.8rem;border-radius:.5rem;border-collapse:separate;border-spacing:0;overflow:hidden;table-layout:fixed}
table thead{background:#f0f0f0;border-bottom:1px solid #ccc;border-spacing:0}
table th,table td{padding:0;color:black;vertical-align:middle;border:1px solid #ddd;border-spacing:0;border-radius:1rem;word-wrap:break-word;white-space:normal;overflow-wrap:break-word}
table th:nth-child(1),table td:nth-child(1){width:40%;text-align:left;padding:5px}
table th:nth-child(2),table td:nth-child(2),table th:nth-child(3),table td:nth-child(3){width:20%;text-align:center}
table th:nth-child(4),table td:nth-child(4){width:20%;text-align:center}
.barra{position:sticky;top:0;display:flex;align-items:center;justify-content:center;height:2.5rem;background:#FFFFFF;z-index:10;gap:1rem;border-bottom: 1px solid #ccc}
.barra h3{margin:0;flex:1;text-align:center}
.barra button{background:none;border:none;font-size:.8rem;font-weight:600}
.barra button.cerrar{font-size:1.5rem;padding-left:1.1rem}
button.transparente { font-weight: bold; color: transparent; }
.fs-mode .barra {
  margin-top: 1rem;
}
#panel, #panel1, #panel2, #panel3 {  position:fixed;top:0;left:0;width:100%;height:100%;background:#FFFFFF;z-index:100;overflow:auto;display:none}
.menu-izquierdo button{background:none;border:none;width:100%;padding:12px 9px;text-align:left;font-weight:600;font-size:1rem;color:#111;display:flex;align-items:center;gap:10px}
.menu-izquierdo button:hover{background-color:#eee}
.menu-izquierdo button:focus{outline:none}
.titulo-comida{position:absolute;left:0px;top:50%;transform:translateY(-50%);font-size:1rem;margin:0;padding:0}
.contenedor-select{position:relative;display:flex;justify-content:center;align-items:center;margin:0.5rem}
.select-editor { width: 100%; box-sizing: border-box; padding: 0 8px; font-size: .8rem; border: none; border-radius: 0; background: none; appearance: none; -webkit-appearance: none; -moz-appearance: none; color: inherit; font-family: inherit; text-align: center; }
.select-categorias{box-sizing:border-box;text-align:center;font-weight:
600;-webkit-appearance:none;font-size:.8rem;padding:9px 8px;border:1px solid #ccc;border-radius:1rem;background-color:#FFFFFF;height:auto;max-width:100%}
select:focus,.select-unidad:focus{outline:none}
.fila-comida{display:flex;align-items:center;gap:.5rem;margin:0;width:100%;flex-wrap:nowrap}
[contenteditable][placeholder]:empty:before { content: attr(placeholder); color: #999; pointer-events: none; display: inline-block; font-size:.8rem; }
.placeholder-activo {
  color: #9b9b9b !important;
  font-weight: normal; /* opcional, si querÃ©s distinguir aÃºn mÃ¡s */
}
[contenteditable]:focus { outline: none; }
[contenteditable]:focus:empty::before { content: ""; }
.contenedor-buscador{flex:0 0 70%;display:flex;flex-direction:column;position:relative;min-width:0;margin-bottom:0.5rem}
.input-buscador{box-sizing:border-box;padding:6px 12px;font-size:.8rem;line-height:1.5;height:auto;border:1px solid #ccc;border-radius:1rem;background:#FFFFFF;width:100%}
.contenedor-peso{flex:0 0 30%;display:flex;align-items:center;gap:4px;margin-bottom:0.5rem}
.etiqueta-peso{font-size:13px;font-weight:600;line-height:1.5;display:flex;align-items:center}
.input-peso{text-align:center;box-sizing:border-box;padding:6px;font-size:.8rem;line-height:1.5;height:auto;border:1px solid #ccc;border-radius:1rem;background:#FFFFFF;width:100%;margin-right:0.5rem;}
.divisor-box{display:flex;justify-content:center;align-items:center;gap:.5rem}
.input-divir{text-align:center;box-sizing:border-box;padding:6px;font-size:.8rem;line-height:1.5;height:auto;border:1px solid #ccc;border-radius:1rem;background:#FFFFFF;width:50%;margin-bottom:.5rem}
.sugerencias-lista{list-style:none;margin:0;padding:0;max-height:160px;overflow-y:auto;overflow-x:hidden;background: transparent !important;border-radius:.5rem;font-size:.8rem;position:absolute;z-index:5;width:100%;top:100%;left:0}
.sugerencias-lista li{border-radius:1rem;background: #FFFFFF;display:flex;align-items:center;height:32px;border:1px solid #ccc;border-top:none;}
.sugerencias-lista button{all:unset;display:flex;align-items:center;justify-content:flex-start;width:100%;height:100%;padding:0 14px;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:border-radius:1rem;ellipsis;transition:background .2s ease}
.sugerencias-lista button:active{background-color:#f5f5f5}
.contenedor0{text-align:center;margin-top:.5rem}
.contenedor0 button{display:inline-block;font-weight:bold;padding:6px 10px;font-size:.8rem;background-color:#f5f5f5;border:1px solid #ccc;border-radius:1rem;transition:background .2s ease;margin-bottom:.5rem}
#lista-usuarios{margin-bottom:1rem;display:flex;overflow-x:auto;justify-content:center}
#lista-usuarios.con-perfiles{justify-content:flex-start}
.perfil-avatar{width:120px;height:auto;display:flex;flex-direction:column;align-items:center;text-align:center;font-size:4rem;overflow:hidden;margin-top:1rem}
.perfil-avatar p{font-size:.8rem;font-weight:bold;color:black;margin:4px 0 0 0;line-height:1.1;text-align:center;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word}
.perfil-avatar.add{color:black}
#lista-emojis span{flex:0 0 auto;width:72px;display:flex;flex-direction:column;align-items:center;text-align:center;scroll-snap-align:center}
#alerta-modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;pointer-events:none}
#alerta-modal.mostrar{opacity:1;pointer-events:auto}
.alerta-contenido{background:white;padding:20px 25px;border-radius:14px;max-width:320px;width:73%;text-align:center}
.alerta-contenido p{font-size:.8rem;color:grey;font-weight:600}
.compartir-opcion{display:flex;align-items:flex-start;padding-left:20px}
.compartir-opcion input[type=checkbox]{appearance:none;-webkit-appearance:none;width:6px;height:6px;border:1px solid black;border-radius:50%;margin-right:4px;flex-shrink:0;margin-top:5px;font-weight:bold}
.compartir-opcion input[type=checkbox]:checked{background-color:black}
.compartir-opcion span{flex:1;text-align:left;display:inline-block;vertical-align:middle}
.alerta-contenido button{background:transparent;border:none;border-radius:1rem;padding:8px 14px;font-size:.8rem;font-weight:bold;outline:none}
.alerta-contenido button:active{background:rgba(0,0,0,.1)}
#alerta-aceptar{color:#000}
#alerta-cancelar{color:#000}
#toast{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}
#toast.mostrar{opacity:1;pointer-events:auto}
#toast .toast-contenido{;background:white;padding:20px 25px;border-radius:12px;max-width:320px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.3);font-size:.8rem;color:black;font-weight:bold}
.drag-ghost {opacity: 0;}
.drag-fallback {opacity: 1!important;}
.drag-fallback .perfil-avatar {filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.7));transform: scale(1.05);}
.descripcion-nutriente.hidden {
  display: none;
}
.nombre-nutriente: hover {
  text-decoration: underline;
}
/* Contenedor principal de datos */
.datos-usuario {
  margin-top: 1rem;
  margin-bottom: 3rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  width: 100%;
}

.campo-integrado.campo-nombre label {
  left: 50% !important;
  transform: translateX(-50%) !important;
  text-align: center;
}

/* Nombre ocupa todo el ancho */
.campo-nombre {
  width: 50%;
  text-align: center;
}

/* Los demÃ¡s inputs van en fila */
.fila-campos {
  width: 92%;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 1rem;
}

/* Caja de cada input */
.campo-integrado {
  position: relative;
  width: 46%;
}

/* Label incrustado en el borde */
.campo-integrado label {
  position: absolute;
  top: -0.5rem;
  left: .8rem;
  background: #FFFFFF;
  padding: 0 4px;
  font-size: .7rem;
  font-weight: 600;
  color: grey;
}

/* Input estilo pastilla */
.input-integrado {
  padding: 8px 16px;
  border: 1px solid #ccc;
  border-radius: 999px;
  outline: none;
  background: white;
  font-size: .8rem;
  font-weight: 600;
}

/* Placeholder ghost */
.input-integrado:empty:before {
  content: attr(data-placeholder);
  color: #999;
  pointer-events: none;
}
</style>
</head>
<body>
  
<div class="barra">
  <button data-action="open" data-target="panel1" class="cerrar">+</button>
  <h3 class="titulo-calculadora">Calculadora Nutricional</h3>
  <button onclick="abrirVDR()">VDR%</button>
</div>

<div id="panel">
  <div class="barra">
    <button onclick="cerrarVDR()" class="cerrar">Ã—</button>
    <h3>Personalizar VDR%</h3>
    <button onclick="guardarVDR()">VDR%</button>
  </div>
  <div id="tabla-vdr"></div>
</div>

<div id="panel1">
  <div class="barra">
    <button data-action="close" data-target="panel1" class="cerrar">Ã—</button>
    <h3 class="titulo-calculadora">Calculadora Nutricional</h3>
    <button data-action="open" data-target="panel2" data-close="panel1" onclick="renderizarDistribucion()">
      VDR%
    </button>
  </div>

  <div class="menu-izquierdo">
    <div id="lista-usuarios"></div>
  </div>

  <div style="text-align:center;">
    <button id="btn-editar-perfiles" class="hidden" 
      style="margin-top:2rem; padding:14px 14px; font-weight:bold; font-size:1rem; border-radius:3rem; background:#000000; color:white; border: 1px solid #000000;">
      Editar perfiles
    </button>
  </div>

  <div id="editor-usuario" class="hidden">
    <div class="barra">
      <button onclick="cerrarEditorUsuario()" id="btn-cancelar">Cancelar</button>
      <button onclick="eliminarUsuarioActual()" id="btn-eliminar-usuario" style="display:none;">Eliminar</button>
      <h3 id="titulo-editor">Nuevo perfil</h3>
      <button onclick="guardarUsuario()" id="btn-guardar-usuario">Guardar</button>
    </div>

<div class="datos-usuario">

  <div id="avatar-preview" class="perfil-avatar" style="margin:0 auto;">ğŸ™‚</div>

  <!-- NOMBRE (ocupa toda la fila) -->
  <div class="campo-integrado campo-nombre">
    <label for="input-nombre-usuario">Nombre</label>
    <div id="input-nombre-usuario"
         class="input-integrado"
         contenteditable="true"
         data-max-digitos="23"
         data-placeholder="Nombre del perfil"></div>
  </div>

  <!-- Fila con los demÃ¡s campos -->
  <div class="fila-campos">
    
      <!-- FECHA -->
    <div class="campo-integrado">
      <label for="input-fecha">Fecha de nacimiento</label>
      <div id="input-fecha"
           class="input-integrado"
           contenteditable="true"
           data-max-digitos="10"
           data-placeholder="Ej: 14/01/1997"></div>
    </div>

    <!-- EDAD -->
    <div class="campo-integrado">
      <label for="input-edad">Edad</label>
      <div id="input-edad"
           class="input-integrado"
           contenteditable="true"
           inputmode="decimal"
           data-max-digitos="3"
           data-placeholder="Ej: 28 (aÃ±os)"></div>
    </div>

    <!-- ALTURA -->
    <div class="campo-integrado">
      <label for="input-altura">Altura</label>
      <div id="input-altura"
           class="input-integrado"
           contenteditable="true"
           inputmode="decimal"
           data-max-digitos="3"
           data-placeholder="Ej: 178 (cm)"></div>
    </div>
    
        <!-- PESO -->
    <div class="campo-integrado">
      <label for="input-peso">Peso</label>
      <div id="input-peso"
           class="input-integrado"
           contenteditable="true"
           inputmode="decimal"
           data-max-digitos="3"
           data-placeholder="Ej: 65 (kg)"></div>
    </div>

  </div>
</div>

      <div id="lista-emojis" 
           style="display:flex; justify-content:center; flex-wrap:wrap; margin-top:1rem;">
      </div>
    </div>
  </div>

  <div class="menu-izquierdo"></div>
</div>

<div id="panel2">
  <div class="barra">
    <button data-action="close" data-target="panel2" data-open="panel1" class="cerrar">Ã—</button>
    <h3>DistribuciÃ³n VDR%</h3>
    <button onclick="distribucion()">VDR%</button>
  </div>
  <div id="tabla-distribucion-vdr"></div>
</div>

<div id="panel3">
  <div class="barra">
    <button data-action="close" data-target="panel3" data-open="panel1" class="cerrar">Ã—</button >
    <h3>Calculadora Nutricional</h3>
    <button class="transparente">VDR%</button>
  </div>
</div>

<div id="contenedor-comidas"></div>

<div id="alerta-modal" class="hidden">
  <div class="alerta-contenido">
    <p id="alerta-texto"></p>
    <div style="display:flex; justify-content:center; gap:12px;">
      <button id="alerta-cancelar">Cancelar</button>
      <button id="alerta-aceptar">Eliminar</button>
    </div>
  </div>
</div>

<div id="toast">
  <div class="toast-contenido"></div>
</div>

<script>

function entrarFullscreen() {
  if (!document.fullscreenElement) {
    return document.documentElement
      .requestFullscreen()
      .catch(err => console.error(err));
  }
  return Promise.resolve();
}

document.addEventListener("fullscreenchange", () => {
  const barras = document.querySelectorAll(".barra");
  
  barras.forEach(b => {
    if (document.fullscreenElement) {
      b.style.height = `calc(${getComputedStyle(b).height} + 1.5rem)`; // aumentar altura
      b.style.paddingTop = `1.5rem`; // agregar padding superior
    } else {
      b.style.height = "";
      b.style.paddingTop = "";
    }
  });
});

const comidas=["Desayuno","Almuerzo","Merienda","Cena"];
const categorias=["Frutas","Verduras","Cereales","LÃ¡cteos","Carnes","Huevos"];
const nutrientes = {
  "Peso Total": [
    { nombre: "Agua", unidad: "g", descripcion: "Componente principal del alimento; esencial para funciones celulares, transporte de nutrientes y regulaciÃ³n de la temperatura corporal. No aporta energÃ­a (0 kcal/g)." },
    { nombre: "SÃ³lidos totales", unidad: "g", descripcion: "Parte seca del alimento que incluye carbohidratos, proteÃ­nas, grasas y minerales; representa la materia nutritiva disponible. Su aporte energÃ©tico depende de los componentes individuales." }
  ],
  
  "Macronutrientes": {
    "Principales": [
      { nombre: "EnergÃ­a", unidad: "kcal", descripcion: "Cantidad total de energÃ­a que el cuerpo puede obtener del alimento; proviene de proteÃ­nas (4 kcal/g), carbohidratos (4 kcal/g), grasas (9 kcal/g) y alcohol (7 kcal/g)." },
      { nombre: "ProteÃ­nas", unidad: "g", descripcion: "Macronutriente formado por aminoÃ¡cidos; esencial para la formaciÃ³n y reparaciÃ³n de tejidos, enzimas y hormonas. Aporta 4 kcal por gramo." },
      { nombre: "Carbohidratos", unidad: "g", descripcion: "Incluye azÃºcares, almidÃ³n y fibras; los azÃºcares y el almidÃ³n aportan energÃ­a (4 kcal/g), mientras que las fibras promueven la salud digestiva." },
      { nombre: "Grasas totales", unidad: "g", descripcion: "LÃ­pidos que aportan energÃ­a concentrada (9 kcal/g); participan en la absorciÃ³n de vitaminas liposolubles y en la formaciÃ³n de membranas celulares." },
      { nombre: "Alcohol etÃ­lico", unidad: "g", descripcion: "Fuente de energÃ­a no esencial (7 kcal/g); se metaboliza en el hÃ­gado y aporta calorÃ­as sin proporcionar nutrientes esenciales." },
      { nombre: "CafeÃ­na", unidad: "mg", descripcion: "Estimulante del sistema nervioso central; aumenta alerta y reduce la fatiga." },
      { nombre: "Cenizas", unidad: "g", descripcion: "Residuo mineral total tras la combustiÃ³n del alimento; refleja la cantidad total de minerales presentes." }
    ],
    
    "Componentes de proteÃ­nas": {
      "AminoÃ¡cidos esenciales": [
        { nombre: "Histidina", unidad: "mg", descripcion: "AminoÃ¡cido esencial necesario para el crecimiento, reparaciÃ³n de tejidos y funciÃ³n inmune." },
        { nombre: "Isoleucina", unidad: "mg", descripcion: "AminoÃ¡cido que contribuye a la recuperaciÃ³n muscular y equilibrio energÃ©tico." },
        { nombre: "Leucina", unidad: "mg", descripcion: "Estimula la sÃ­ntesis de proteÃ­nas musculares y favorece la regeneraciÃ³n de tejidos." },
        { nombre: "Lisina", unidad: "mg", descripcion: "Fundamental para el crecimiento, formaciÃ³n de colÃ¡geno y absorciÃ³n de calcio." },
        { nombre: "Metionina", unidad: "mg", descripcion: "AminoÃ¡cido esencial que apoya el metabolismo y la desintoxicaciÃ³n hepÃ¡tica." },
        { nombre: "Fenilalanina", unidad: "mg", descripcion: "Precursora de dopamina y adrenalina; importante para la funciÃ³n cerebral y el estado de Ã¡nimo." },
        { nombre: "Treonina", unidad: "mg", descripcion: "Contribuye a la salud del hÃ­gado, el sistema inmune y el metabolismo proteico." },
        { nombre: "TriptÃ³fano", unidad: "mg", descripcion: "Precursora de serotonina y melatonina; apoya el sueÃ±o y el bienestar general." },
        { nombre: "Valina", unidad: "mg", descripcion: "Favorece la energÃ­a, recuperaciÃ³n y regeneraciÃ³n muscular." }
      ],
      
      "AminoÃ¡cidos condicionalmente esenciales": [
        { nombre: "CisteÃ­na", unidad: "mg", descripcion: "AminoÃ¡cido con funciÃ³n antioxidante y componente de queratina; importante para cabello, piel y uÃ±as." },
        { nombre: "Tirosina", unidad: "mg", descripcion: "Precursora de dopamina y hormonas tiroideas; importante para el sistema nervioso y el metabolismo hormonal." },
        { nombre: "Arginina", unidad: "mg", descripcion: "AminoÃ¡cido condicionalmente esencial; mejora la circulaciÃ³n, funciÃ³n inmune y sÃ­ntesis de proteÃ­nas. Es esencial en niÃ±os cuando el cuerpo no produce suficiente cantidad." },
        { nombre: "Glutamina", unidad: "mg", descripcion: "Apoya la funciÃ³n inmune e intestinal; su requerimiento aumenta en estrÃ©s o enfermedad." },
        { nombre: "Prolina", unidad: "mg", descripcion: "Importante para la sÃ­ntesis de colÃ¡geno y la salud de tejidos conectivos." },
        { nombre: "Glicina", unidad: "mg", descripcion: "Participa en la sÃ­ntesis de colÃ¡geno y neurotransmisores; contribuye a funciones celulares y antioxidantes." }
      ]
    },
    
    "Componentes de carbohidratos": [
      { nombre: "AzÃºcares totales", unidad: "g", descripcion: "Carbohidratos simples presentes de forma natural o aÃ±adida que aportan energÃ­a rÃ¡pida." },
      { nombre: "Fibra insoluble", unidad: "g", descripcion: "Carbohidrato insoluble que no aporta energÃ­a; mejora el trÃ¡nsito intestinal y previene estreÃ±imiento." },
      { nombre: "Fibra soluble", unidad: "g", descripcion: "Carbohidrato soluble no digerible; ayuda a regular colesterol y glucosa en sangre. Aporta energÃ­a limitada (~2 kcal/g)." },
      { nombre: "AlmidÃ³n", unidad: "g", descripcion: "Carbohidrato complejo que libera glucosa lentamente, proporcionando energÃ­a sostenida." }
    ],
    
    "Componentes de grasas": [
      { nombre: "Grasas monoinsaturadas", unidad: "g", descripcion: "Grasas saludables presentes en aceite de oliva, frutos secos y palta; favorecen la salud cardiovascular." },
      { nombre: "Grasas poliinsaturadas", unidad: "g", descripcion: "Incluyen Ã¡cidos grasos esenciales omega-3 y omega-6; participan en funciones antiinflamatorias y hormonales." },
      { nombre: "Grasas saturadas", unidad: "g", descripcion: "LÃ­pidos sÃ³lidos a temperatura ambiente; su consumo excesivo puede aumentar el riesgo cardiovascular." },
      { nombre: "Grasas trans", unidad: "g", descripcion: "Grasas artificiales que aumentan el riesgo cardiovascular; deben evitarse." },
      { nombre: "Colesterol", unidad: "mg", descripcion: "LÃ­pido de origen animal necesario en pequeÃ±as cantidades para hormonas y membranas celulares." },
      { nombre: "Ãcido linoleico (Omega 6)", unidad: "g", descripcion: "Grasa esencial que participa en procesos inflamatorios, hormonales y celulares." },
      { nombre: "Ãcido alfa-linolÃ©nico (Omega 3)", unidad: "g", descripcion: "Grasa esencial con funciones antiinflamatorias y protectoras del corazÃ³n." },
      { nombre: "EPA (Ã¡cido eicosapentaenoico)", unidad: "g", descripcion: "Omega-3 marino que protege el corazÃ³n, reduce inflamaciÃ³n y apoya la funciÃ³n cerebral." },
      { nombre: "DHA (Ã¡cido docosahexaenoico)", unidad: "g", descripcion: "Omega-3 esencial para el desarrollo cerebral, la visiÃ³n y la salud cardiovascular." }
    ]
  },
  
  "Micronutrientes": {
    "Vitaminas liposolubles": [
      { nombre: "Vitamina A", unidad: "Âµg", descripcion: "Esencial para visiÃ³n, crecimiento celular, piel y funciÃ³n inmune; se almacena en hÃ­gado y tejidos grasos." },
      { nombre: "Vitamina D", unidad: "Âµg", descripcion: "Regula absorciÃ³n de calcio y fÃ³sforo; importante para huesos, dientes y funciÃ³n inmune. Su sÃ­ntesis depende de la exposiciÃ³n solar." },
      { nombre: "Vitamina E", unidad: "mg", descripcion: "Antioxidante que protege membranas celulares y tejidos del daÃ±o oxidativo." },
      { nombre: "Vitamina K", unidad: "Âµg", descripcion: "Necesaria para coagulaciÃ³n sanguÃ­nea y metabolismo Ã³seo." }
    ],
    
    "Vitaminas hidrosolubles": [
      { nombre: "Vitamina C", unidad: "mg", descripcion: "Antioxidante que fortalece el sistema inmune, ayuda a formar colÃ¡geno y mejora la absorciÃ³n de hierro." },
      { nombre: "Tiamina (B1)", unidad: "mg", descripcion: "Participa en el metabolismo energÃ©tico y el funcionamiento nervioso." },
      { nombre: "Riboflavina (B2)", unidad: "mg", descripcion: "Apoya el metabolismo de carbohidratos, grasas y proteÃ­nas; mantiene piel y ojos saludables." },
      { nombre: "Niacina (B3)", unidad: "mg", descripcion: "Interviene en el metabolismo energÃ©tico y la sÃ­ntesis de Ã¡cidos grasos." },
      { nombre: "Ãcido pantotÃ©nico (B5)", unidad: "mg", descripcion: "Participa en la producciÃ³n de energÃ­a y sÃ­ntesis de hormonas y colesterol." },
      { nombre: "Piridoxina (B6)", unidad: "mg", descripcion: "Participa en el metabolismo de aminoÃ¡cidos y la sÃ­ntesis de neurotransmisores." },
      { nombre: "Biotina (B7)", unidad: "Âµg", descripcion: "Coenzima que apoya el metabolismo de macronutrientes y la salud de cabello, piel y uÃ±as." },
      { nombre: "Ãcido fÃ³lico (B9)", unidad: "Âµg", descripcion: "Esencial para la formaciÃ³n de ADN y desarrollo fetal. Su requerimiento aumenta en embarazo." },
      { nombre: "Cobalamina (B12)", unidad: "Âµg", descripcion: "Necesaria para la formaciÃ³n de glÃ³bulos rojos, funciÃ³n neurolÃ³gica y sÃ­ntesis de ADN." },
      { nombre: "Colina", unidad: "mg", descripcion: "Importante para el cerebro, memoria y metabolismo de grasas. Su deficiencia afecta desarrollo fetal." }
    ],
    
    "Minerales": {
      "Macrominerales": [
        { nombre: "Calcio (Ca)", unidad: "mg", descripcion: "Fortalece huesos y dientes; participa en contracciÃ³n muscular y funciÃ³n nerviosa." },
        { nombre: "FÃ³sforo (P)", unidad: "mg", descripcion: "Trabaja con el calcio en huesos y dientes; importante para energÃ­a y ADN." },
        { nombre: "Magnesio (Mg)", unidad: "mg", descripcion: "Regula funciÃ³n muscular y nerviosa, producciÃ³n de energÃ­a y sÃ­ntesis de proteÃ­nas." },
        { nombre: "Sodio (Na)", unidad: "mg", descripcion: "Equilibra lÃ­quidos y presiÃ³n arterial. El exceso aumenta el riesgo de hipertensiÃ³n." },
        { nombre: "Potasio (K)", unidad: "mg", descripcion: "Regula funciÃ³n muscular y presiÃ³n arterial; mantiene el equilibrio de lÃ­quidos." },
        { nombre: "Cloro (Cl)", unidad: "mg", descripcion: "Ayuda en digestiÃ³n y equilibrio de fluidos; componente del Ã¡cido gÃ¡strico." },
        { nombre: "Azufre (S)", unidad: "mg", descripcion: "Componente de aminoÃ¡cidos y vitaminas; importante para el metabolismo y los tejidos." }
      ],
      "Oligoelementos": [
        { nombre: "Hierro (Fe)", unidad: "mg", descripcion: "Transporta oxÃ­geno y apoya la funciÃ³n inmune. Su deficiencia es comÃºn en mujeres y niÃ±os." },
        { nombre: "Zinc (Zn)", unidad: "mg", descripcion: "Participa en funciÃ³n inmune, cicatrizaciÃ³n y sÃ­ntesis de proteÃ­nas." },
        { nombre: "Cobre (Cu)", unidad: "mg", descripcion: "Interviene en formaciÃ³n de glÃ³bulos rojos, metabolismo y funciÃ³n antioxidante." },
        { nombre: "Manganeso (Mn)", unidad: "mg", descripcion: "Ayuda al metabolismo de carbohidratos y proteÃ­nas; contribuye al crecimiento Ã³seo." },
        { nombre: "Selenio (Se)", unidad: "Âµg", descripcion: "Antioxidante que protege cÃ©lulas y apoya la funciÃ³n tiroidea." },
        { nombre: "Yodo (I)", unidad: "Âµg", descripcion: "Esencial para la sÃ­ntesis de hormonas tiroideas y el metabolismo energÃ©tico." },
        { nombre: "Molibdeno (Mo)", unidad: "Âµg", descripcion: "Cofactor enzimÃ¡tico que participa en el metabolismo de aminoÃ¡cidos." },
        { nombre: "Cromo (Cr)", unidad: "Âµg", descripcion: "Contribuye al metabolismo de glucosa y al control del azÃºcar en sangre." },
        { nombre: "FlÃºor (F)", unidad: "mg", descripcion: "Fortalece dientes y huesos; previene caries y mantiene estructura Ã³sea." }
      ]
    }
  }
};

const alimentos = [
  {
    nombre: "Huevo entero crudo",
    categoria: "Huevos",
    composicion: {
      "Agua": 75.3,
      "SÃ³lidos totales": 24.7,
      "EnergÃ­a": 143,
      "ProteÃ­nas": 12.6,
      "Carbohidratos": 0.72,
      "Grasas totales": 9.5,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 1.1
    }
  },
  {
    nombre: "Leche entera",
    categoria: "LÃ¡cteos",
    composicion: {
      "Agua": 87,
      "SÃ³lidos totales": 13,
      "EnergÃ­a": 61,
      "ProteÃ­nas": 3.2,
      "Carbohidratos": 4.8,
      "Grasas totales": 3.3,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0.7
    }
  },
  {
    nombre: "Pan blanco",
    categoria: "Cereales",
    composicion: {
      "Agua": 36,
      "SÃ³lidos totales": 64,
      "EnergÃ­a": 265,
      "ProteÃ­nas": 9,
      "Carbohidratos": 49,
      "Grasas totales": 3.2,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 1.5
    }
  },
  {
    nombre: "Manzana cruda",
    categoria: "Frutas",
    composicion: {
      "Agua": 85.6,
      "SÃ³lidos totales": 14.4,
      "EnergÃ­a": 52,
      "ProteÃ­nas": 0.26,
      "Carbohidratos": 13.8,
      "Grasas totales": 0.17,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0.19
    }
  },
  {
    nombre: "Pollo cocido",
    categoria: "Carnes",
    composicion: {
      "Agua": 64,
      "SÃ³lidos totales": 36,
      "EnergÃ­a": 239,
      "ProteÃ­nas": 27.3,
      "Carbohidratos": 0,
      "Grasas totales": 13.6,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 1.1
    }
  },
  {
    nombre: "Arroz blanco cocido",
    categoria: "Cereales",
    composicion: {
      "Agua": 68,
      "SÃ³lidos totales": 32,
      "EnergÃ­a": 130,
      "ProteÃ­nas": 2.4,
      "Carbohidratos": 28.2,
      "Grasas totales": 0.3,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0.1
    }
  },
  {
    nombre: "Queso fresco",
    categoria: "LÃ¡cteos",
    composicion: {
      "Agua": 60,
      "SÃ³lidos totales": 40,
      "EnergÃ­a": 264,
      "ProteÃ­nas": 18,
      "Carbohidratos": 3.1,
      "Grasas totales": 21,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 1.8
    }
  },
  {
    nombre: "Tomate crudo",
    categoria: "Verduras",
    composicion: {
      "Agua": 94.5,
      "SÃ³lidos totales": 5.5,
      "EnergÃ­a": 18,
      "ProteÃ­nas": 0.9,
      "Carbohidratos": 3.9,
      "Grasas totales": 0.2,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0.5
    }
  },
  {
    nombre: "Papa hervida",
    categoria: "Verduras",
    composicion: {
      "Agua": 77,
      "SÃ³lidos totales": 23,
      "EnergÃ­a": 87,
      "ProteÃ­nas": 1.9,
      "Carbohidratos": 20,
      "Grasas totales": 0.1,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0.9
    }
  },
  {
    nombre: "Aceite de oliva",
    categoria: "Grasas y aceites",
    composicion: {
      "Agua": 0.2,
      "SÃ³lidos totales": 99.8,
      "EnergÃ­a": 884,
      "ProteÃ­nas": 0,
      "Carbohidratos": 0,
      "Grasas totales": 100,
      "Alcohol etÃ­lico": 0,
      "Cenizas": 0
    }
  }
];

const sistemas = {
  "1. Sistema Endocrino": {
    "HipotÃ¡lamo": [
      "Ãcido alfa-linolÃ©nico (ALA, Omega-3)",
      "Ãcido docosahexaenoico (DHA, Omega-3)",
      "Colina",
      "Tirosina",
      "Zinc (Zn)",
      "Vitamina D",
      "Piridoxina (B6)",
      "Cobalamina (B12)",
      "Folato (B9)"
    ]
  }
};

const vdr={"Agua":2000,"SÃ³lidos totales":3000,"EnergÃ­a":2000,"ProteÃ­nas":50,"Carbohidratos":300,"Grasas totales":70};

const coloresVDR={verde:"#2e7d32",amarillo:"#f9a825",rojo:"#FF0000"};

let distribucionVDR={"Desayuno":25,"Almuerzo":25,"Merienda":25,"Cena":25,"Total":100};

const nutrientesPlanos=[];
function aplanar(obj, niveles = []) { for (const [k, v] of Object.entries(obj)) { if (Array.isArray(v)) v.forEach(n => nutrientesPlanos.push({ ...n, niveles: [...niveles, k] }));
    else if (typeof v === "object" && v !== null) aplanar(v, [...niveles, k]); } }
aplanar(nutrientes);

const conversiones = {
  energia: { kcal: 1, kJ: 4.184 },
  masa: { g: 1, mg: 1000, Âµg: 1e6 },
  volumen: { L: 1, ml: 1000 }
};

function tipoUnidad(u) {
  if (["kcal", "kJ"].includes(u)) return "energia";
  if (["g", "mg", "Âµg"].includes(u)) return "masa";
  if (["L", "ml"].includes(u)) return "volumen";
  return null;
}

const densidades = {
  Agua: 1
};

function convertir(v, d, h, sustancia = "Agua") {
  const tipoD = tipoUnidad(d);
  const tipoH = tipoUnidad(h);
  
  if (!tipoD || !tipoH) return v;
  
  // ConversiÃ³n dentro del mismo tipo (ej. mg â†” g, ml â†” L)
  if (tipoD === tipoH) {
    const c = conversiones[tipoD];
    if (!c[d] || !c[h]) return v;
    return v * (c[h] / c[d]);
  }
  
  // Solo permitir masa <-> volumen si la sustancia es "Agua"
  if (sustancia !== "Agua") return v;
  
  const densidad = densidades[sustancia]; // en g/ml
  if (!densidad) return v;
  
  // Volumen â†’ Masa
  if (tipoD === "volumen" && tipoH === "masa") {
    const volML = v * (conversiones.volumen["ml"] / conversiones.volumen[d]);
    const gramos = volML * densidad;
    return gramos * (conversiones.masa[h] / conversiones.masa["g"]);
  }
  
  // Masa â†’ Volumen
  if (tipoD === "masa" && tipoH === "volumen") {
    const gramos = v / conversiones.masa[d];
    const volML = gramos / densidad;
    return volML * (conversiones.volumen[h] / conversiones.volumen["ml"]);
  }
  
  return v;
}

const mostrarTodosLosNutrientes = {},
  datosManualesUnidades = {},
  graficos = {},
  datosComidas = {},
  datosManuales = {},
  primerRender = {},
  datosOriginales = {},
  usuariosMap = {},
  limitesNutrientes = {};

let usuarioActivo = "Calculadora Nutricional";

const contenedor = document.getElementById("contenedor-comidas");
const listaUsuariosDiv = document.getElementById("lista-usuarios");

class Usuario {
  constructor(nombre, contenedor, comidas) {
    this.nombre = nombre;
    this.comidas = {};
    this.divTotal = null;
    
    this.vdr = { ...vdr };
    this.distribucionVDR = { ...distribucionVDR };
    
    usuariosMap[nombre] = this;
    
    comidas.forEach(c => {
      this.comidas[c] = { nombre: c };
      inicializarComida(nombre, c);
    });
    
    this.divTotal = crearSeccionTotal(nombre);
    contenedor.appendChild(this.divTotal);
  }
  
  distribucion() {
    comidas.forEach(c => this.actualizarComida(c));
    this.actualizarSeccionTotal();
  }
  
  actualizarComida(comida) {
    actualizarVistaComida(this.nombre, comida);
    this.actualizarSeccionTotal();
  }
  
  actualizarSeccionTotal() {
    actualizarVistaTotal(this.nombre, this.comidas);
  }
}

let avatarSeleccionado = "ğŸ™‚";
let usuarioEditando = null;
let indiceEmoji = 0;
let tonePickerEl = null;
let tonePickerOpenTarget = null;
let outsideHandler = null;

const categoriasEmojis = {
   "Emoticones y personas": [
   "ğŸ‘¶", "ğŸ‘§", "ğŸ§’", "ğŸ‘¦", "ğŸ‘©", "ğŸ§‘", "ğŸ‘¨", "ğŸ‘©â€ğŸ¦±", "ğŸ§‘â€ğŸ¦±", "ğŸ‘¨â€ğŸ¦±", "ğŸ‘©â€ğŸ¦°", "ğŸ§‘â€ğŸ¦°", "ğŸ‘¨â€ğŸ¦°",
   "ğŸ‘±â€â™€ï¸", "ğŸ‘±", "ğŸ‘±â€â™‚ï¸", "ğŸ‘©â€ğŸ¦³", "ğŸ§‘â€ğŸ¦³", "ğŸ‘¨â€ğŸ¦³", "ğŸ‘©â€ğŸ¦²", "ğŸ§‘â€ğŸ¦²", "ğŸ‘¨â€ğŸ¦²", "ğŸ§”â€â™€ï¸", "ğŸ§”", "ğŸ§”â€â™‚ï¸",
   "ğŸ‘µ", "ğŸ§“", "ğŸ‘´", "ğŸ‘²", "ğŸ‘³â€â™€ï¸", "ğŸ‘³", "ğŸ‘³â€â™‚ï¸", "ğŸ§•", "ğŸ‘®â€â™€ï¸", "ğŸ‘®", "ğŸ‘®â€â™‚ï¸", "ğŸ‘·â€â™€ï¸", "ğŸ‘·", "ğŸ‘·â€â™‚ï¸",
   "ğŸ’‚â€â™€ï¸", "ğŸ’‚", "ğŸ’‚â€â™‚ï¸"
 ],
 "Emoticones y personas1": [ // Detectives como grupos especiales
   ['ğŸ•µï¸â€â™€ï¸', 'ğŸ•µğŸ»â€â™€ï¸', 'ğŸ•µğŸ¼â€â™€ï¸', 'ğŸ•µğŸ½â€â™€ï¸', 'ğŸ•µğŸ¾â€â™€ï¸', 'ğŸ•µğŸ¿â€â™€ï¸'], // detective mujer
   ['ğŸ•µï¸', 'ğŸ•µğŸ»', 'ğŸ•µğŸ¼', 'ğŸ•µğŸ½', 'ğŸ•µğŸ¾', 'ğŸ•µğŸ¿'], // detective neutro
   ['ğŸ•µï¸â€â™‚ï¸', 'ğŸ•µğŸ»â€â™‚ï¸', 'ğŸ•µğŸ¼â€â™‚ï¸', 'ğŸ•µğŸ½â€â™‚ï¸', 'ğŸ•µğŸ¾â€â™‚ï¸', 'ğŸ•µğŸ¿â€â™‚ï¸'] // detective hombre
 ],
 "Emoticones y personas2": [
   "ğŸ‘©â€âš•ï¸", "ğŸ§‘â€âš•ï¸", "ğŸ‘¨â€âš•ï¸", "ğŸ‘©â€ğŸŒ¾", "ğŸ§‘â€ğŸŒ¾", "ğŸ‘¨â€ğŸŒ¾",
   "ğŸ‘©â€ğŸ³", "ğŸ§‘â€ğŸ³", "ğŸ‘¨â€ğŸ³", "ğŸ‘©â€ğŸ“", "ğŸ§‘â€ğŸ“", "ğŸ‘¨â€ğŸ“", "ğŸ‘©â€ğŸ¤", "ğŸ§‘â€ğŸ¤", "ğŸ‘¨â€ğŸ¤", "ğŸ‘©â€ğŸ«", "ğŸ§‘â€ğŸ«", "ğŸ‘¨â€ğŸ«",
   "ğŸ‘©â€ğŸ­", "ğŸ§‘â€ğŸ­", "ğŸ‘¨â€ğŸ­", "ğŸ‘©â€ğŸ’»", "ğŸ§‘â€ğŸ’»", "ğŸ‘¨â€ğŸ’»", "ğŸ‘©â€ğŸ’¼", "ğŸ§‘â€ğŸ’¼", "ğŸ‘¨â€ğŸ’¼", "ğŸ‘©â€ğŸ”§", "ğŸ§‘â€ğŸ”§", "ğŸ‘¨â€ğŸ”§",
   "ğŸ‘©â€ğŸ”¬", "ğŸ§‘â€ğŸ”¬", "ğŸ‘¨â€ğŸ”¬", "ğŸ‘©â€ğŸ¨", "ğŸ§‘â€ğŸ¨", "ğŸ‘¨â€ğŸ¨", "ğŸ‘©â€ğŸš’", "ğŸ§‘â€ğŸš’", "ğŸ‘¨â€ğŸš’", "ğŸ‘©â€âœˆï¸", "ğŸ§‘â€âœˆï¸", "ğŸ‘¨â€âœˆï¸",
   "ğŸ‘©â€ğŸš€", "ğŸ§‘â€ğŸš€", "ğŸ‘¨â€ğŸš€", "ğŸ‘©â€âš–ï¸", "ğŸ§‘â€âš–ï¸", "ğŸ‘¨â€âš–ï¸", "ğŸ‘°â€â™€ï¸", "ğŸ‘°", "ğŸ‘°â€â™‚ï¸", "ğŸ¤µâ€â™€ï¸", "ğŸ¤µ", "ğŸ¤µâ€â™‚ï¸",
   "ğŸ‘¸", "ğŸ«…", "ğŸ¤´", "ğŸ¥·", "ğŸ¦¸â€â™€ï¸", "ğŸ¦¸", "ğŸ¦¸â€â™‚ï¸", "ğŸ¦¹â€â™€ï¸", "ğŸ¦¹", "ğŸ¦¹â€â™‚ï¸", "ğŸ¤¶", "ğŸ§‘â€ğŸ„", "ğŸ…",
   "ğŸ§™â€â™€ï¸", "ğŸ§™", "ğŸ§™â€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸ§›â€â™€ï¸", "ğŸ§›", "ğŸ§›â€â™‚ï¸"
 ],
 "Emoticones y personas3": [
   "ğŸ§Œ", "ğŸ§Ÿâ€â™€ï¸", "ğŸ§Ÿ",
   "ğŸ§Ÿâ€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸"
 ],
   "Emoticones y personas4": [
   "ğŸ§œâ€â™€ï¸", "ğŸ§œ", "ğŸ§œâ€â™‚ï¸",
   "ğŸ§šâ€â™€ï¸", "ğŸ§š", "ğŸ§šâ€â™‚ï¸", "ğŸ‘¼", "ğŸ¤°", "ğŸ«„", "ğŸ«ƒ", "ğŸ¤±", "ğŸ‘©â€ğŸ¼", "ğŸ§‘â€ğŸ¼", "ğŸ‘¨â€ğŸ¼", "ğŸ™‡â€â™€ï¸", "ğŸ™‡", "ğŸ™‡â€â™‚ï¸",
   "ğŸ’â€â™€ï¸", "ğŸ’", "ğŸ’â€â™‚ï¸", "ğŸ™…â€â™€ï¸", "ğŸ™…", "ğŸ™…â€â™‚ï¸", "ğŸ™†â€â™€ï¸", "ğŸ™†", "ğŸ™†â€â™‚ï¸", "ğŸ™‹â€â™€ï¸", "ğŸ™‹", "ğŸ™‹â€â™‚ï¸",
   "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸ¤¦â€â™€ï¸", "ğŸ¤¦", "ğŸ¤¦â€â™‚ï¸", "ğŸ¤·â€â™€ï¸", "ğŸ¤·", "ğŸ¤·â€â™‚ï¸", "ğŸ™â€â™€ï¸", "ğŸ™", "ğŸ™â€â™‚ï¸",
   "ğŸ™â€â™€ï¸", "ğŸ™", "ğŸ™â€â™‚ï¸", "ğŸ’‡â€â™€ï¸", "ğŸ’‡", "ğŸ’‡â€â™‚ï¸", "ğŸ’†â€â™€ï¸", "ğŸ’†", "ğŸ’†â€â™‚ï¸", "ğŸ§–â€â™€ï¸", "ğŸ§–", "ğŸ§–â€â™‚ï¸",
   "ğŸ’…", "ğŸ¤³", "ğŸ’ƒ", "ğŸ•º", "ğŸ•´ï¸", "ğŸ‘©â€ğŸ¦½", "ğŸ§‘â€ğŸ¦½", "ğŸ‘¨â€ğŸ¦½", "ğŸ‘©â€ğŸ¦¼", "ğŸ§‘â€ğŸ¦¼", "ğŸ‘¨â€ğŸ¦¼", "ğŸš¶â€â™€ï¸", "ğŸš¶", "ğŸš¶â€â™‚ï¸",
   "ğŸ‘©â€ğŸ¦¯", "ğŸ§‘â€ğŸ¦¯", "ğŸ‘¨â€ğŸ¦¯", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸", "ğŸƒâ€â™€ï¸", "ğŸƒ", "ğŸƒâ€â™‚ï¸", "ğŸ§â€â™€ï¸", "ğŸ§", "ğŸ§â€â™‚ï¸"
 ],
 "Emoticones y personas5": [
   "ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ¥¹", "ğŸ˜…", "ğŸ˜‚", "ğŸ¤£", "ğŸ¥²", "â˜ºï¸", "ğŸ˜Š", "ğŸ˜‡", "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ",
   "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", "ğŸ§", "ğŸ¤“", "ğŸ˜", "ğŸ¥¸", "ğŸ¤©",
   "ğŸ¥³", "ğŸ™‚â€â†•ï¸", "ğŸ˜", "ğŸ˜’", "ğŸ™‚â€â†”ï¸", "ğŸ˜", "ğŸ˜”", "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£", "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ¥º",
   "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯", "ğŸ˜³", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜¶â€ğŸŒ«ï¸", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜“",
   "ğŸ¤—", "ğŸ¤”", "ğŸ«£", "ğŸ¤­", "ğŸ«¢", "ğŸ«¡", "ğŸ¤«", "ğŸ« ", "ğŸ¤¥", "ğŸ˜¶", "ğŸ«¥", "ğŸ˜", "ğŸ«¤", "ğŸ˜‘", "ğŸ«¨", "ğŸ˜¬", "ğŸ™„",
   "ğŸ˜¯", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜®", "ğŸ˜²", "ğŸ¥±", "ğŸ˜´", "ğŸ¤¤", "ğŸ˜ª", "ğŸ˜®â€ğŸ’¨", "ğŸ˜µ", "ğŸ˜µâ€ğŸ’«", "ğŸ¤", "ğŸ¥´", "ğŸ¤¢",
   "ğŸ¤®", "ğŸ¤§", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤‘", "ğŸ¤ ", "ğŸ˜ˆ", "ğŸ‘¿", "ğŸ‘¹", "ğŸ‘º", "ğŸ¤¡", "ğŸ’©", "ğŸ‘»", "ğŸ’€", "â˜ ï¸", "ğŸ‘½",
   "ğŸ‘¾", "ğŸ¤–", "ğŸƒ", "ğŸ˜º", "ğŸ˜¸", "ğŸ˜¹", "ğŸ˜»", "ğŸ˜¼", "ğŸ˜½", "ğŸ™€", "ğŸ˜¿", "ğŸ˜¾"
 ],
 "Emoticones y personas6": [
   "ğŸ«¶", "ğŸ¤²", "ğŸ‘", "ğŸ™Œ", "ğŸ‘", "ğŸ¤", "ğŸ‘", "ğŸ‘", "ğŸ‘Š", "âœŠ", "ğŸ¤›", "ğŸ¤œ", "ğŸ«·", "ğŸ«¸", "ğŸ¤", "âœŒï¸", "ğŸ«°",
   "ğŸ¤Ÿ", "ğŸ¤˜", "ğŸ‘Œ", "ğŸ¤Œ", "ğŸ¤", "ğŸ«³", "ğŸ«´", "ğŸ‘ˆ", "ğŸ‘‰", "ğŸ‘†", "ğŸ‘‡", "â˜ï¸", "âœ‹", "ğŸ¤š", "ğŸ–ï¸", "ğŸ––", "ğŸ‘‹",
   "ğŸ¤™", "ğŸ«²", "ğŸ«±", "ğŸ’ª"
 ],
 "Emoticones y personas7": [
   "ğŸ¦¾"
 ],
 "Emoticones y personas8": [
   "ğŸ–•", "âœï¸", "ğŸ™", "ğŸ«µ", "ğŸ¦¶", "ğŸ¦µ"
 ],
 "Emoticones y personas9": [
   "ğŸ¦¿"
 ],
 "Emoticones y personas10": [
   "ğŸ’„", "ğŸ’‹", "ğŸ‘„", "ğŸ«¦",
   "ğŸ¦·", "ğŸ‘…"
 ],
 "Emoticones y personas11": [
   "ğŸ‘‚", "ğŸ¦»", "ğŸ‘ƒ"
 ],
 "Emoticones y personas12": [
   "ğŸ‘£", "ğŸ‘ï¸", "ğŸ‘€", "ğŸ«€", "ğŸ«", "ğŸ§ ", "ğŸ—£ï¸", "ğŸ‘¤", "ğŸ‘¥", "ğŸ«‚",
   "ğŸª¢", "ğŸ§¶", "ğŸª¡", "ğŸ§¥", "ğŸ¥¼", "ğŸ¦º", "ğŸ‘š", "ğŸ‘•", "ğŸ‘–", "ğŸ©²", "ğŸ©³",
   "ğŸ‘”", "ğŸ‘—", "ğŸ‘™", "ğŸ©±", "ğŸ‘˜", "ğŸ¥»", "ğŸ©´", "ğŸ¥¿", "ğŸ‘ ", "ğŸ‘¡", "ğŸ‘¢", "ğŸ‘", "ğŸ‘Ÿ", "ğŸ¥¾", "ğŸ§¦", "ğŸ§¤", "ğŸ§£",
   "ğŸ©", "ğŸ§¢", "ğŸ‘’", "ğŸ“", "â›‘ï¸", "ğŸª–", "ğŸ‘‘", "ğŸ’", "ğŸ‘", "ğŸ‘›", "ğŸ‘œ", "ğŸ’¼", "ğŸ’", "ğŸ§³", "ğŸ‘“", "ğŸ•¶ï¸",
   "ğŸ¥½", "ğŸŒ‚"
 ],
 "Animales y naturaleza": [
  "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ»â€â„ï¸", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ½",
  "ğŸ¸", "ğŸµ", "ğŸ™ˆ", "ğŸ™‰", "ğŸ™Š", "ğŸ’", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ£", "ğŸ¥", "ğŸª¿", "ğŸ¦†", "ğŸ¦â€â¬›",
  "ğŸ¦…", "ğŸ¦‰", "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ«", "ğŸ", "ğŸª±", "ğŸ›", "ğŸ¦‹", "ğŸŒ", "ğŸ", "ğŸœ", "ğŸª°",
  "ğŸª²", "ğŸª³", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ•·ï¸", "ğŸ•¸ï¸", "ğŸ¦‚", "ğŸ¢", "ğŸ", "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸª¼",
  "ğŸ¦", "ğŸ¦", "ğŸ¦€", "ğŸ¡", "ğŸ ", "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ‹", "ğŸ¦ˆ", "ğŸ¦­", "ğŸŠ", "ğŸ…", "ğŸ†", "ğŸ¦“", "ğŸ¦",
  "ğŸ¦§", "ğŸ¦£", "ğŸ˜", "ğŸ¦›", "ğŸ¦", "ğŸª", "ğŸ«", "ğŸ¦’", "ğŸ¦˜", "ğŸ¦¬", "ğŸƒ", "ğŸ‚", "ğŸ„", "ğŸ«", "ğŸ", "ğŸ–",
  "ğŸ", "ğŸ‘", "ğŸ¦™", "ğŸ", "ğŸ¦Œ", "ğŸ•", "ğŸ©", "ğŸ¦®", "ğŸ•â€ğŸ¦º", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸª¶", "ğŸª½", "ğŸ“", "ğŸ¦ƒ",
  "ğŸ¦¤", "ğŸ¦š", "ğŸ¦œ", "ğŸ¦¢", "ğŸ¦©", "ğŸ•Šï¸", "ğŸ‡", "ğŸ¦", "ğŸ¦¨", "ğŸ¦¡", "ğŸ¦«", "ğŸ¦¦", "ğŸ¦¥", "ğŸ", "ğŸ€", "ğŸ¿ï¸",
  "ğŸ¦”", "ğŸ¾", "ğŸ‰", "ğŸ²", "ğŸ¦â€ğŸ”¥",
  "ğŸ„", "ğŸŒ²", "ğŸŒ³", "ğŸŒ´", "ğŸªµ", "ğŸŒ±", "ğŸŒ¿", "â˜˜ï¸", "ğŸ€", "ğŸ", "ğŸª´", "ğŸ‹", "ğŸƒ", "ğŸ‚", "ğŸ",
  "ğŸªº", "ğŸª¹", "ğŸ„", "ğŸ„â€ğŸŸ«", "ğŸš", "ğŸª¸", "ğŸª¨", "ğŸŒ¾", "ğŸ’", "ğŸŒ·", "ğŸŒ¹", "ğŸ¥€", "ğŸª»", "ğŸª·", "ğŸŒº", "ğŸŒ¸",
  "ğŸŒ¼", "ğŸŒ»", "ğŸŒ", "ğŸŒ", "ğŸŒ›", "ğŸŒœ", "ğŸŒš", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜", "ğŸŒ‘", "ğŸŒ’", "ğŸŒ“", "ğŸŒ”", "ğŸŒ™",
  "ğŸŒ", "ğŸŒ", "ğŸŒ", "ğŸª", "ğŸ’«", "â­", "ğŸŒŸ", "âœ¨", "âš¡", "â˜„ï¸", "ğŸ’¥", "ğŸ”¥", "ğŸŒªï¸", "ğŸŒˆ", "â˜€ï¸", "ğŸŒ¤ï¸",
  "â›…", "ğŸŒ¥ï¸", "â˜ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸", "â„ï¸", "â˜ƒï¸", "â›„", "ğŸŒ¬ï¸", "ğŸ’¨", "ğŸ’§", "ğŸ’¦",
  "ğŸ«§", "â˜”", "â˜‚ï¸", "ğŸŒŠ", "ğŸŒ«ï¸"
],
"Comidas y bebidas": [
  "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«", "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ",
  "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ†", "ğŸ¥‘", "ğŸ«›", "ğŸ¥¦", "ğŸ¥¬", "ğŸ¥’", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸŒ½", "ğŸ¥•", "ğŸ«’", "ğŸ§„",
  "ğŸ§…", "ğŸ¥”", "ğŸ ", "ğŸ«š", "ğŸ¥", "ğŸ¥¯", "ğŸ", "ğŸ¥–", "ğŸ¥¨", "ğŸ§€", "ğŸ¥š", "ğŸ³", "ğŸ§ˆ", "ğŸ¥",
  "ğŸ§‡", "ğŸ¥“", "ğŸ¥©", "ğŸ—", "ğŸ–", "ğŸ¦´", "ğŸŒ­", "ğŸ”", "ğŸŸ", "ğŸ•", "ğŸ«“", "ğŸ¥ª", "ğŸ¥™", "ğŸ§†", "ğŸŒ®",
  "ğŸŒ¯", "ğŸ«”", "ğŸ¥—", "ğŸ¥˜", "ğŸ«•", "ğŸ¥«", "ğŸ«™", "ğŸ", "ğŸœ", "ğŸ²", "ğŸ›", "ğŸ£", "ğŸ±", "ğŸ¥Ÿ", "ğŸ¦ª",
  "ğŸ¤", "ğŸ™", "ğŸš", "ğŸ˜", "ğŸ¥", "ğŸ¥ ", "ğŸ¥®", "ğŸ¢", "ğŸ¡", "ğŸ§", "ğŸ¨", "ğŸ¦", "ğŸ¥§", "ğŸ§", "ğŸ°",
  "ğŸ‚", "ğŸ®", "ğŸ­", "ğŸ¬", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ«˜", "ğŸ¯", "ğŸ¥›", "ğŸ«—", "ğŸ¼",
  "ğŸ«–", "â˜•", "ğŸµ", "ğŸ§ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ¶", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ·", "ğŸ¥ƒ", "ğŸ¸", "ğŸ¹", "ğŸ§‰",
  "ğŸ¾", "ğŸ§Š", "ğŸ¥„", "ğŸ´", "ğŸ½ï¸", "ğŸ¥£", "ğŸ¥¡", "ğŸ¥¢", "ğŸ§‚"
],
"Actividades": [
  "âš½", "ğŸ€", "ğŸˆ", "ğŸ", "ğŸ¥", "âš¾", "ğŸ¾", "ğŸ‰", "ğŸ¥", "ğŸ±", "ğŸª€", "ğŸ“", "ğŸ¸", "ğŸ’", "ğŸ‘", "ğŸ¥", "ğŸ", "ğŸªƒ", "ğŸ¥…", "â›³",
  "ğŸª", "ğŸ›", "ğŸ¹", "ğŸ£", "ğŸ¤¿", "ğŸ¥Š", "ğŸ¥‹", "ğŸ½", "ğŸ›¹", "ğŸ›¼", "ğŸ›·", "â›¸ï¸", "ğŸ¥Œ", "ğŸ¿",
  "ğŸ†", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ…", "ğŸ–ï¸", "ğŸµï¸", "ğŸ—ï¸", "ğŸ«", "ğŸŸï¸", "ğŸª", "ğŸ­", "ğŸ©°", "ğŸ¨", "ğŸ¬", "ğŸ¤", "ğŸ§", "ğŸ¼",
  "ğŸ¹", "ğŸª‡", "ğŸ¥", "ğŸª˜", "ğŸ·", "ğŸº", "ğŸª—", "ğŸ¸", "ğŸª•", "ğŸ»", "ğŸªˆ", "ğŸ²", "â™Ÿï¸", "ğŸ¯", "ğŸ³", "ğŸ®", "ğŸ°", "ğŸ§©", "â›·ï¸", "ğŸ‚"
],
"Actividades1": [
  "ğŸ¤¼â€â™€ï¸", "ğŸ¤¼", "ğŸ¤¼â€â™‚ï¸"
],
"Actividades2": [
  ['ğŸ‹ï¸â€â™€ï¸', 'ğŸ‹ğŸ»â€â™€ï¸', 'ğŸ‹ğŸ¼â€â™€ï¸', 'ğŸ‹ğŸ½â€â™€ï¸', 'ğŸ‹ğŸ¾â€â™€ï¸', 'ğŸ‹ğŸ¿â€â™€ï¸'],
  ['ğŸ‹ï¸', 'ğŸ‹ğŸ»', 'ğŸ‹ğŸ¼', 'ğŸ‹ğŸ½', 'ğŸ‹ğŸ¾', 'ğŸ‹ğŸ¿'],
  ['ğŸ‹ï¸â€â™‚ï¸', 'ğŸ‹ğŸ»â€â™‚ï¸', 'ğŸ‹ğŸ¼â€â™‚ï¸', 'ğŸ‹ğŸ½â€â™‚ï¸', 'ğŸ‹ğŸ¾â€â™‚ï¸', 'ğŸ‹ğŸ¿â€â™‚ï¸'],
  ['â›¹ï¸â€â™€ï¸', 'â›¹ğŸ»â€â™€ï¸', 'â›¹ğŸ¼â€â™€ï¸', 'â›¹ğŸ½â€â™€ï¸', 'â›¹ğŸ¾â€â™€ï¸', 'â›¹ğŸ¿â€â™€ï¸'],
  ['â›¹ï¸', 'â›¹ğŸ»', 'â›¹ğŸ¼', 'â›¹ğŸ½', 'â›¹ğŸ¾', 'â›¹ğŸ¿'],
  ['â›¹ï¸â€â™‚ï¸', 'â›¹ğŸ»â€â™‚ï¸', 'â›¹ğŸ¼â€â™‚ï¸', 'â›¹ğŸ½â€â™‚ï¸', 'â›¹ğŸ¾â€â™‚ï¸', 'â›¹ğŸ¿â€â™‚ï¸'],
  ['ğŸŒï¸â€â™€ï¸', 'ğŸŒğŸ»â€â™€ï¸', 'ğŸŒğŸ¼â€â™€ï¸', 'ğŸŒğŸ½â€â™€ï¸', 'ğŸŒğŸ¾â€â™€ï¸', 'ğŸŒğŸ¿â€â™€ï¸'],
  ['ğŸŒï¸', 'ğŸŒğŸ»', 'ğŸŒğŸ¼', 'ğŸŒğŸ½', 'ğŸŒğŸ¾', 'ğŸŒğŸ¿'],
  ['ğŸŒï¸â€â™‚ï¸', 'ğŸŒğŸ»â€â™‚ï¸', 'ğŸŒğŸ¼â€â™‚ï¸', 'ğŸŒğŸ½â€â™‚ï¸', 'ğŸŒğŸ¾â€â™‚ï¸', 'ğŸŒğŸ¿â€â™‚ï¸']
],
"Actividades2": [
  "ğŸ¤¸â€â™€ï¸", "ğŸ¤¸", "ğŸ¤¸â€â™‚ï¸",
  "ğŸ¤¾â€â™€ï¸", "ğŸ¤¾", "ğŸ¤¾â€â™‚ï¸",
  "ğŸ‡",
  "ğŸ§˜â€â™€ï¸", "ğŸ§˜", "ğŸ§˜â€â™‚ï¸",
  "ğŸ„â€â™€ï¸", "ğŸ„", "ğŸ„â€â™‚ï¸",
  "ğŸŠâ€â™€ï¸", "ğŸŠ", "ğŸŠâ€â™‚ï¸",
  "ğŸ¤½â€â™€ï¸", "ğŸ¤½", "ğŸ¤½â€â™‚ï¸",
  "ğŸš£â€â™€ï¸", "ğŸš£", "ğŸš£â€â™‚ï¸",
  "ğŸ§—â€â™€ï¸", "ğŸ§—", "ğŸ§—â€â™‚ï¸",
  "ğŸšµâ€â™€ï¸", "ğŸšµ", "ğŸšµâ€â™‚ï¸",
  "ğŸš´â€â™€ï¸", "ğŸš´", "ğŸš´â€â™‚ï¸",
  "ğŸ¤¹â€â™€ï¸", "ğŸ¤¹", "ğŸ¤¹â€â™‚ï¸"
],
 "Viajes y lugares": [
   "ğŸï¸", "ğŸ›¸", "ğŸš€", "ğŸš", "ğŸï¸",
   "ğŸš—", "ğŸš•", "ğŸš™", "ğŸšŒ", "ğŸš", "ğŸš“", "ğŸš‘", "ğŸš’", "ğŸš", "ğŸ›»", "ğŸšš", "ğŸš›", "ğŸšœ", "ğŸ¦¯", "ğŸ¦½", "ğŸ¦¼", "ğŸ©¼", "ğŸ›´", "ğŸš²", "ğŸ›µ", "ğŸ›º", "ğŸ›", "ğŸš¨", "ğŸš”", "ğŸš", "ğŸš˜", "ğŸš–", "ğŸš¡", "ğŸš ", "ğŸšŸ", "ğŸšƒ", "ğŸš‹", "ğŸš", "ğŸš", "ğŸš„", "ğŸš…", "ğŸšˆ", "ğŸš‚", "ğŸš†", "ğŸš‡", "ğŸšŠ", "ğŸš‰", "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸ›©ï¸", "ğŸ’º", "ğŸ›°ï¸", "ğŸ›¶", "â›µ", "ğŸš¤", "ğŸ›¥ï¸", "ğŸ›³ï¸", "â›´ï¸", "ğŸš¢", "ğŸ›Ÿ", "âš“", "ğŸª", "â›½", "ğŸš§", "ğŸš¦", "ğŸš¥", "ğŸš", "ğŸ—ºï¸", "ğŸ—¿", "ğŸ—½", "ğŸ—¼", "ğŸ°", "ğŸ¯", "ğŸŸï¸", "ğŸ¡", "ğŸ¢", "ğŸ ", "â›²", "â›±ï¸", "ğŸ–ï¸", "ğŸï¸", "ğŸœï¸", "ğŸŒ‹", "â›°ï¸", "ğŸ”ï¸", "ğŸ—»", "ğŸ•ï¸", "â›º", "ğŸ›–", "ğŸ ", "ğŸ¡", "ğŸ˜ï¸", "ğŸšï¸", "ğŸ—ï¸", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸª", "ğŸ«", "ğŸ©", "ğŸ’’", "ğŸ›ï¸", "â›ª", "ğŸ•Œ", "ğŸ•", "ğŸ›•", "ğŸ•‹", "â›©ï¸", "ğŸ›¤ï¸", "ğŸ›£ï¸", "ğŸ—¾", "ğŸ‘", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ ", "ğŸ‡", "ğŸ†", "ğŸŒ‡", "ğŸŒ†", "ğŸ™ï¸", "ğŸŒƒ", "ğŸŒŒ", "ğŸŒ‰", "ğŸŒ"
 ],
"Objetos": [
  "ğŸ’Š", "ğŸ’‰", "ğŸ©¸", "ğŸ§¬", "ğŸ¦ ",
  "ğŸ”­", "ğŸ”¬", "ğŸ•³ï¸", "ğŸ©»", "ğŸ©¹", "ğŸ©º", "ğŸ§«", "ğŸ§ª", "ğŸŒ¡ï¸",
  "âŒš", "ğŸ“±", "ğŸ“²", "ğŸ’»", "âŒ¨ï¸", "ğŸ–¥ï¸", "ğŸ–¨ï¸", "ğŸ–±ï¸", "ğŸ–²ï¸", "ğŸ•¹ï¸", "ğŸ—œï¸", "ğŸ’½", "ğŸ’¾", "ğŸ’¿", "ğŸ“€", "ğŸ“¼", "ğŸ“·", "ğŸ“¸", "ğŸ“¹", "ğŸ¥", "ğŸ“½ï¸", "ğŸï¸", "ğŸ“", "â˜ï¸", "ğŸ“Ÿ", "ğŸ“ ", "ğŸ“º", "ğŸ“»", "ğŸ™ï¸", "ğŸšï¸", "ğŸ›ï¸", "ğŸ§­", "â±ï¸", "â²ï¸", "â°", "ğŸ•°ï¸", "âŒ›", "â³", "ğŸ“¡", "ğŸ”‹", "ğŸª«", "ğŸ”Œ", "ğŸ’¡", "ğŸ”¦", "ğŸ•¯ï¸", "ğŸª”", "ğŸ§¯", "ğŸ›¢ï¸", "ğŸ’¸", "ğŸ’µ", "ğŸ’´", "ğŸ’¶", "ğŸ’·", "ğŸª™", "ğŸ’°", "ğŸ’³", "ğŸªª", "ğŸ’", "âš–ï¸", "ğŸªœ", "ğŸ§°", "ğŸª›", "ğŸ”§", "ğŸ”¨", "âš’ï¸", "ğŸ› ï¸", "â›ï¸", "ğŸªš", "ğŸ”©", "âš™ï¸", "ğŸª¤", "ğŸ§±", "â›“ï¸", "â›“ï¸â€ğŸ’¥", "ğŸ§²", "ğŸ”«", "ğŸ’£", "ğŸ§¨", "ğŸª“", "ğŸ”ª", "ğŸ—¡ï¸", "âš”ï¸", "ğŸ›¡ï¸", "ğŸš¬", "âš°ï¸", "ğŸª¦", "âš±ï¸", "ğŸº", "ğŸ”®", "ğŸ“¿", "ğŸ§¿", "ğŸª¬", "ğŸ’ˆ", "âš—ï¸", "ğŸ§¹", "ğŸª ", "ğŸ§º", "ğŸ§»", "ğŸš½", "ğŸš°", "ğŸš¿", "ğŸ›"
],
"Objetos1": [
  "ğŸ›€"
],
"Objetos2": [
  "ğŸ§¼", "ğŸª¥", "ğŸª’", "ğŸª®", "ğŸ§½", "ğŸª£", "ğŸ§´", "ğŸ›ï¸", "ğŸ”‘", "ğŸ—ï¸", "ğŸšª", "ğŸª‘", "ğŸ›‹ï¸", "ğŸ›ï¸"
],
"Objetos3": [
  "ğŸ›Œ"
],
"Objetos4": [
  "ğŸ§¸", "ğŸª†", "ğŸ–¼ï¸", "ğŸª", "ğŸªŸ", "ğŸ›ï¸", "ğŸ›’", "ğŸ", "ğŸˆ", "ğŸ", "ğŸ€", "ğŸª„", "ğŸª…", "ğŸŠ", "ğŸ‰", "ğŸ", "ğŸª­", "ğŸ®", "ğŸ", "ğŸª©", "ğŸ§§", "âœ‰ï¸", "ğŸ“©", "ğŸ“¨", "ğŸ“§", "ğŸ’Œ", "ğŸ“¥", "ğŸ“¤", "ğŸ“¦", "ğŸ·ï¸", "ğŸª§", "ğŸ“ª", "ğŸ“«", "ğŸ“¬", "ğŸ“­", "ğŸ“®", "ğŸ“¯", "ğŸ“œ", "ğŸ“ƒ", "ğŸ“„", "ğŸ“‘", "ğŸ§¾", "ğŸ“Š", "ğŸ“ˆ", "ğŸ“‰", "ğŸ—’ï¸", "ğŸ—“ï¸", "ğŸ“†", "ğŸ“…", "ğŸ—‘ï¸", "ğŸ“‡", "ğŸ—ƒï¸", "ğŸ—³ï¸", "ğŸ—„ï¸", "ğŸ“‹", "ğŸ“", "ğŸ“‚", "ğŸ—‚ï¸", "ğŸ—ï¸", "ğŸ“°", "ğŸ““", "ğŸ“”", "ğŸ“’", "ğŸ“•", "ğŸ“—", "ğŸ“˜", "ğŸ“™", "ğŸ“š", "ğŸ“–", "ğŸ”–", "ğŸ§·", "ğŸ”—", "ğŸ“", "ğŸ–‡ï¸", "ğŸ“", "ğŸ“", "ğŸ§®", "ğŸ“Œ", "ğŸ“", "âœ‚ï¸", "ğŸ–Šï¸", "ğŸ–‹ï¸", "âœ’ï¸", "ğŸ–Œï¸", "ğŸ–ï¸", "ğŸ“", "âœï¸", "ğŸ”", "ğŸ”", "ğŸ”", "ğŸ”", "ğŸ”’", "ğŸ”“"
],
"SÃ­mbolos": [
  "ğŸ©·", "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ©µ", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "ğŸ©¶", "ğŸ¤", "ğŸ¤", "ğŸ’”", "â¤ï¸â€ğŸ”¥", "â¤ï¸â€ğŸ©¹", "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—", "ğŸ’–", "ğŸ’˜", "ğŸ’", "ğŸ’Ÿ", "â˜®ï¸", "âœï¸", "â˜ªï¸", "ğŸ•‰ï¸", "â˜¸ï¸", "ğŸª¯", "âœ¡ï¸", "ğŸ”¯", "ğŸ•", "â˜¯ï¸", "â˜¦ï¸", "ğŸ›", "â›", "â™ˆ", "â™‰", "â™Š", "â™‹", "â™Œ", "â™", "â™", "â™", "â™", "â™‘", "â™’", "â™“", "ğŸ†”", "âš›ï¸", "ğŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ğŸ“´", "ğŸ“³", "ğŸˆ¶", "ğŸˆš", "ğŸˆ¸", "ğŸˆº", "ğŸˆ·ï¸", "âœ´ï¸", "ğŸ†š", "ğŸ’®", "ğŸ‰", "ãŠ™ï¸", "ãŠ—ï¸", "ğŸˆ´", "ğŸˆµ", "ğŸˆ¹", "ğŸˆ²", "ğŸ…°ï¸", "ğŸ…±ï¸", "ğŸ†", "ğŸ†‘", "ğŸ…¾ï¸", "ğŸ†˜", "âŒ", "â­•", "ğŸ›‘", "â›”", "ğŸ“›", "ğŸš«", "ğŸ’¯", "ğŸ’¢", "â™¨ï¸", "ğŸš·", "ğŸš¯", "ğŸš³", "ğŸš±", "ğŸ”", "ğŸ“µ", "ğŸš­", "â—", "â•", "â“", "â”", "â€¼ï¸", "â‰ï¸", "ğŸ”…", "ğŸ”†", "ã€½ï¸", "âš ï¸", "ğŸš¸", "ğŸ”±", "âšœï¸", "ğŸ”°", "â™»ï¸", "âœ…", "ğŸˆ¯", "ğŸ’¹", "â‡ï¸", "âœ³ï¸", "â", "ğŸŒ", "ğŸ’ ", "â“‚ï¸", "ğŸŒ€", "ğŸ’¤", "ğŸ§", "ğŸš¾", "â™¿", "ğŸ…¿ï¸", "ğŸ›—", "ğŸˆ³", "ğŸˆ‚ï¸", "ğŸ›‚", "ğŸ›ƒ", "ğŸ›„", "ğŸ›…", "ğŸ›œ", "ğŸš¹", "ğŸšº", "ğŸš¼", "ğŸ§‘â€ğŸ§‘â€ğŸ§’", "ğŸ§‘â€ğŸ§‘â€ğŸ§’â€ğŸ§’", "ğŸ§‘â€ğŸ§’", "ğŸ§‘â€ğŸ§’â€ğŸ§’", "âš§ï¸", "ğŸš»", "ğŸš®", "ğŸ¦", "ğŸ“¶", "ğŸˆ", "ğŸ”£", "â„¹ï¸", "ğŸ”¤", "ğŸ”¡", "ğŸ” ", "ğŸ†–", "ğŸ†—", "ğŸ†™", "ğŸ†’", "ğŸ†•", "ğŸ†“", "0ï¸âƒ£", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ", "ğŸ”¢", "#ï¸âƒ£", "*ï¸âƒ£", "âï¸", "â–¶ï¸", "â¸ï¸", "â¯ï¸", "â¹ï¸", "âºï¸", "â­ï¸", "â®ï¸", "â©", "âª", "â«", "â¬", "â—€ï¸", "ğŸ”¼", "ğŸ”½", "â¡ï¸", "â¬…ï¸", "â¬†ï¸", "â¬‡ï¸", "â†—ï¸", "â†˜ï¸", "â†™ï¸", "â†–ï¸", "â†•ï¸", "â†”ï¸", "â†ªï¸", "â†©ï¸", "â¤´ï¸", "â¤µï¸", "ğŸ”€", "ğŸ”", "ğŸ”‚", "ğŸ”„", "ğŸ”ƒ", "ğŸµ", "ğŸ¶", "â•", "â–", "â—", "âœ–ï¸", "ğŸŸ°", "â™¾ï¸", "ğŸ’²", "ğŸ’±", "â„¢ï¸", "Â©ï¸", "Â®ï¸", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ”š", "ğŸ”™", "ğŸ”›", "ğŸ”", "ğŸ”œ", "ã€°ï¸", "â°", "â¿", "âœ”ï¸", "â˜‘ï¸", "ğŸ”˜", "ğŸ”´", "ğŸŸ ", "ğŸŸ¡", "ğŸŸ¢", "ğŸ”µ", "ğŸŸ£", "âš«", "âšª", "ğŸŸ¤", "ğŸ”º", "ğŸ”»", "ğŸ”¸", "ğŸ”¹", "ğŸ”¶", "ğŸ”·", "ğŸ”³", "ğŸ”²", "â–ªï¸", "â–«ï¸", "â—¾", "â—½", "â—¼ï¸", "â—»ï¸", "ğŸŸ¥", "ğŸŸ§", "ğŸŸ¨", "ğŸŸ©", "ğŸŸ¦", "ğŸŸª", "â¬›", "â¬œ", "ğŸŸ«", "ğŸ”ˆ", "ğŸ”‡", "ğŸ”‰", "ğŸ”Š", "ğŸ””", "ğŸ”•", "ğŸ“£", "ğŸ“¢", "ğŸ’¬", "ğŸ’­", "ğŸ—¯ï¸", "â™ ï¸", "â™£ï¸", "â™¥ï¸", "â™¦ï¸", "ğŸƒ", "ğŸ´", "ğŸ€„", "ğŸ•", "ğŸ•‘", "ğŸ•’", "ğŸ•“", "ğŸ•”", "ğŸ••", "ğŸ•–", "ğŸ•—", "ğŸ•˜", "ğŸ•™", "ğŸ•š", "ğŸ•›", "ğŸ•œ", "ğŸ•", "ğŸ•", "ğŸ•Ÿ", "ğŸ• ", "ğŸ•¡", "ğŸ•¢", "ğŸ•£", "ğŸ•¤", "ğŸ•¥", "ğŸ•¦", "ğŸ•§"
],
 "Banderas": [
   "ğŸ³ï¸â€ğŸŒˆ", "ğŸ³ï¸â€âš§ï¸",
   "ğŸ‡ºğŸ‡³", "ğŸ‡¦ğŸ‡«", "ğŸ‡¦ğŸ‡½", "ğŸ‡¦ğŸ‡±", "ğŸ‡©ğŸ‡¿", "ğŸ‡¦ğŸ‡¸", "ğŸ‡¦ğŸ‡©", "ğŸ‡¦ğŸ‡´", "ğŸ‡¦ğŸ‡®",
   "ğŸ‡¦ğŸ‡¶", "ğŸ‡¦ğŸ‡¬", "ğŸ‡¦ğŸ‡·", "ğŸ‡¦ğŸ‡²", "ğŸ‡¦ğŸ‡¼", "ğŸ‡¦ğŸ‡º", "ğŸ‡¦ğŸ‡¹", "ğŸ‡¦ğŸ‡¿", "ğŸ‡§ğŸ‡¸",
   "ğŸ‡§ğŸ‡­", "ğŸ‡§ğŸ‡©", "ğŸ‡§ğŸ‡§", "ğŸ‡§ğŸ‡¾", "ğŸ‡§ğŸ‡ª", "ğŸ‡§ğŸ‡¿", "ğŸ‡§ğŸ‡¯", "ğŸ‡§ğŸ‡²", "ğŸ‡§ğŸ‡¹",
   "ğŸ‡§ğŸ‡´", "ğŸ‡§ğŸ‡¦", "ğŸ‡§ğŸ‡¼", "ğŸ‡§ğŸ‡·", "ğŸ‡»ğŸ‡¬", "ğŸ‡§ğŸ‡³", "ğŸ‡§ğŸ‡¬", "ğŸ‡§ğŸ‡«", "ğŸ‡§ğŸ‡®",
   "ğŸ‡°ğŸ‡­", "ğŸ‡¨ğŸ‡²", "ğŸ‡¨ğŸ‡¦", "ğŸ‡®ğŸ‡¨", "ğŸ‡¨ğŸ‡»", "ğŸ‡§ğŸ‡¶", "ğŸ‡°ğŸ‡¾", "ğŸ‡¨ğŸ‡«", "ğŸ‡¹ğŸ‡©",
   "ğŸ‡®ğŸ‡´", "ğŸ‡¨ğŸ‡±", "ğŸ‡¨ğŸ‡³", "ğŸ‡¨ğŸ‡½", "ğŸ‡¨ğŸ‡¨", "ğŸ‡¨ğŸ‡´", "ğŸ‡°ğŸ‡²", "ğŸ‡¨ğŸ‡¬", "ğŸ‡¨ğŸ‡©",
   "ğŸ‡¨ğŸ‡°", "ğŸ‡¨ğŸ‡·", "ğŸ‡¨ğŸ‡®", "ğŸ‡­ğŸ‡·", "ğŸ‡¨ğŸ‡º", "ğŸ‡¨ğŸ‡¼", "ğŸ‡¨ğŸ‡¾", "ğŸ‡¨ğŸ‡¿", "ğŸ‡©ğŸ‡°",
   "ğŸ‡©ğŸ‡¯", "ğŸ‡©ğŸ‡²", "ğŸ‡©ğŸ‡´", "ğŸ‡ªğŸ‡¨", "ğŸ‡ªğŸ‡¬", "ğŸ‡¸ğŸ‡»", "ğŸ‡¬ğŸ‡¶", "ğŸ‡ªğŸ‡·", "ğŸ‡ªğŸ‡ª",
   "ğŸ‡¸ğŸ‡¿", "ğŸ‡ªğŸ‡¹", "ğŸ‡ªğŸ‡º", "ğŸ‡«ğŸ‡°", "ğŸ‡«ğŸ‡´", "ğŸ‡«ğŸ‡¯", "ğŸ‡«ğŸ‡®", "ğŸ‡«ğŸ‡·", "ğŸ‡¬ğŸ‡«",
   "ğŸ‡µğŸ‡«", "ğŸ‡¹ğŸ‡«", "ğŸ‡¬ğŸ‡¦", "ğŸ‡¬ğŸ‡²", "ğŸ‡¬ğŸ‡ª", "ğŸ‡©ğŸ‡ª", "ğŸ‡¬ğŸ‡­", "ğŸ‡¬ğŸ‡®", "ğŸ‡¬ğŸ‡·",
   "ğŸ‡¬ğŸ‡±", "ğŸ‡¬ğŸ‡©", "ğŸ‡¬ğŸ‡µ", "ğŸ‡¬ğŸ‡º", "ğŸ‡¬ğŸ‡¹", "ğŸ‡¬ğŸ‡¬", "ğŸ‡¬ğŸ‡³", "ğŸ‡¬ğŸ‡¼", "ğŸ‡¬ğŸ‡¾",
   "ğŸ‡­ğŸ‡¹", "ğŸ‡­ğŸ‡³", "ğŸ‡­ğŸ‡°", "ğŸ‡­ğŸ‡º", "ğŸ‡®ğŸ‡¸", "ğŸ‡®ğŸ‡³", "ğŸ‡®ğŸ‡©", "ğŸ‡®ğŸ‡·", "ğŸ‡®ğŸ‡¶",
   "ğŸ‡®ğŸ‡ª", "ğŸ‡®ğŸ‡²", "ğŸ‡®ğŸ‡±", "ğŸ‡®ğŸ‡¹", "ğŸ‡¯ğŸ‡²", "ğŸ‡¯ğŸ‡µ", "ğŸŒ", "ğŸ‡¯ğŸ‡ª", "ğŸ‡¯ğŸ‡´",
   "ğŸ‡°ğŸ‡¿", "ğŸ‡°ğŸ‡ª", "ğŸ‡°ğŸ‡®", "ğŸ‡½ğŸ‡°", "ğŸ‡°ğŸ‡°", "ğŸ‡°ğŸ‡¼", "ğŸ‡°ğŸ‡¬", "ğŸ‡±ğŸ‡¦", "ğŸ‡±ğŸ‡»",
   "ğŸ‡±ğŸ‡§", "ğŸ‡±ğŸ‡¸", "ğŸ‡±ğŸ‡·", "ğŸ‡±ğŸ‡¾", "ğŸ‡±ğŸ‡®", "ğŸ‡±ğŸ‡¹", "ğŸ‡±ğŸ‡º", "ğŸ‡²ğŸ‡´", "ğŸ‡²ğŸ‡¬",
   "ğŸ‡²ğŸ‡¼", "ğŸ‡²ğŸ‡¾", "ğŸ‡²ğŸ‡»", "ğŸ‡²ğŸ‡±", "ğŸ‡²ğŸ‡¹", "ğŸ‡²ğŸ‡­", "ğŸ‡²ğŸ‡¶", "ğŸ‡²ğŸ‡·", "ğŸ‡²ğŸ‡º",
   "ğŸ‡¾ğŸ‡¹", "ğŸ‡²ğŸ‡½", "ğŸ‡«ğŸ‡²", "ğŸ‡²ğŸ‡©", "ğŸ‡²ğŸ‡¨", "ğŸ‡²ğŸ‡³", "ğŸ‡²ğŸ‡ª", "ğŸ‡²ğŸ‡¸", "ğŸ‡²ğŸ‡¦",
   "ğŸ‡²ğŸ‡¿", "ğŸ‡²ğŸ‡²", "ğŸ‡³ğŸ‡¦", "ğŸ‡³ğŸ‡·", "ğŸ‡³ğŸ‡µ", "ğŸ‡³ğŸ‡±", "ğŸ‡³ğŸ‡¨", "ğŸ‡³ğŸ‡¿", "ğŸ‡³ğŸ‡®",
   "ğŸ‡³ğŸ‡ª", "ğŸ‡³ğŸ‡¬", "ğŸ‡³ğŸ‡º", "ğŸ‡³ğŸ‡«", "ğŸ‡°ğŸ‡µ", "ğŸ‡²ğŸ‡°", "ğŸ‡²ğŸ‡µ", "ğŸ‡³ğŸ‡´", "ğŸ‡´ğŸ‡²",
   "ğŸ‡µğŸ‡°", "ğŸ‡µğŸ‡¼", "ğŸ‡µğŸ‡¸", "ğŸ‡µğŸ‡¦", "ğŸ‡µğŸ‡¬", "ğŸ‡µğŸ‡¾", "ğŸ‡µğŸ‡ª", "ğŸ‡µğŸ‡­", "ğŸ‡µğŸ‡³",
   "ğŸ‡µğŸ‡±", "ğŸ‡µğŸ‡¹", "ğŸ‡µğŸ‡·", "ğŸ‡¶ğŸ‡¦", "ğŸ‡·ğŸ‡ª", "ğŸ‡·ğŸ‡´", "ğŸ‡·ğŸ‡º", "ğŸ‡·ğŸ‡¼", "ğŸ‡¼ğŸ‡¸",
   "ğŸ‡¸ğŸ‡²", "ğŸ‡¸ğŸ‡¹", "ğŸ‡¸ğŸ‡¦", "ğŸ‡¸ğŸ‡³", "ğŸ‡·ğŸ‡¸", "ğŸ‡¸ğŸ‡¨", "ğŸ‡¸ğŸ‡±", "ğŸ‡¸ğŸ‡¬", "ğŸ‡¸ğŸ‡½",
   "ğŸ‡¸ğŸ‡°", "ğŸ‡¸ğŸ‡®", "ğŸ‡¬ğŸ‡¸", "ğŸ‡¸ğŸ‡§", "ğŸ‡¸ğŸ‡´", "ğŸ‡¿ğŸ‡¦", "ğŸ‡°ğŸ‡·", "ğŸ‡¸ğŸ‡¸", "ğŸ‡¸ğŸ‡ª",
   "ğŸ‡¸ğŸ‡±", "ğŸ‡°ğŸ‡§", "ğŸ‡¸ğŸ‡­", "ğŸ‡°ğŸ‡³", "ğŸ‡±ğŸ‡¨", "ğŸ‡µğŸ‡²", "ğŸ‡»ğŸ‡¨", "ğŸ‡¸ğŸ‡©", "ğŸ‡¸ğŸ‡·",
   "ğŸ‡¸ğŸ‡ª", "ğŸ‡¨ğŸ‡­", "ğŸ‡¸ğŸ‡¾", "ğŸ‡¹ğŸ‡¼", "ğŸ‡¹ğŸ‡¯", "ğŸ‡¹ğŸ‡¿", "ğŸ‡¹ğŸ‡­", "ğŸ‡¹ğŸ‡±", "ğŸ‡¹ğŸ‡¬",
   "ğŸ‡¹ğŸ‡°", "ğŸ‡¹ğŸ‡´", "ğŸ‡¹ğŸ‡¹", "ğŸ‡¹ğŸ‡³", "ğŸ‡¹ğŸ‡·", "ğŸ‡¹ğŸ‡²", "ğŸ‡¹ğŸ‡¨", "ğŸ‡¹ğŸ‡»", "ğŸ‡»ğŸ‡®",
   "ğŸ‡ºğŸ‡¬", "ğŸ‡ºğŸ‡¦", "ğŸ‡¦ğŸ‡ª", "ğŸ‡¬ğŸ‡§", "ğŸ‡ºğŸ‡¸", "ğŸ‡ºğŸ‡¾", "ğŸ‡ºğŸ‡¿", "ğŸ‡»ğŸ‡º",
   "ğŸ‡»ğŸ‡¦", "ğŸ‡»ğŸ‡ª", "ğŸ‡»ğŸ‡³", "ğŸ‡¼ğŸ‡«", "ğŸ‡ªğŸ‡­", "ğŸ‡¾ğŸ‡ª", "ğŸ‡¿ğŸ‡²", "ğŸ‡¿ğŸ‡¼", "ğŸ", "ğŸ´", "ğŸ³ï¸", "ğŸš©", "ğŸ´â€â˜ ï¸"
 ]
 };

const tonosPiel = ["ğŸ»", "ğŸ¼", "ğŸ½", "ğŸ¾", "ğŸ¿"];
const SKIN_REGEX = /[\u{1F3FB}-\u{1F3FF}]/gu;
const ZWJ = "\u200D";

const personaBases = new Set(
  [
    // combinamos todas las subcategorÃ­as de Personas
    ...(categoriasEmojis["Emoticones y personas"] || []),
    ...(categoriasEmojis["Emoticones y personas1"] || []),
    ...(categoriasEmojis["Emoticones y personas2"] || []),
    ...(categoriasEmojis["Emoticones y personas4"] || []),
    ...(categoriasEmojis["Emoticones y personas6"] || []),
    ...(categoriasEmojis["Emoticones y personas8"] || []),
    ...(categoriasEmojis["Emoticones y personas11"] || []),
    ...(categoriasEmojis["Actividades1"] || []),
    ...(categoriasEmojis["Actividades2"] || []),
    ...(categoriasEmojis["Actividades3"] || []),
    ...(categoriasEmojis["Objetos1"] || []),
    ...(categoriasEmojis["Objetos3"] || [])// incluimos especiales por si hay arrays
  ].map(item => {
    // item puede ser string o array -> tomamos el primer string y su primer punto de code unit
    const base = Array.isArray(item) ? item[0] : item;
    return Array.from(base)[0];
  })
);

function stripSkinTones(s) {
  return (s || "").replace(SKIN_REGEX, "");
}

function soportaTonos(emoji) {
  if (!emoji) return false;
  const clean = stripSkinTones(emoji);
  if (clean.includes(ZWJ)) {
    const partes = clean.split(ZWJ);
    return partes.some(p => personaBases.has(Array.from(p)[0]));
  } else {
    return personaBases.has(Array.from(clean)[0]);
  }
}

function applyToneToPart(part, tone) {
  if (!part) return part;
  let p = stripSkinTones(part);
  const chars = Array.from(p);
  const first = chars[0];
  if (!first) return p;
  if (personaBases.has(first)) {
    return first + tone + chars.slice(1).join("");
  }
  return p;
}

function aplicarTono(emoji, tone) {
  if (!emoji) return emoji;
  const clean = stripSkinTones(emoji);
  if (clean.includes(ZWJ)) {
    return clean.split(ZWJ).map(p => applyToneToPart(p, tone)).join(ZWJ);
  } else {
    return applyToneToPart(clean, tone);
  }
}

function crearTonePicker() {
  if (tonePickerEl) return;
  tonePickerEl = document.createElement("div");
  tonePickerEl.className = "tone-picker";
  tonePickerEl.style.position = "fixed";
  tonePickerEl.style.display = "none";
  tonePickerEl.style.background = "#f9f9f9";
  tonePickerEl.style.border = "1px solid #ccc";
  tonePickerEl.style.borderRadius = "10px";
  tonePickerEl.style.padding = "6px";
  tonePickerEl.style.zIndex = 2000;
  tonePickerEl.style.display = "flex";
  tonePickerEl.style.gap = "6px";
  tonePickerEl.style.alignItems = "center";
  tonePickerEl.setAttribute("role","dialog");
  tonePickerEl.setAttribute("aria-hidden","true");
  document.body.appendChild(tonePickerEl);

  tonePickerEl.addEventListener("pointerdown", e => e.stopPropagation());
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") cerrarTonePicker();
  });
}

function mostrarTonePicker(baseEmoji, targetEl) {
  crearTonePicker();
  tonePickerEl.innerHTML = "";
  const baseClean = stripSkinTones(baseEmoji);
  
  // ğŸ‘‰ incluye la variante base primero
  const variantes = [baseClean, ...tonosPiel.map(t => aplicarTono(baseClean, t))];
  
  variantes.forEach(v => {
    const span = document.createElement("button");
    span.type = "button";
    span.className = "tone-btn";
    span.style.fontSize = "2rem";
    span.style.padding = "1px";
    span.style.border = "none";
    span.style.background = "transparent";
    span.textContent = v;
    
    span.addEventListener("click", (ev) => {
      ev.stopPropagation();
      avatarSeleccionado = v;
      
      // ğŸ”¹ Actualiza preview
      const preview = document.getElementById("avatar-preview");
      if (preview) preview.textContent = avatarSeleccionado;
      
      // ğŸ”¹ Actualiza todos los emojis visibles en las filas
      document.querySelectorAll(".fila-emoji span").forEach(s => {
        const base = stripSkinTones(s.textContent);
        if (base === baseClean) {
          s.textContent = avatarSeleccionado;
          
          // âœ… Mantiene el triÃ¡ngulo si el emoji admite tonos
          if (soportaTonos(baseClean)) {
            const tri = document.createElement("span");
            tri.style.position = "relative";
            tri.style.width = "0";
            tri.style.height = "0";
            tri.style.borderLeft = "5px solid transparent";
            tri.style.borderRight = "5px solid transparent";
            tri.style.borderTop = "5px solid rgba(0,0,0,0.1)";
            tri.style.bottom = "2px";
            tri.style.left = "29px";
            tri.style.transform = "rotate(-45deg)";
            s.appendChild(tri);
          }
        }
      });
      
      cerrarTonePicker();
    });
    
    tonePickerEl.appendChild(span);
  });
  
  posicionarTonePicker(targetEl);
}


function mostrarTonePickerEspecial(group, targetEl) {
  crearTonePicker();
  tonePickerEl.innerHTML = "";
  
  group.forEach(e => {
    const btn = document.createElement("button");
    btn.textContent = e;
    btn.style.fontSize = "2rem";
    btn.style.padding = "1px";
    btn.style.border = "none";
    btn.style.background = "transparent";
    
    btn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      avatarSeleccionado = e;
      
      // ğŸ”¹ Actualiza preview
      const preview = document.getElementById("avatar-preview");
      if (preview) preview.textContent = avatarSeleccionado;
      
      // ğŸ”¹ Actualiza todos los emojis en filas con la misma base
      const baseClean = stripSkinTones(e);
      document.querySelectorAll(".fila-emoji span").forEach(s => {
        const base = stripSkinTones(s.textContent);
        if (base === baseClean) {
          s.textContent = avatarSeleccionado;
          
          // âœ… Mantiene el triÃ¡ngulo si el emoji admite tonos
          if (soportaTonos(baseClean)) {
            const tri = document.createElement("span");
            tri.style.position = "relative";
            tri.style.width = "0";
            tri.style.height = "0";
            tri.style.borderLeft = "5px solid transparent";
            tri.style.borderRight = "5px solid transparent";
            tri.style.borderTop = "5px solid rgba(0,0,0,0.1)";
            tri.style.bottom = "2px";
            tri.style.left = "29px";
            tri.style.transform = "rotate(-45deg)";
            s.appendChild(tri);
          }
        }
      });
      
      cerrarTonePicker();
    });
    
    tonePickerEl.appendChild(btn);
  });
  
  posicionarTonePicker(targetEl);
}

function posicionarTonePicker(targetEl) {
  tonePickerEl.style.display = "flex";
  tonePickerEl.setAttribute("aria-hidden","false");
  tonePickerEl.style.left = "0px"; tonePickerEl.style.top = "0px";

  requestAnimationFrame(() => {
    const rect = targetEl.getBoundingClientRect();
    const pickerRect = tonePickerEl.getBoundingClientRect();
    let left = rect.left + (rect.width - pickerRect.width) / 2;
    let top = rect.top - pickerRect.height - 8;
    if (top < 8) top = rect.bottom + 8;
    if (left < 8) left = 8;
    if (left + pickerRect.width > window.innerWidth - 8) left = window.innerWidth - pickerRect.width - 8;
    tonePickerEl.style.left = `${Math.round(left)}px`;
    tonePickerEl.style.top = `${Math.round(top)}px`;
  });

  if (outsideHandler) {
    document.removeEventListener("pointerdown", outsideHandler, true);
    window.removeEventListener("scroll", cerrarTonePicker, true);
    window.removeEventListener("wheel", cerrarTonePicker, true);
    window.removeEventListener("touchmove", cerrarTonePicker, true);
  }

  tonePickerOpenTarget = targetEl;
  outsideHandler = function (ev) {
    const path = ev.composedPath ? ev.composedPath() : (() => { 
      let p=[]; let node=ev.target; 
      while(node){p.push(node); node=node.parentNode;} 
      return p; 
    })();
    if (path.includes(tonePickerEl) || path.includes(tonePickerOpenTarget)) return;
    cerrarTonePicker();
  };

  setTimeout(() => { 
    document.addEventListener("pointerdown", outsideHandler, true);
    window.addEventListener("scroll", cerrarTonePicker, true);
    window.addEventListener("wheel", cerrarTonePicker, true);
    window.addEventListener("touchmove", cerrarTonePicker, true);
  }, 0);
}

function cerrarTonePicker() {
  if (!tonePickerEl) return;
  tonePickerEl.style.display = "none";
  tonePickerEl.setAttribute("aria-hidden","true");
  tonePickerOpenTarget = null;

  if (outsideHandler) {
    document.removeEventListener("pointerdown", outsideHandler, true);
    window.removeEventListener("scroll", cerrarTonePicker, true);
    window.removeEventListener("wheel", cerrarTonePicker, true);
    window.removeEventListener("touchmove", cerrarTonePicker, true);
    outsideHandler = null;
  }
}

function renderizarEmojis() {
  const lista = document.getElementById("lista-emojis");
  lista.innerHTML = "";
  
  const ordenCategorias = [
    "Emoticones y personas",
    "Animales y naturaleza",
    "Comidas y bebidas",
    "Actividades",
    "Viajes y lugares",
    "Objetos",
    "SÃ­mbolos",
    "Banderas"
  ];
  
  ordenCategorias.forEach(categoria => {
    const dataSource = [];
    
    // Agregamos todas las subcategorÃ­as automÃ¡ticamente
    Object.keys(categoriasEmojis).forEach(key => {
      if (key.startsWith(categoria)) {
        dataSource.push(...categoriasEmojis[key]);
      }
    });
    
    if (!dataSource.length) return;
    
    // TÃ­tulo de categorÃ­a
    const titulo = document.createElement("p");
    titulo.textContent = categoria;
    titulo.style.fontWeight = "bold";
    titulo.style.margin = "0rem";
    titulo.style.padding = "0";
    titulo.style.fontSize = "1rem";
    lista.appendChild(titulo);
    
    // Fila de emojis
    const fila = document.createElement("div");
    fila.className = "fila-emoji";
    fila.style.height = "65px";
    fila.style.display = "flex";
    fila.style.marginBottom = "1rem";
    fila.style.padding = "0";
    fila.style.alignItems = "center"; // centra verticalmente
    fila.style.overflowX = "auto";
    fila.style.overflowY = "hidden"; // evita scroll vertical
    fila.style.msOverflowStyle = "none";
    fila.style.scrollbarWidth = "none";
    
    // Guardamos info
    fila.dataset.todos = JSON.stringify(dataSource);
    fila.dataset.renderizados = Math.min(dataSource.length, 30);
    
    // Renderizar primeros 25 emojis
    dataSource.slice(0, 30).forEach(item => {
      if (Array.isArray(item))
        fila.appendChild(crearSpanEmoji(item[0], categoria, item));
      else
        fila.appendChild(crearSpanEmoji(item, categoria));
    });
    
    // Cuando el usuario empieza a hacer scroll, renderizamos el resto (una sola vez)
    const onScroll = () => {
      const todos = JSON.parse(fila.dataset.todos);
      const renderizados = parseInt(fila.dataset.renderizados, 10) || 0;
      if (renderizados < todos.length) {
        todos.slice(renderizados).forEach(item => {
          if (Array.isArray(item))
            fila.appendChild(crearSpanEmoji(item[0], categoria, item));
          else
            fila.appendChild(crearSpanEmoji(item, categoria));
        });
        fila.dataset.renderizados = todos.length;
        fila.removeEventListener("scroll", onScroll); // Evita hacerlo mÃ¡s de una vez
      }
    };
    
    fila.addEventListener("scroll", onScroll, { once: true });
    
    lista.appendChild(fila);
  });
}

function crearSpanEmoji(e, categoria, grupoEspecial = null) {
  const span = document.createElement("span");
  span.textContent = e;
  span.style.fontSize = "3rem";
  span.style.userSelect = "none";
  span.tabIndex = 0;
  span.setAttribute("role", "button");
  span.setAttribute("aria-label", `Emoji ${e}`);
  span.style.position = "relative"; // importante para el triÃ¡ngulo
  
  // âœ… Click normal: selecciona el emoji actualmente visible (con tono si lo tiene)
span.addEventListener("click", () => {
  avatarSeleccionado = span.textContent.replace(/\uFE0F/g, ''); // quita el VS16 si existe
  const preview = document.getElementById("avatar-preview");
  if (preview) preview.textContent = avatarSeleccionado;
  cerrarTonePicker();
});

  // Detecta automÃ¡ticamente si puede abrir tone picker
  const permitePicker = grupoEspecial || soportaTonos(e);

  // TriÃ¡ngulo indicativo para tone picker
  if (permitePicker) {
    const tri = document.createElement("span");
    tri.style.position = "relative";
    tri.style.width = "0";
    tri.style.height = "0";
    tri.style.borderLeft = "5px solid transparent";
    tri.style.borderRight = "5px solid transparent";
    tri.style.borderTop = "5px solid rgba(0,0,0,0.1)";
    tri.style.bottom = "2px";
    tri.style.left = "29px";
    tri.style.transform = "rotate(-45deg)";
    span.appendChild(tri);
  }

  // FunciÃ³n para abrir tone picker
  const abrirPicker = () => {
    if (grupoEspecial) mostrarTonePickerEspecial(grupoEspecial, span);
    else if (permitePicker) mostrarTonePicker(e, span);
  };

  // Eventos para abrir tone picker
  span.addEventListener("contextmenu", ev => { ev.preventDefault(); abrirPicker(); });
  span.addEventListener("pointerdown", ev => {
    if (ev.pointerType === "touch") span.__longpressTimer = setTimeout(abrirPicker, 450);
  });
  span.addEventListener("pointerup", () => clearLongPress(span));
  span.addEventListener("pointercancel", () => clearLongPress(span));
  span.addEventListener("pointerleave", () => clearLongPress(span));
  span.addEventListener("keydown", ev => {
    if (ev.key === "Enter" || ev.key === " ") { ev.preventDefault(); abrirPicker(); }
  });

  return span;
}

let emojiActivo = null;
let touchStartY = 0;
let touchStartX = 0;
let haMovido = false;
let longPressTimer = null;

// Aplica el efecto visual
function aplicarEfectoEmoji(span) {
  if (emojiActivo && emojiActivo !== span) {
    emojiActivo.style.transform = "";
    emojiActivo.style.filter = "";
  }
  span.style.transform = "scale(1.05)";
  
  span.style.filter = "drop-shadow(0 0 2px rgba(0, 0, 0, 0.7))";
  span.style.transition = "transform 0.15s ease, filter 0.15s ease";
  emojiActivo = span;
}

// Quita el efecto
function quitarEfectoEmojis() {
  if (emojiActivo) {
    emojiActivo.style.transform = "";
    emojiActivo.style.filter = "";
    emojiActivo = null;
  }
}

// Quita efecto al tocar fuera o scrollear
document.addEventListener("click", e => {
  if (e.target.closest(".fila-emoji span")) return;
  quitarEfectoEmojis();
});
document.addEventListener("scroll", quitarEfectoEmojis, { passive: true });
document.addEventListener("touchmove", quitarEfectoEmojis, { passive: true });

// --- Envolvemos la funciÃ³n crearSpanEmoji ---
const originalCrearSpanEmoji = crearSpanEmoji;
crearSpanEmoji = function(e, categoria, grupoEspecial = null) {
  const span = originalCrearSpanEmoji(e, categoria, grupoEspecial);
  span.style.transition = "transform 0.15s ease, filter 0.15s ease";
  
  // Detectar diferencia de movimiento para no activar si es scroll
  span.addEventListener("touchstart", ev => {
    const t = ev.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
    haMovido = false;
    
    // Programamos long press visual (instantÃ¡neo cuando empieza la acciÃ³n de mantener)
    longPressTimer = setTimeout(() => {
      if (!haMovido) aplicarEfectoEmoji(span);
    }, 150); // ğŸ”¹ pequeÃ±o retardo para evitar falsos positivos al scrollear
  });
  
  span.addEventListener("touchmove", ev => {
    const t = ev.touches[0];
    const dx = Math.abs(t.clientX - touchStartX);
    const dy = Math.abs(t.clientY - touchStartY);
    if (dx > 10 || dy > 10) haMovido = true; // si se moviÃ³ mÃ¡s de 10px es scroll
  });
  
  span.addEventListener("touchend", () => {
    clearTimeout(longPressTimer);
    longPressTimer = null;
    // No quitamos el efecto aquÃ­ â€” se quita al tocar fuera o scrollear
  });
  
  span.addEventListener("touchcancel", () => {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  });
  
  // Click (mouse)
  span.addEventListener("mousedown", () => aplicarEfectoEmoji(span));
  
  return span;
};

function clearLongPress(span) {
  if (span.__longpressTimer) {
    clearTimeout(span.__longpressTimer);
    span.__longpressTimer = null;
  }
}

let ordenUsuarios = [];
let dragCard = null;
let dragNombre = null;
let isDragging = false;
let isOverTrash = false;
let sortableUsuarios = null;
let pointerMoveHandler = null;
let lastScrollTime = 0;
let lastPointerX = 0;
let lastPointerY = 0;
let currentScrollAnimation = null;
let scrollCheckFrame = null;

const trashBin = document.createElement("div");
trashBin.id = "trash-bin";
trashBin.textContent = "ğŸ—‘ï¸";
Object.assign(trashBin.style, {
  display: "none",
  position: "fixed",
  top: "50%",
  left: "50%",
  transform: "translate(-50%, -50%)",
  fontSize: "4rem",
  zIndex: "100",
  pointerEvents: "none",
  filter: "drop-shadow(0 0 1px rgba(0, 0, 0, 0.5))",
  transition: "transform .12s ease, filter .12s ease"
});
document.body.appendChild(trashBin);

function toggleAvatarYBtn(opacity) {
  const avatar = document.getElementById("avatar-preview");
  const btnEditar = document.getElementById("btn-editar-perfiles");
  
  [avatar, btnEditar].forEach(el => {
    if (!el) return;
    el.style.transition = "opacity 0s ease";
    el.style.opacity = opacity;
  });
}

function posicionarTrashBin() {
  const avatar = document.getElementById("avatar-preview");
  const btnEditar = document.getElementById("btn-editar-perfiles");
  let targetEl = null;
  
  if (avatar && avatar.offsetParent !== null) {
    targetEl = avatar;
  } else if (btnEditar && btnEditar.offsetParent !== null) {
    targetEl = btnEditar;
  }
  
  if (targetEl) {
    const rect = targetEl.getBoundingClientRect();
    Object.assign(trashBin.style, {
      position: "fixed",
      top: `${rect.top + rect.height / 2}px`,
      left: `${rect.left + rect.width / 2}px`,
      transform: "translate(-50%, -50%)",
      display: "block"
    });
    toggleAvatarYBtn(0); // ğŸ‘ˆ Oculta avatar y botÃ³n
  }
}

function hacerSortable() {
  if (sortableUsuarios) return;
  
  sortableUsuarios = new Sortable(listaUsuariosDiv, {
    group: 'usuarios',
    animation: 300,
    draggable: '.perfil-card:not(.add)',
    handle: '.perfil-avatar .emoji',
    filter: '.add',
    forceFallback: true,
    ghostClass: 'drag-ghost',
    fallbackClass: 'drag-fallback',
    delay: 100,
    swapThreshold: 0.4,
    delayOnTouchOnly: true,
    scroll: false,
    
    onStart(evt) {
      dragCard = evt.item;
      dragNombre = dragCard.getAttribute("data-nombre");
      posicionarTrashBin();
      isOverTrash = false;
      isDragging = true;
      
      pointerMoveHandler = onPointerMove;
      window.addEventListener("mousemove", pointerMoveHandler);
      window.addEventListener("touchmove", pointerMoveHandler, { passive: true });
      
      scrollCheckFrame = requestAnimationFrame(checkScroll);
    },
    
    onEnd(evt) {
      isDragging = false;
      window.removeEventListener("mousemove", pointerMoveHandler);
      window.removeEventListener("touchmove", pointerMoveHandler);
      pointerMoveHandler = null;
      
      // ğŸ”„ Reiniciar animaciÃ³n de scroll si quedÃ³ activa
      if (scrollCheckFrame) {
        cancelAnimationFrame(scrollCheckFrame);
        scrollCheckFrame = null;
      }
      if (currentScrollAnimation) {
        cancelAnimationFrame(currentScrollAnimation.frame);
        currentScrollAnimation = null;
      }
      
      lastScrollTime = 0;
      lastPointerX = 0;
      lastPointerY = 0;
      
      trashBin.style.display = "none";
      toggleAvatarYBtn(1);
      
      ordenUsuarios = Array.from(listaUsuariosDiv.children)
        .filter(el => el.classList.contains('perfil-card') && !el.classList.contains('add'))
        .map(el => el.getAttribute("data-nombre"));
      
      if (isOverTrash) {
        const nombreArrastrado = dragNombre || (evt.item && evt.item.getAttribute("data-nombre"));
        eliminarUsuarioActual(nombreArrastrado);
      }
      
      dragCard = null;
      dragNombre = null;
      isOverTrash = false;
    }
  });
}

function animateScroll(container, distance, duration = 300) {
  if (currentScrollAnimation) cancelAnimationFrame(currentScrollAnimation.frame);
  
  const start = container.scrollLeft;
  const startTime = performance.now();
  
  function step(time) {
    const t = Math.min(1, (time - startTime) / duration);
    const eased = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; // easeInOutQuad
    container.scrollLeft = start + distance * eased;
    if (t < 1) {
      currentScrollAnimation.frame = requestAnimationFrame(step);
    } else {
      currentScrollAnimation = null;
    }
  }
  
  currentScrollAnimation = { frame: requestAnimationFrame(step) };
}

function checkScroll() {
  if (!isDragging || !dragCard) return;
  
  const container = listaUsuariosDiv;
  const rect = container.getBoundingClientRect();
  const now = Date.now();
  
  const insideContainer =
    lastPointerX >= rect.left &&
    lastPointerX <= rect.right &&
    lastPointerY >= rect.top &&
    lastPointerY <= rect.bottom;
  
  const nearEdge = lastPointerX - rect.left < 25 || rect.right - lastPointerX < 25;
  if (sortableUsuarios) {
    sortableUsuarios.option("swapThreshold", nearEdge ? 1 : 0.4);
  }
  
  if (insideContainer && now - lastScrollTime >= 310) {
    lastScrollTime = now;
    
    const card = container.querySelector('.perfil-card');
    if (card) {
      const cardWidth = card.offsetWidth;
      
      if (lastPointerX - rect.left < 25) {
        animateScroll(container, -cardWidth);
      } else if (rect.right - lastPointerX < 25) {
        animateScroll(container, cardWidth);
      }
    }
  }
  
  scrollCheckFrame = requestAnimationFrame(checkScroll);
}

function onPointerMove(e) {
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  
  lastPointerX = clientX; // necesario para scroll
  lastPointerY = clientY; // ğŸ‘ˆ guardar Y tambiÃ©n
  
  // Comprobar si estÃ¡ sobre trash
  const rect = trashBin.getBoundingClientRect();
  const nowOver =
    clientX >= rect.left &&
    clientX <= rect.right &&
    clientY >= rect.top &&
    clientY <= rect.bottom;
  
  if (nowOver !== isOverTrash) {
    isOverTrash = nowOver;
    if (isOverTrash) {
      trashBin.style.transform = "translate(-50%, -50%) scale(1.05)";
      trashBin.style.filter = "drop-shadow(0 0 1px rgba(0, 0, 0, 0.5))";
    } else {
      trashBin.style.transform = "translate(-50%, -50%) scale(1)";
      
    }
  }
}

function actualizarMenu() {
  listaUsuariosDiv.innerHTML = "";
  
  let perfilesHumanos;
  const todosUsuarios = Object.keys(usuariosMap).filter(u => u !== "Calculadora Nutricional");
  
  if (ordenUsuarios.length) {
    ordenUsuarios = ordenUsuarios.filter(u => todosUsuarios.includes(u));
    perfilesHumanos = ordenUsuarios;
    todosUsuarios.forEach(u => {
      if (!ordenUsuarios.includes(u)) ordenUsuarios.push(u);
    });
    perfilesHumanos = ordenUsuarios;
  } else {
    perfilesHumanos = todosUsuarios;
    ordenUsuarios = [...perfilesHumanos];
  }
  
  if (perfilesHumanos.length > 0) {
  listaUsuariosDiv.classList.add("con-perfiles");
} else {
  listaUsuariosDiv.classList.remove("con-perfiles");
}
  
  function soloLetras(str) {
    return str.replace(/[^\p{L}\s]/gu, '');
  }
  
  perfilesHumanos.forEach((clave, idx) => {
    const usuario = usuariosMap[clave];
    const card = document.createElement("div");
    card.className = "perfil-card" + (clave === usuarioActivo ? " active" : "");
    card.setAttribute("data-nombre", clave);
    card.addEventListener("click", () => mostrarUsuario(clave));
    
    const avatar = document.createElement("div");
    avatar.className = "perfil-avatar";
    
    const emojiSpan = document.createElement("span");
    emojiSpan.className = "emoji";
    emojiSpan.textContent = usuario.emoji || emojisDisponibles[idx % emojisDisponibles.length];
    
    const p = document.createElement("p");
    p.textContent = soloLetras(usuario.nombreVisual); // ğŸ”¹ nombre visual
    
    avatar.appendChild(emojiSpan);
    avatar.appendChild(p);
    card.appendChild(avatar);
    listaUsuariosDiv.appendChild(card);
  });
  
  // Card "Crear perfil"
  const addCard = document.createElement("div");
  addCard.className = "perfil-card add";
  addCard.addEventListener("click", () => abrirMenuNuevoUsuario());
  
  const addAvatar = document.createElement("div");
  addAvatar.className = "perfil-avatar add";
  
  const emojiSpanAdd = document.createElement("span");
  emojiSpanAdd.className = "emoji";
  emojiSpanAdd.textContent = "+";
  
  const pAdd = document.createElement("p");
  pAdd.textContent = "Crear perfil";
  
  addAvatar.appendChild(emojiSpanAdd);
  addAvatar.appendChild(pAdd);
  addCard.appendChild(addAvatar);
  listaUsuariosDiv.appendChild(addCard);
  
  const btnEditar = document.getElementById("btn-editar-perfiles");
  if (btnEditar) {
    if (perfilesHumanos.length === 0) {
      btnEditar.classList.add("hidden");
    } else {
      btnEditar.classList.remove("hidden");
      btnEditar.onclick = () => {
        usuarioEditando = usuarioActivo;
        const usuario = usuariosMap[usuarioActivo];
        abrirEditorUsuario("Editar perfil", usuario.nombreVisual, usuario.emoji || "ğŸ™‚", true);
      };
    }
  }
  
  hacerSortable();
}

function mostrarUsuario(clave) {
  const panel1 = document.getElementById("panel1");
  if (panel1) panel1.style.display = "none";
  
  const usuario = usuariosMap[clave];
  if (!usuario) return;
  
  usuarioActivo = clave;
  
  // Ocultar comidas de todos los usuarios
  Object.values(usuariosMap).forEach(u => {
    Object.values(u.comidas).forEach(c => {
      const el = document.getElementById(`comida-${u.nombre}-${c.nombre}`);
      if (el) el.classList.add("hidden");
    });
    const totalDiv = document.getElementById(`total-${u.nombre}`);
    if (totalDiv) totalDiv.classList.add("hidden");
  });
  
  // Mostrar comidas del usuario activo
  Object.values(usuario.comidas).forEach(c => {
    const el = document.getElementById(`comida-${usuario.nombre}-${c.nombre}`);
    if (el) el.classList.remove("hidden");
  });
  
  actualizarVistaTotal(clave, usuario.comidas);
  
  // ğŸ”¹ Mostrar nombre visual en tÃ­tulos
  document.querySelectorAll(".titulo-calculadora").forEach(el => {
    el.textContent = usuario.nombreVisual;
  });
  
  actualizarMenu();
  cerrarEditorUsuario();
  Scroll();

Object.keys(usuario.comidas).forEach(nombreComida => {
  const key = `${usuario.nombre}-${nombreComida}`;
  actualizarListaAgregados(key);
});
}

function abrirMenuNuevoUsuario() {
  usuarioEditando = null;
  abrirEditorUsuario("Nuevo perfil", "", "ğŸ™‚", false);
  
  // ğŸ•“ AnimaciÃ³n del emoji despuÃ©s de abrir el editor
  const avatar = document.getElementById("avatar-preview");
  
  // Cancelar animaciones previas si las hubiera
  clearTimeout(avatar._lenguaTimeout1);
  clearTimeout(avatar._lenguaTimeout2);
  
  // Esperar 5 segundos â†’ ğŸ˜› â†’ 1 segundo â†’ ğŸ™‚
  avatar._lenguaTimeout1 = setTimeout(() => {
    const original = avatar.textContent;
    avatar.textContent = "ğŸ˜›";
    
    avatar._lenguaTimeout2 = setTimeout(() => {
      avatar.textContent = original;
    }, 500);
  }, 2000);
}

let modoFocoBloqueado = false;
let focusDesdeToast = false; // ğŸ”¹ Flag para focus de toast

function abrirEditorUsuario(titulo, nombre, emoji, esEditar) {
  var editor = document.getElementById("editor-usuario");
  editor.classList.remove("hidden");

  document.getElementById("titulo-editor").textContent = titulo;

  var nombreDiv = document.getElementById("input-nombre-usuario");
  var fechaDiv  = document.getElementById("input-fecha");
  var edadDiv   = document.getElementById("input-edad");
  var pesoDiv   = document.getElementById("input-peso");
  var alturaDiv = document.getElementById("input-altura");

  nombreDiv.textContent = nombre || "";
  document.getElementById("avatar-preview").textContent = emoji;
  avatarSeleccionado = emoji;

  // --- Cargar datos si es ediciÃ³n ---
  if (esEditar && usuarioActivo && usuariosMap[usuarioActivo]) {
    var u = usuariosMap[usuarioActivo];

    fechaDiv.textContent  = u.fechaNacimiento || "";
    pesoDiv.textContent   = u.peso ?? "";
    alturaDiv.textContent = u.altura ?? "";
    edadDiv.textContent   = u.edad ?? "";

  } else {
    fechaDiv.textContent  = "";
    pesoDiv.textContent   = "";
    alturaDiv.textContent = "";
    edadDiv.textContent   = "";
  }

  // --- Mostrar / esconder botones ---
  var btnEliminar = document.getElementById("btn-eliminar-usuario");
  var btnCancelar = document.getElementById("btn-cancelar");
  var btnGuardar  = document.getElementById("btn-guardar-usuario");

  btnEliminar.style.display = esEditar ? "inline-block" : "none";
  btnCancelar.style.display = esEditar ? "none" : "inline-block";
  btnGuardar.style.display  = "inline-block";

  document.querySelectorAll('#panel1 .menu-izquierdo button, #btn-editar-perfiles')
    .forEach(btn => btn.style.display = "none");

  setTimeout(() => renderizarEmojis(), 0);

  // --- Modo foco ---
  var elementosAOcultar = Array.from(
    document.querySelectorAll("#panel1 .barra:not(#editor-usuario .barra), #lista-usuarios")
  );

  function activarModoFoco() {
    elementosAOcultar.forEach(el => el.style.display = "none");
    editor.querySelector(".barra").style.display = "flex";
    editor.style.position = "fixed";
    editor.style.inset = "0";
    editor.style.transition = "none";
    editor.style.opacity = "1";
    focusDesdeToast = false;
  }

  function desactivarModoFoco(e) {
    if (modoFocoBloqueado) return;
    var newFocus = e && e.relatedTarget;
    if (newFocus && editor.contains(newFocus)) return;

    setTimeout(() => {
      elementosAOcultar.forEach(el => el.style.display = "");
      editor.style.position = "";
      editor.style.inset = "";
    }, 0);
  }

  activarModoFoco();

  var inputsFoco = [nombreDiv, fechaDiv, pesoDiv, alturaDiv, edadDiv];

  inputsFoco.forEach(function(div){
    div.removeEventListener("focus", div._focusHandler);
    div.removeEventListener("blur", div._blurHandler);

    div._focusHandler = activarModoFoco;
    div._blurHandler  = desactivarModoFoco;

    div.addEventListener("focus", activarModoFoco);
    div.addEventListener("blur", desactivarModoFoco);
  });

  [btnGuardar, btnEliminar].forEach(btn => {
    btn.addEventListener("mousedown", () => modoFocoBloqueado = true);
  });

  // --- PLACEHOLDERS ---
  var fields = [nombreDiv, fechaDiv, alturaDiv, pesoDiv, edadDiv];

  fields.forEach(function(div){
    var ph = div.dataset.placeholder || "";

    var updatePlaceholder = function(){
      if (!div.textContent.trim()) {
        div.classList.add("placeholder-activo");
        div.textContent = ph;
      } else {
        if (div.classList.contains("placeholder-activo")) div.textContent = "";
        div.classList.remove("placeholder-activo");
      }
    };

    if (!div.textContent.trim()) {
      div.classList.add("placeholder-activo");
      div.textContent = ph;
    }

    if (!div._phInit) {
      div._phInit = true;

      div.addEventListener("focus", function(){
        if (div.classList.contains("placeholder-activo")) {
          div.textContent = "";
          div.classList.remove("placeholder-activo");
        }
      });

      div.addEventListener("blur", updatePlaceholder);
    }
  });

  // --- CÃLCULO AUTOMÃTICO DE EDAD ---
  fechaDiv.addEventListener("input", function(){
    var fecha = fechaDiv.textContent.trim();
    var edad = calcularEdadDesdeTexto(fecha);

    if (edad !== null) {
      edadDiv.classList.remove("placeholder-activo");
      edadDiv.textContent = edad;
    } else {
      edadDiv.textContent = "";
      edadDiv.classList.add("placeholder-activo");
    }
  });

  // --- Centrado de label del nombre ---
  var campoNombre = nombreDiv.closest(".campo-integrado");
  campoNombre.classList.add("flotante");

  // --- Focus inicial ---
  setTimeout(function(){
    focusDesdeToast = false;

    nombreDiv.focus();

    var r = document.createRange();
    r.selectNodeContents(nombreDiv);
    r.collapse(false);

    var s = window.getSelection();
    s.removeAllRanges();
    s.addRange(r);

    Input(editor);
  }, 0);
}

function guardarUsuario() {
  var nombreDiv = document.getElementById("input-nombre-usuario");
  var fechaDiv  = document.getElementById("input-fecha");
  var edadDiv   = document.getElementById("input-edad");
  var pesoDiv   = document.getElementById("input-peso");
  var alturaDiv = document.getElementById("input-altura");

  var nombreInput = nombreDiv.classList.contains("placeholder-activo")
    ? ""
    : nombreDiv.textContent.trim();

  if (!nombreInput) {
    setTimeout(() => {
      mostrarToast("Escribe un nombre para el perfil");
      modoFocoBloqueado = false;
    }, 200);

    setTimeout(() => {
      focusDesdeToast = true;
      nombreDiv.focus();
    }, 1301);
    return;
  }

  // --- Ver si existe el nombre ---
  var existe = usuarioEditando
    ? Object.values(usuariosMap).some(u => u.nombreVisual === nombreInput && u !== usuariosMap[usuarioEditando])
    : Object.values(usuariosMap).some(u => u.nombreVisual === nombreInput);

  if (existe) {
    setTimeout(() => {
      mostrarToast("Ese nombre ya existe");
      modoFocoBloqueado = false;
    }, 200);

    setTimeout(() => {
      focusDesdeToast = true;
      nombreDiv.focus();
    }, 1301);
    return;
  }

  modoFocoBloqueado = true;

  setTimeout(() => {
    mostrarConfirmacion(
      "Â¿Quieres guardar este perfil?",
      function(){

        nombreDiv.blur();

        function limpiarNumero(id) {
          var el = document.getElementById(id);
          if (el.classList.contains("placeholder-activo")) return null;

          var raw = el.textContent.trim().replace(",", ".");
          var n = parseFloat(raw);
          return Number.isFinite(n) ? n : null;
        }

        var peso   = limpiarNumero("input-peso");
        var altura = limpiarNumero("input-altura");

        // --- FECHA Y EDAD ---
        var fechaNacimiento = fechaDiv.classList.contains("placeholder-activo")
          ? ""
          : fechaDiv.textContent.trim();

        var edadCalculada = calcularEdadDesdeTexto(fechaNacimiento);

        // Si la fecha es invÃ¡lida => edad null
        if (edadCalculada === null) edadCalculada = null;

        // --- Guardar usuario ---
        if (usuarioEditando) {
          var u = usuariosMap[usuarioEditando];
          u.nombreVisual     = nombreInput;
          u.emoji            = avatarSeleccionado;
          u.fechaNacimiento  = fechaNacimiento;
          u.edad             = edadCalculada;
          u.peso             = peso;
          u.altura           = altura;

          usuarioActivo = usuarioEditando;

        } else {

          var claveBase = nombreInput;
          var clave = claveBase;
          var contador = 1;

          while (usuariosMap[clave]) clave = claveBase + "_" + (contador++);

          var nuevo = new Usuario(clave, contenedor, comidas);
          usuariosMap[clave] = nuevo;

          nuevo.nombreVisual    = nombreInput;
          nuevo.emoji           = avatarSeleccionado;
          nuevo.fechaNacimiento = fechaNacimiento;
          nuevo.edad            = edadCalculada;
          nuevo.peso            = peso;
          nuevo.altura          = altura;

          usuarioActivo = clave;

          var calcNutri = usuariosMap["Calculadora Nutricional"];
          if (calcNutri) {
            Object.keys(calcNutri.comidas).forEach(function(comida){
              var key = "Calculadora Nutricional-" + comida;
              if (datosComidas[key]) {
                datosComidas[key] = [];
                actualizarListaAgregados(key);
              }
            });
          }
        }

        actualizarMenu();
        mostrarUsuario(usuarioActivo);
        cerrarEditorUsuario();
        mostrarToast("Perfil guardado correctamente");

        setTimeout(() => {
          var comidaVisible = Object.keys(usuariosMap[usuarioActivo].comidas)[0];
          var pesoDiv = document.getElementById("peso-" + usuarioActivo + "-" + comidaVisible);
          if (pesoDiv) pesoDiv.focus();
        }, 1001);

        restaurarModoFoco();
      },

      function(){
        mostrarToast("OperaciÃ³n cancelada");
        restaurarModoFoco();
      }
    );

    document.getElementById("alerta-aceptar").textContent = "Aceptar";
  }, 200);
}

function calcularEdadDesdeTexto(texto) {
  // Formato esperado: DD/MM/YYYY
  if (!/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) return null;

  var [d, m, y] = texto.split("/").map(n => parseInt(n));

  var fecha = new Date(y, m - 1, d);
  if (isNaN(fecha.getTime())) return null;

  var hoy = new Date();
  var edad = hoy.getFullYear() - y;

  if (
    hoy.getMonth() < (m - 1) ||
    (hoy.getMonth() === (m - 1) && hoy.getDate() < d)
  ) {
    edad--;
  }

  return edad >= 0 ? edad : null;
}

function restaurarModoFoco() {
  const editor = document.getElementById("editor-usuario");
  const elementosAOcultar = [
    ...document.querySelectorAll("#panel1 .barra:not(#editor-usuario .barra), #lista-usuarios")
  ];
  elementosAOcultar.forEach(el => el.style.display = "");
  editor.querySelector(".barra").style.display = "flex";
  editor.style.position = "";
editor.style.inset = "";
  modoFocoBloqueado = false;
}

function eliminarUsuarioActual(nombreOpcional) {
  const usuarioAEliminar = nombreOpcional || usuarioEditando || usuarioActivo;
  if (!usuarioAEliminar || usuarioAEliminar === "Calculadora Nutricional") return;
  
  const nombreDiv = document.getElementById("input-nombre-usuario");
  modoFocoBloqueado = true;
  
  setTimeout(() => {
    mostrarConfirmacion(
      `Â¿Eliminar usuario ${usuariosMap[usuarioAEliminar].nombreVisual}?`,
      () => {
        if (nombreDiv) nombreDiv.blur();
        const usuario = usuariosMap[usuarioAEliminar];
        
        Object.values(usuario.comidas).forEach(c => {
          const div = document.getElementById(`comida-${usuario.nombre}-${c.nombre}`);
          if (div) div.remove();
          delete datosComidas[`${usuario.nombre}-${c.nombre}`];
        });
        
        const totalDiv = document.getElementById(`total-${usuario.nombre}`);
        if (totalDiv) totalDiv.remove();
        delete datosComidas[`total-${usuario.nombre}`];
        
        delete usuariosMap[usuarioAEliminar];
        
        const restantes = Object.keys(usuariosMap).filter(u => u !== "Calculadora Nutricional");
        usuarioActivo = restantes[0] || "Calculadora Nutricional";
        
        actualizarMenu();
        if (usuarioActivo) mostrarUsuario(usuarioActivo);
        
        cerrarEditorUsuario();
        mostrarToast("Usuario eliminado correctamente");
        
        setTimeout(() => {
  const comidaVisible = Object.keys(usuariosMap[usuarioActivo].comidas)[0];
  const pesoDiv = document.getElementById(`peso-${usuarioActivo}-${comidaVisible}`);
  if (pesoDiv) pesoDiv.focus();
}, 1001);
        
        restaurarModoFoco();
      },
      () => {
        mostrarToast("OperaciÃ³n cancelada");
        restaurarModoFoco();
      },
      {
        textoAceptar: "Eliminar",
        colorTexto: "red"
      }
    );
  }, 200);
}

function cerrarEditorUsuario() {
  const editor = document.getElementById("editor-usuario");
  editor.classList.add("hidden");
  
  document.querySelectorAll('#panel1 .menu-izquierdo button, #btn-editar-perfiles')
  .forEach(btn => btn.style.display = "inline-block");

// Restaurar lo que ocultÃ³ el modo foco
  document.querySelectorAll("#panel1 .barra:not(#editor-usuario .barra), #lista-usuarios")
    .forEach(el => el.style.display = "");
  
  // Limpiar emojis para que se rendericen de nuevo al abrir
  const listaEmojis = document.getElementById("lista-emojis");
  if (listaEmojis) listaEmojis.innerHTML = "";
}

const usuarioFantasma = new Usuario("Calculadora Nutricional", contenedor, comidas);
usuarioFantasma.fantasma = true;
usuarioFantasma.nombreVisual = "Calculadora Nutricional";
usuariosMap["Calculadora Nutricional"] = usuarioFantasma;
actualizarMenu();

function actualizarVistaComida(usuario, comida) {
  const items = datosComidas[`${usuario}-${comida}`] || [];
  const totales = calcularComida(usuario, comida);
  
  // âœ… usamos CSS.escape para que los espacios en el nombre no rompan el selector
  const seccionComida = document.querySelector(
    `#${CSS.escape(`comida-${usuario}-${comida}`)}`
  );
  
  const contenedor0 = seccionComida?.querySelector(".contenedor0");
  
  if (contenedor0) {
    if (items.length === 0) {
      contenedor0.classList.add("hidden");
      ocultarGrafico(`${usuario}-${comida}`);
    } else {
      contenedor0.classList.remove("hidden");
      renderGrafico(`${usuario}-${comida}`, totales);
      renderTabla(`${usuario}-${comida}`, totales);
      nutrientesPlanos.forEach(n => {
        VDREditor(`${usuario}-${comida}`, n.nombre);
      });
    }
  }
}

function actualizarComida(usuario, comida) {
  if (usuariosMap[usuario]) {
    usuariosMap[usuario].actualizarComida(comida);
  }
}

function actualizarVistaTotal(usuario, comidasUsuario) {
  datosComidas[`total-${usuario}`] = [];
  Object.keys(comidasUsuario).forEach(c => {
    (datosComidas[`${usuario}-${c}`] || []).forEach(d =>
      datosComidas[`total-${usuario}`].push(d)
    );
  });
  
  const totalesTotal = calcularComida(usuario, "total");
  
  const comidasConAlimentos = Object.keys(comidasUsuario).filter(
    c => (datosComidas[`${usuario}-${c}`] || []).length > 0
  );
  
  const contenedorTotal = document.querySelector(
    `#${CSS.escape(`total-${usuario}`)}`
  );
  const contenedor0Total = contenedorTotal?.querySelector(".contenedor0");
  
  if (!contenedorTotal) return;
  
  if (usuario !== usuarioActivo) {
    contenedorTotal.classList.add("hidden");
    contenedor0Total?.classList.add("hidden");
    return;
  }
  
  if (comidasConAlimentos.length >= 2) {
    contenedorTotal.classList.remove("hidden");
    contenedor0Total?.classList.remove("hidden");
  } else {
    contenedorTotal.classList.add("hidden");
    contenedor0Total?.classList.add("hidden");
  }
  
  ocultarGrafico(`total-${usuario}`);
  renderGrafico(`total-${usuario}`, totalesTotal);
  renderTabla(`total-${usuario}`, totalesTotal);
  Sistemas(usuario, totalesTotal);
}

function calcularComida(usuario, comida) {
  const key = comida === "total" ? `total-${usuario}` : `${usuario}-${comida}`;
  const items = datosComidas[key] || [];
  const totales = {};
  nutrientesPlanos.forEach(n => (totales[n.nombre] = 0));
  
  items.forEach(({ alimento, peso }) => {
    for (const [nombre, valor] of Object.entries(alimento.composicion)) {
      totales[nombre] += (valor * peso) / 100;
    }
  });
  
  if (comida !== "total") {
    const { pH, pHEst } = calcularPHComida(items);
    totales["pH (alimento)"] = pH != null && Number.isFinite(pH) ? Number(pH.toFixed(2)) : null;
    totales["pH estimado en estÃ³mago"] = pHEst != null && Number.isFinite(pHEst) ? Number(pHEst.toFixed(2)) : null;
  }
  
  return totales;
}

function Input(contenedor) {
  if (!contenedor) return;
  
  function setCaretToEnd(el) {
    if (!el) return;
    el.focus();
    
    const range = document.createRange();
    const sel = window.getSelection();
    
    if (!el.lastChild) el.appendChild(document.createTextNode(""));
    let lastNode = el.lastChild;
    while (lastNode && lastNode.nodeType !== Node.TEXT_NODE) {
      lastNode = lastNode.lastChild || lastNode.previousSibling;
    }
    if (!lastNode) {
      lastNode = document.createTextNode("");
      el.appendChild(lastNode);
    }
    
    range.setStart(lastNode, lastNode.textContent.length);
    range.collapse(true);
    
    sel.removeAllRanges();
    sel.addRange(range);
  }
  
  const editables = Array.from(contenedor.querySelectorAll('[contenteditable="true"]'));
  
  editables.forEach(el => {
    if (el.dataset.inputActivado) return;
    el.dataset.inputActivado = "true";
    
    const maxDigitos = parseInt(el.dataset.maxDigitos) || 7;
    
    // ---------------------------------
    // ğŸ”¹ Caso 1: BUSCADOR
    // ---------------------------------
    if (el.classList.contains("input-buscador")) {
      el.addEventListener("input", () => {
        if (el.textContent.length > maxDigitos) {
          el.textContent = el.textContent.slice(0, maxDigitos);
          setCaretToEnd(el);
        }
      });
      
      el.addEventListener("paste", e => {
        e.preventDefault();
        const texto = (e.clipboardData || window.clipboardData).getData("text") || "";
        el.textContent = texto.slice(0, maxDigitos);
        setCaretToEnd(el);
      });
      
      el.addEventListener("keydown", e => {
        if (e.key === "Enter") e.preventDefault();
      });
      
      el.addEventListener("focus", () => setCaretToEnd(el));
      el.addEventListener("blur", () => {
        if ((el.textContent || "").trim() === "") el.innerHTML = "";
      });
      
      return;
    }
    
    // ---------------------------------
    // ğŸ”¹ Caso 2: NUMÃ‰RICO (inputmode="decimal")
    // ---------------------------------
    const esNumerico = el.getAttribute("inputmode") === "decimal";
    
    if (esNumerico) {
      const procesar = () => {
        let texto = el.textContent || "";
        const original = texto;
        
        texto = texto.replace(/[^0-9]/g, "");
        if (texto.length > maxDigitos) texto = texto.slice(0, maxDigitos);
        
        if (texto !== original) {
          const pos = window.getSelection().focusOffset;
          el.textContent = texto;
          if (pos >= texto.length - 1) setCaretToEnd(el);
        }
      };
      
      el.addEventListener("input", procesar);
      
      el.addEventListener("paste", e => {
        e.preventDefault();
        const texto = (e.clipboardData || window.clipboardData).getData("text") || "";
        const limpio = texto.replace(/[^0-9]/g, "").slice(0, maxDigitos);
        el.textContent = limpio;
        setCaretToEnd(el);
      });
      
      el.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === "Tab") {
          e.preventDefault();
          const visibles = Array.from(contenedor.querySelectorAll('[contenteditable="true"]'))
            .filter(x => x.offsetParent !== null);
          const idx = visibles.indexOf(el);
          
          let siguiente;
          if (e.shiftKey && idx > 0) siguiente = visibles[idx - 1];
          else if (!e.shiftKey && idx < visibles.length - 1) siguiente = visibles[idx + 1];
          
          if (siguiente) setCaretToEnd(siguiente);
        }
      });
      
      el.addEventListener("focus", () => setCaretToEnd(el));
      el.addEventListener("blur", () => {
        if ((el.textContent || "").trim() === "") el.innerHTML = "";
      });
      
      return;
    }
    
    // ---------------------------------
    // ğŸ”¹ Caso 3: TEXTO LIBRE (como "Nombre")
    //     Respeta data-max-digitos + navegaciÃ³n con Enter/Shift/Tab
    // ---------------------------------
    el.addEventListener("input", () => {
      const original = el.textContent;
      if (original.length > maxDigitos) {
        el.textContent = original.slice(0, maxDigitos);
        setCaretToEnd(el);
      }
    });
    
    el.addEventListener("paste", e => {
      e.preventDefault();
      const texto = (e.clipboardData || window.clipboardData).getData("text") || "";
      el.textContent = texto.slice(0, maxDigitos);
      setCaretToEnd(el);
    });
    
    // ğŸ”¹ NavegaciÃ³n igual que los numÃ©ricos
    el.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === "Tab") {
        e.preventDefault();
        
        const visibles = Array.from(
          contenedor.querySelectorAll('[contenteditable="true"]')
        ).filter(x => x.offsetParent !== null);
        
        const idx = visibles.indexOf(el);
        
        let siguiente;
        if (e.shiftKey && idx > 0) siguiente = visibles[idx - 1];
        else if (!e.shiftKey && idx < visibles.length - 1) siguiente = visibles[idx + 1];
        
        if (siguiente) setCaretToEnd(siguiente);
      }
    });
    
    el.addEventListener("focus", () => setCaretToEnd(el));
    el.addEventListener("blur", () => {
      if ((el.textContent || "").trim() === "") el.innerHTML = "";
    });
  });
}

function Scroll() {
  const panelesAbiertos = [document.getElementById("panel"), document.getElementById("panel1"), document.getElementById("panel2"), document.getElementById("panel3")].filter(p => p.style.display === "block");
  const algunPanelAbierto = panelesAbiertos.length > 0;
  document.body.classList.toggle("panel-abierto", algunPanelAbierto);
  document.documentElement.classList.toggle("panel-abierto", algunPanelAbierto);
  
  panelesAbiertos.forEach(panel =>
    panel.scrollTop = 0);
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  }

document.addEventListener("click", e => {
  const btn = e.target.closest("[data-action][data-target]");
  if (!btn) return;
  
  const action = btn.dataset.action;
  const target = btn.dataset.target;
  const closeId = btn.dataset.close;
  const openId = btn.dataset.open;
  
  if (closeId) closePanel(closeId);
  
  if (action === "toggle") togglePanel(target);
  else if (action === "open") openPanel(target);
  else if (action === "close") closePanel(target);
  
  if (openId) openPanel(openId);
});

function abrirVDR() {
  // Â¿Estaba fullscreen antes?
  const estabaFS = !!document.fullscreenElement;
  
  // Primero renderizar y abrir el panel
  const usuario = usuariosMap[usuarioActivo];
  renderPanelVDR(usuario);
  
  const panel = document.getElementById("panel");
  if (panel) {
    panel.style.display = "block";
  }
  
  Scroll();
  detenerLluvia();
  
  // Si antes NO estaba fullscreen â†’ aplicar delay
  const delay = estabaFS ? 0 : 500;
  
  // Ahora sÃ­: entrar fullscreen despuÃ©s del panel
  setTimeout(() => {
    entrarFullscreen();
  }, delay);
}

function openPanel(id) {
  const panel = document.getElementById(id);
  
  // Estaba fullscreen?
  const estabaFS = !!document.fullscreenElement;
  
  // 1) Abrir el panel primero
  if (panel) {
    panel.style.display = "block";
    Scroll();
    detenerLluvia();
  }
  
  // Reset scroll horizontal
  const listaUsuariosDiv = document.getElementById("lista-usuarios");
  if (listaUsuariosDiv) listaUsuariosDiv.scrollLeft = 0;
  
  // 2) Si ya estaba fullscreen â†’ ejecutar fullscreen sin delay
  //    Si NO estaba fullscreen â†’ esperar delay de 300ms
  const delay = estabaFS ? 0 : 500;
  
  setTimeout(() => {
    entrarFullscreen(); // â† fullscreen DESPUÃ‰S de abrir el panel
  }, delay);
}

function closePanel(id) {
  const panel = document.getElementById(id);
  if (panel) {
    panel.style.display = "none";
    Scroll();
    verificarLluvia();
    
    if (id === "panel1") {
      const editor = document.getElementById("editor-usuario");
      if (!editor.classList.contains("hidden")) {
        cerrarEditorUsuario();
        verificarLluvia();
      }
    }
  }
}

function togglePanel(id) {
  const panel = document.getElementById(id);
  if (panel) {
    const isVisible = panel.style.display === "block";
    panel.style.display = isVisible ? "none" : "block";
    Scroll();
    detenerLluvia();
  }
}

function dividirAlimentos(usuarioComida, divisor) {
  if (!datosComidas[usuarioComida] || datosComidas[usuarioComida].length === 0) return;
  
  divisor = parseFloat(divisor);
  if (isNaN(divisor) || divisor <= 0) {
    mostrarToast("Ingresa un nÃºmero vÃ¡lido mayor a 0 para dividir."); // âš¡ AquÃ­ usamos toast

    // Esperar a que desaparezca el toast (2s) y luego hacer focus
    setTimeout(() => {
      const div = document.getElementById(`divisor-${usuarioComida}`);
      if (div) div.focus();
    }, 1001); // ajusta segÃºn la duraciÃ³n de tu toast

    return;
  }
  
  // Guardar originales si no estÃ¡n guardados
  if (!datosOriginales[usuarioComida] || datosOriginales[usuarioComida].length === 0) {
    datosOriginales[usuarioComida] = datosComidas[usuarioComida].map(item => ({
      alimento: {
        ...item.alimento,
        composicion: item.alimento?.composicion ?
          { ...item.alimento.composicion } :
          undefined
      },
      peso: item.peso
    }));
  }
  
  datosComidas[usuarioComida] = datosComidas[usuarioComida].map(item => {
    let nuevo = { ...item };
    
    if (item.alimento?.esManual) {
      let nuevaCompo = {};
      for (const [nutriente, valor] of Object.entries(item.alimento.composicion)) {
        nuevaCompo[nutriente] = Math.round((valor / divisor) * 100) / 100;
      }
      nuevo.alimento = { ...item.alimento, composicion: nuevaCompo };
      
      const clave = Object.keys(nuevaCompo)[0];
      const valorBase = nuevaCompo[clave];
      const unidadBase = nutrientesPlanos.find(n => n.nombre === clave)?.unidad || item.alimento.unidad;
      
      const valorConvertido = convertir(valorBase, unidadBase, item.alimento.unidad);
      nuevo.alimento.displayManual = `${clave} ${Math.round(valorConvertido * 100) / 100} ${item.alimento.unidad}`;
      
    } else {
      nuevo.peso = Math.round((item.peso / divisor) * 100) / 100;
    }
    
    return nuevo;
  });
  
  actualizarListaAgregados(usuarioComida);
}

function revertirDivision(usuarioComida) {
  const originales = datosOriginales[usuarioComida];
  if (!originales || originales.length === 0) return;
  
  datosComidas[usuarioComida] = datosComidas[usuarioComida].map(item => {
    const original = originales.find(o => o.alimento?.nombre === item.alimento?.nombre);
    
    if (original) {
      return {
        alimento: original.alimento ?
          {
            ...original.alimento,
            composicion: original.alimento.composicion ?
              { ...original.alimento.composicion } :
              undefined,
            displayManual: original.alimento.displayManual || item.alimento.displayManual
          } :
          undefined,
        peso: original.peso
      };
    }
    
    return item;
  });
  
 actualizarListaAgregados(usuarioComida);
  datosOriginales[usuarioComida] = [];
}

// ------------------ Cerrar panel ------------------
document.querySelectorAll("#panel2 .cerrar").forEach(btn => {
  btn.addEventListener("click", () => {
    const usuario = usuariosMap[usuarioActivo];
    if (usuario) delete usuario.distribucionTemp; // borramos cambios temporales
    renderizarDistribucion(usuario); // tabla vuelve a valores por defecto
    document.getElementById("panel2").style.display = "none";
    document.getElementById(btn.dataset.open).style.display = "block";
  });
});

function distribucion() {
  const usuario = usuariosMap[usuarioActivo];
  if (!usuario) return mostrarToast("No hay un usuario activo seleccionado.");
  
  // ğŸ”¹ Cerrar teclado primero
  const nombreDiv = document.getElementById("input-nombre-usuario");
  if (nombreDiv) nombreDiv.blur();
  
  setTimeout(() => {
    mostrarConfirmacion(
      "Â¿Quieres guardar los VDR%?",
      () => {
        if (usuario.distribucionTemp) {
          usuario.distribucionVDR = { ...usuario.distribucionTemp };
          delete usuario.distribucionTemp;
        }
        
        comidas.forEach(comida => usuario.actualizarComida(comida));
        
        document.getElementById("panel2").style.display = "none";
        Scroll();
        verificarLluvia();
        mostrarToast("VDR% guardados correctamente.");
        setTimeout(() => {
  const comidaVisible = Object.keys(usuariosMap[usuarioActivo].comidas)[0];
  const pesoDiv = document.getElementById(`peso-${usuarioActivo}-${comidaVisible}`);
  if (pesoDiv) pesoDiv.focus();
}, 1001);
      },
      () => {
        mostrarToast("OperaciÃ³n cancelada");
      }
    );
    
    const btnAceptar = document.getElementById("alerta-aceptar");
    if (btnAceptar) btnAceptar.textContent = "Aceptar";
  }, 200);
}

function guardarVDR() {
  const usuario = usuariosMap[usuarioActivo];
  if (!usuario) return mostrarToast("No hay un usuario activo para guardar VDR.");
  
  // ğŸ”¹ Cerrar teclado primero
  const nombreDiv = document.getElementById("input-nombre-usuario");
  if (nombreDiv) nombreDiv.blur();
  
  setTimeout(() => {
    mostrarConfirmacion(
      "Â¿Quieres guardar los VDR%?",
      () => {
        const editores = document.querySelectorAll('#panel [data-nutriente]');
        editores.forEach(div => {
          const nombre = div.dataset.nutriente;
          const texto = div.textContent.trim();
          const valor = parseFloat(texto);
          if (!isNaN(valor)) usuario.vdr[nombre] = valor;
        });
        
        cerrarVDR();
        Scroll();
        comidas.forEach(comida => usuario.actualizarComida(comida));
        
        mostrarToast("VDR% guardados correctamente.");
        
        setTimeout(() => {
  const comidaVisible = Object.keys(usuariosMap[usuarioActivo].comidas)[0];
  const pesoDiv = document.getElementById(`peso-${usuarioActivo}-${comidaVisible}`);
  if (pesoDiv) pesoDiv.focus();
}, 1001);
      },
      () => {
        mostrarToast("OperaciÃ³n cancelada");
      }
    );
    
    const btnAceptar = document.getElementById("alerta-aceptar");
    if (btnAceptar) btnAceptar.textContent = "Aceptar";
  }, 200);
}

function cerrarVDR() {
  document.getElementById("panel").style.display = "none";
  Scroll();
  iniciarLluvia();
}

function toggleAlternar(comida) {
  const editor = document.getElementById(`editor-${comida}`);
  const tabla = document.getElementById(`tabla-${comida}`);
  const btn = document.getElementById(`btn-aplicar-${comida}`);
  
  const editorVisible = !editor.classList.contains("hidden");
  
  if (editorVisible) {
    // Aplicamos manual antes de ocultar editor
    aplicarManual(comida);
    
    editor.classList.add("hidden");
    tabla.classList.remove("hidden");
    btn.textContent = "Agregar nutrientes";
  } else {
    // Limpiamos datos manuales y unidades para que selects vuelvan a la original
    datosManuales[comida] ||= {};
    Object.keys(datosManuales[comida]).forEach(k => datosManuales[comida][k] = 0);
    
    datosManualesUnidades[comida] ||= {};
    Object.keys(datosManualesUnidades[comida]).forEach(k => delete datosManualesUnidades[comida][k]);
    
    // Renderizamos editor con unidades originales y VDR correctos
    renderEditorManual(comida);
    
    editor.classList.remove("hidden");
    tabla.classList.add("hidden");
    btn.textContent = "Aplicar nutrientes";
  }
}

function toggleNutrientes(key) {
  mostrarTodosLosNutrientes[key] = !mostrarTodosLosNutrientes[key];
  
  // Extraemos usuario y comida si quieres usar actualizarComida
  const [usuario, ...rest] = key.split("-");
  const comida = rest.join("-"); // en caso de que la comida tenga guiones
  actualizarComida(usuario, comida);
  
  const btn = document.getElementById(`btn-nutrientes-${key}`);
  btn.textContent = mostrarTodosLosNutrientes[key] ?
    "Ocultar nutrientes vacÃ­os" :
    "Mostrar todos los nutrientes";
}

function syncToggles(id) {
  const grafico = document.querySelector(`#${CSS.escape(`seccion0-${id}`)}`);
  const tabla = document.querySelector(`#${CSS.escape(`seccion1-${id}`)}`);
  
  const btnSeccion = document.querySelector(`#${CSS.escape(`btn-seccion-${id}`)}`);
  const btnGrafico = document.querySelector(`#${CSS.escape(`btn-grafico-${id}`)}`);
  const btnTabla = document.querySelector(`#${CSS.escape(`btn-tabla-${id}`)}`);
  
  if (btnSeccion) {
    btnSeccion.textContent = id.startsWith("total-") ? "GrÃ¡fico-Tablas-Perfiles" : "GrÃ¡fico-Tablas";
  }
  
  if (grafico && btnGrafico) {
    const oculto = grafico.classList.contains("hidden");
    btnGrafico.textContent = oculto ? "Mostrar grÃ¡fico" : "Ocultar grÃ¡fico";
  }
  
  if (tabla && btnTabla) {
    const oculto = tabla.classList.contains("hidden");
    btnTabla.textContent = oculto ? "Mostrar tablas" : "Ocultar tablas";
  }
  
  if (id.startsWith("total-")) {
    const usuario = id.slice("total-".length);
    const perfiles = document.querySelector(`#${CSS.escape(`seccion2-${usuario}`)}`);
    const btnPerfiles = document.querySelector(`#${CSS.escape(`btn-perfiles-total-${usuario}`)}`);
    if (btnPerfiles) {
      const oculto = !perfiles || perfiles.classList.contains("hidden");
      btnPerfiles.textContent = oculto ? "Mostrar perfiles" : "Ocultar perfiles";
    }
  }
}

function toggleSeccion(id) {
  const seccion0 = document.querySelector(`#${CSS.escape(`seccion0-${id}`)}`);
  const seccion1 = document.querySelector(`#${CSS.escape(`seccion1-${id}`)}`);
  if (!seccion0 || !seccion1) return;
  
  let perfiles = null;
  let usuario, comida;
  if (id.startsWith("total-")) {
    usuario = id.slice("total-".length);
    comida = "total";
    perfiles = document.querySelector(`#${CSS.escape(`seccion2-${usuario}`)}`);
  } else {
    const pos = id.indexOf("-");
    usuario = id.slice(0, pos);
    comida = id.slice(pos + 1);
  }
  
  const todasOcultas = seccion0.classList.contains("hidden") &&
    seccion1.classList.contains("hidden") &&
    (perfiles ? perfiles.classList.contains("hidden") : true);
  
  if (todasOcultas) {
    seccion0.classList.remove("hidden");
    seccion1.classList.remove("hidden");
    if (perfiles) perfiles.classList.remove("hidden");
  } else {
    seccion0.classList.add("hidden");
    seccion1.classList.add("hidden");
    if (perfiles) perfiles.classList.add("hidden");
  }
  
  ocultarGrafico(id);
  
  const totales = calcularComida(usuario, comida);
  renderGrafico(id, totales);
  syncToggles(id);
}

function toggleGrafico(id) {
  const seccion = document.querySelector(`#${CSS.escape(`seccion0-${id}`)}`);
  if (!seccion) return;
  
  seccion.classList.toggle("hidden");
  ocultarGrafico(id);
  
  let usuario, comida;
  if (id.startsWith("total-")) {
    usuario = id.slice("total-".length);
    comida = "total";
  } else {
    const pos = id.indexOf("-");
    usuario = id.slice(0, pos);
    comida = id.slice(pos + 1);
  }
  
  const totales = calcularComida(usuario, comida);
  renderGrafico(id, totales);
  syncToggles(id);
}

function toggleTabla(id) {
  const seccion = document.querySelector(`#${CSS.escape(`seccion1-${id}`)}`);
  if (!seccion) return;
  
  seccion.classList.toggle("hidden");
  syncToggles(id);
}

function togglePerfiles(usuario) {
  // fallback al usuario activo si no se pasa explicitamente
  if (!usuario) usuario = usuarioActivo;
  const seccion = document.getElementById(`seccion2-${usuario}`);
  if (!seccion) return;
  seccion.classList.toggle("hidden");
  // actualizar textos de botones para ese total-usuario
  syncToggles(`total-${usuario}`);
}

function inicializarComida(usuario, comida) {
  const sec = document.createElement("div");
  sec.className = "section";
  sec.id = `comida-${usuario}-${comida}`;
  sec.style.margin = "0.5rem";
  sec.style.borderBottom = "1px solid #ccc";
  
  sec.innerHTML = `
  <div class="contenedor-select">
    <h5 class="titulo-comida">${comida}</h5>
    <select id="cat-${usuario}-${comida}" class="select-categorias">
      <option value="">Todas las categorÃ­as</option>
      ${categorias.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>
  </div>

  <div class="fila-comida">
    <div class="contenedor-buscador">
      <div
        id="buscar-${usuario}-${comida}"
        contenteditable="true"
        class="input-buscador" 
        data-max-digitos="20"
        placeholder="Buscar alimento"
      ></div>
      <ul id="sugerencias-${usuario}-${comida}" class="sugerencias-lista"></ul>
    </div>
    <div class="contenedor-peso">
      <span class="etiqueta-peso">g</span>
      <div
        id="peso-${usuario}-${comida}"
        contenteditable="true"
        inputmode="decimal"
        class="input-peso"
        placeholder="Peso"
      ></div>
    </div>
  </div>

  <div id="lista-${usuario}-${comida}"></div>

  <div class="contenedor0 hidden">
    <div class="contenedor">
<div class="divisor-box">
  <button onclick="revertirDivision('${usuario}-${comida}')">Revertir</button>
  <div contenteditable="true" id="divisor-${usuario}-${comida}" inputmode="decimal" class="input-divir" placeholder="Dividir comida entre..."></div>
  <button onclick="dividirAlimentos('${usuario}-${comida}', document.getElementById('divisor-${usuario}-${comida}').innerText)">Aplicar</button>
</div>
      <button id="btn-grafico-${usuario}-${comida}" onclick="toggleGrafico('${usuario}-${comida}')">Ocultar grÃ¡fico</button>
      <button id="btn-seccion-${usuario}-${comida}" onclick="toggleSeccion('${usuario}-${comida}')">GrÃ¡fico-Tablas</button>
      <button id="btn-tabla-${usuario}-${comida}" onclick="toggleTabla('${usuario}-${comida}')">Ocultar tablas</button>
      <div>
              <button class="btn-compartir" onclick="compartirAlimentos('${usuario}-${comida}')">Compartir alimentos con perfiles</button>
        </div>
    </div>

    <div id="seccion0-${usuario}-${comida}">
      <h4 id="titulo-grafico-${usuario}-${comida}">GrÃ¡fico Nutricional</h4>
      <canvas id="grafico-${usuario}-${comida}"></canvas>
    </div>
    
    <div id="seccion1-${usuario}-${comida}">
      <button id="btn-nutrientes-${usuario}-${comida}" onclick="toggleNutrientes('${usuario}-${comida}')">
        Mostrar todos los nutrientes
      </button>
      <button id="btn-aplicar-${usuario}-${comida}" onclick="toggleAlternar('${usuario}-${comida}')">Agregar nutrientes</button>
      <h4 id="titulo-tabla-${usuario}-${comida}">Tabla Nutricional</h4>
      <div id="tabla-${usuario}-${comida}"></div>
      <h4 id="titulo-editor-${usuario}-${comida}" class="hidden">Editor Manual</h4>
      <div id="editor-${usuario}-${comida}" class="hidden"></div>
      <button class="btn-compartir" onclick="compartirResultados('${usuario}-${comida}')">Compartir resultados</button>
    </div>
  </div>
  `;
  
  contenedor.appendChild(sec);
  
  datosComidas[`${usuario}-${comida}`] = [];
  datosManuales[`${usuario}-${comida}`] = {};
  mostrarTodosLosNutrientes[`${usuario}-${comida}`] = false;
  datosOriginales[`${usuario}-${comida}`] = [];
  
  Input(contenedor);
  inicializarBusqueda(`${usuario}-${comida}`);
}

function crearSeccionTotal(usuario) {
  const s = document.createElement("div");
  s.className = "section hidden";
  s.id = `total-${usuario}`;
  s.style.margin = "0.5rem";
  s.innerHTML = `
    <h4>Total</h4>
    <div class="contenedor0">
      <div>
        <button id="btn-seccion-total-${usuario}" onclick="toggleSeccion('total-${usuario}')">GrÃ¡fico-Tablas-Perfiles</button>
      </div>
      <button id="btn-grafico-total-${usuario}" onclick="toggleGrafico('total-${usuario}')">Mostrar grÃ¡fico</button>
      <button id="btn-tabla-total-${usuario}" onclick="toggleTabla('total-${usuario}')">Mostrar tabla</button>
<button id="btn-perfiles-total-${usuario}" onclick="togglePerfiles('${usuario}')">Mostrar perfiles</button>
    </div>

    <div id="seccion0-total-${usuario}" class="hidden">
      <h5 id="titulo-grafico-total-${usuario}">GrÃ¡fico Nutricional</h5>
      <canvas id="grafico-total-${usuario}"></canvas>
    </div>

    <div id="seccion1-total-${usuario}" class="hidden contenedor0">
      <h5>Tabla Nutricional</h5>
      <div id="tabla-total-${usuario}"></div>
      <button class="btn-compartir" onclick="compartirResultados('total-${usuario}')">Compartir resultados</button>
    </div>

    <div id="seccion2-${usuario}" class="hidden">
      <h3>Sistemas del cuerpo humano</h3>
      <div id="contenido-perfiles-${usuario}"></div>
    </div>
  `;
  
  datosComidas[`total-${usuario}`] = [];
  datosManuales[`total-${usuario}`] = {};
  return s;
}

function inicializarBusqueda(comida) {
  const buscar = document.getElementById(`buscar-${comida}`);
  const peso = document.getElementById(`peso-${comida}`);
  const cat = document.getElementById(`cat-${comida}`);
  const sugerencias = document.getElementById(`sugerencias-${comida}`);
  
  // Mostrar sugerencias al escribir
  buscar.addEventListener("input", () => {
    const val = buscar.innerText.toLowerCase();
    
    sugerencias.innerHTML = alimentos
      .filter(a =>
        a.nombre.toLowerCase().includes(val) &&
        (!cat.value || a.categoria === cat.value)
      )
      .map(a => `
        <li onclick="setTimeout(() => seleccionarAlimento('${comida}','${a.nombre}'), 0)">
          <button>${a.nombre}</button>
        </li>
      `)
      .join("");
  });
  
  document.addEventListener("click", function(e) {
    const clickedInside =
      buscar.contains(e.target) ||
      sugerencias.contains(e.target) ||
      peso.contains(e.target);
    
    if (!clickedInside) {
      buscar.innerText = "";
      sugerencias.innerHTML = "";
      peso.innerText = "";
    }
  });
}

function seleccionarAlimento(usuarioComida, nombre) {
  // Â¿Estaba fullscreen antes?
  const estabaFS = !!document.fullscreenElement;
  
  // Delay segÃºn si ya estaba en fullscreen
  const delay = estabaFS ? 0 : 500;
  
  // --- LÃ³gica principal primero ---
  const [usuario, comida] = usuarioComida.split("-");
  const buscar = document.getElementById(`buscar-${usuarioComida}`);
  const pesoDiv = document.getElementById(`peso-${usuarioComida}`);
  const sugerencias = document.getElementById(`sugerencias-${usuarioComida}`);
  
  const peso = parseFloat(pesoDiv.innerText);
  const alimento = alimentos.find(a => a.nombre === nombre);
  
  if (!alimento) return;
  
  if (!peso || isNaN(peso) || peso <= 0) {
    mostrarToast("Peso invÃ¡lido. Ingresa un valor mayor a 0.");
    setTimeout(() => pesoDiv.focus(), 1000);
    return;
  }
  
  const totalesActuales = calcularComida(usuario, comida);
  let superaLimite = false;
  
  for (const [nutriente, valor] of Object.entries(alimento.composicion || {})) {
    const nuevoValor =
      (totalesActuales[nutriente] || 0) + (valor * (peso / 100));
    
    if (nuevoValor > 9999999) {
      superaLimite = true;
      mostrarToast(
        `No se puede agregar "${alimento.nombre}" porque "${nutriente}" superarÃ­a el lÃ­mite de 7 dÃ­gitos enteros.`,
        2500
      );
      break;
    }
  }
  
  if (superaLimite) return;
  
  if (!datosComidas[usuarioComida]) {
    datosComidas[usuarioComida] = [];
  }
  
  datosComidas[usuarioComida].push({ alimento, peso });
  
  buscar.innerText = "";
  pesoDiv.innerText = "";
  sugerencias.innerHTML = "";
  actualizarListaAgregados(usuarioComida);
  
  // --- Fullscreen AL FINAL ---
  setTimeout(() => {
    entrarFullscreen(); // â† Se ejecuta despuÃ©s de todo lo anterior
  }, delay);
}

function actualizarListaAgregados(usuarioComida, eliminarIndex = null) {
  if (!datosComidas[usuarioComida]) datosComidas[usuarioComida] = [];
  
  // Eliminar si viene Ã­ndice
  if (eliminarIndex !== null) {
    if (eliminarIndex >= 0 && eliminarIndex < datosComidas[usuarioComida].length) {
      datosComidas[usuarioComida].splice(eliminarIndex, 1);
    }
  }
  
  const contenedor = document.getElementById(`lista-${usuarioComida}`);
  if (!contenedor) return;
  
  const items = datosComidas[usuarioComida] || [];
  if (items.length === 0) {
    contenedor.innerHTML = "";
    const [usuario] = usuarioComida.split("-");
    actualizarComida(usuario, usuarioComida.split("-")[1]);
  } else {
    const scrollable = document.createElement("div");
    scrollable.classList.add("sin-scrollbar"); // ğŸ‘ˆ nueva clase
    if (items.length > 5) {
      scrollable.style.maxHeight = "160px";
      scrollable.style.overflowY = "auto";
    }
    
    const tabla = document.createElement("table");
    tabla.innerHTML = `
      <thead>
        <tr>
          <th>Alimento / Nutriente</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    
    const tbody = tabla.querySelector("tbody");
    
    items.forEach((item, index) => {
      const { alimento, peso } = item;
      const tr = document.createElement("tr");
      
      if (alimento?.esManual) {
        const partes = alimento.displayManual.trim().split(" ");
        const unidad = partes.pop();
        const cantidad = partes.pop();
        const nombre = partes.join(" ");
        
        tr.innerHTML = `
          <td>${nombre}</td>
          <td>${cantidad}</td>
          <td>${unidad}</td>
          <td><button class="btn-eliminar" data-index="${index}" style="font-weight:bold;border:none;background:none;font-size:1.3rem;margin:0;padding:0;height:100%;">Ã—</button></td>
        `;
      } else {
        tr.innerHTML = `
          <td>${alimento.nombre}</td>
          <td>${peso}</td>
          <td>${alimento.unidad || "g"}</td>
          <td><button class="btn-eliminar" data-index="${index}" style="font-weight:bold;border:none;background:none;font-size:1.3rem;margin:0;padding:0;height:100%;">Ã—</button></td>
        `;
      }
      
      tbody.appendChild(tr);
    });
    
    scrollable.appendChild(tabla);
    contenedor.innerHTML = "";
    contenedor.appendChild(scrollable);
    
    contenedor.querySelectorAll(".btn-eliminar").forEach(btn => {
      btn.onclick = () => actualizarListaAgregados(usuarioComida, parseInt(btn.dataset.index, 10));
    });
    
    const [usuario] = usuarioComida.split("-");
    actualizarComida(usuario, usuarioComida.split("-")[1]);
  }
  
  // =====================
  // ğŸ”´ CONTROL DE LLUVIA
  // =====================
  const usuarioActivoObj = usuariosMap[usuarioActivo];
  let activarLluvia = false;
  
  if (usuarioActivoObj) {
    const comidasUsuario = Object.keys(usuarioActivoObj.comidas);
    activarLluvia = comidasUsuario.length > 0 &&
      comidasUsuario.every(nombre => {
        const key = `${usuarioActivoObj.nombre}-${nombre}`;
        return datosComidas[key]?.length >= 1; // ğŸ”¹ mÃ­nimo 5 alimentos por comida
      });
  }
  
  if (activarLluvia) {
    iniciarLluvia();
  } else {
    detenerLluvia();
  }
}

let lluviaActiva = false;
let audioBite;
let emojisActivos = [];
let lluviaContainer;
let spawnInterval;

function iniciarLluvia() {
  if (lluviaActiva) return;
  lluviaActiva = true;
  
  // ğŸµ Audio integrado
  audioBite = new Audio("data:audio/mpeg;base64,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GbwSMViKGIqIp+BpGIoBt5u6DEj//////CJFAYRUDIoRUGEU4RIqBkUIr///4RSMBt4IoDCK/////hEioGRRvAGkcioGRQiv////4RIp8DIokfgwioMbzwMiiRgNIxFIRIoBkUIp//wMipFP////hEioGRQiv///4MIog+DFOCsOmAR2WACYUChWFTIxHMbN0+tMTRDdLAVM7Hc1QRysbmNhuY3RBWbvM3G8zc+zRCJMbjY0SNjG42KxuYoKGKipigqYqKFaOaM7mbG5WbmbRJm8QcTuHumx7kSWDYzeIPdiDidw9028sG3lbf5t7cWG825uP7+j+vs/r7NubziIk4iJPciTNjf/LBuWDYzc2Kzf/8sCpigqWBQxUU/zFRTzFRTzFRQwEBMcASwAmAAJgICYAAf/lgBLAAVgBWAlYAVgP//+WBX/8sCvlYr/lYoYoK//+WAD/KwHywAFgAMBADAAEsABWAmA//PkZO0s6f8cAK5sACO7JbQBXLAAgBgACVgJgACWADywAeWAEwAA8rASsA8rACsBLAAWAArAfKwD//////ywAf5YAf/1Pf6Y6nSn0xkxPTE9TpTtTtMZTv//1OlO/TF/1Pep71OvcmD//4O//+DP/3K///4M+DoM//+D/+D///oKGN0cboqL////6L///+j/ywsjWazNZLM1kszWeANZ4E1ks/LCD/ywg/NZLLzWazLCzK1n/+WFmVrM1ksjWSzAzACyAxZizAxZpQA+V5cBjHgNKLHwMwJgANKBgAiLMGCywiLMGCz/////////4GIMQQREEDBB/////4MFn///4RAf//+BmBMADBZ8DFmYADFmLMIiyCJgQYLL//hEFtWalhVzWS1y2SusJiSmKVhcMZaYgQEc4MJGVssqEQlugJLG4QiSYzZsEAjnCiyK+VEEkiZVNUmBMsMEhMiQxTPTOBJbJVTKIAoV00218q4ZaX5bK5EGFy0N0zH8ZMm0p+NJGRj6KMvi+PqcwE5a72WrsZICAh4QuWmQPCU0HOVBtM5EB34Mg5yLt9sySD4uu6dHGPv3qSkvU9Pei0nf9/ZLJZNJGSMmdB1I3QxtW9MeNoL0H0VD9BGY269BGHUo3yol//PkZMEuchdDfM1kACurHjQBiqAAcUYqAgqFgAwBJJMUMR9TynaYv+mKp7ywOp5Mej//ov+MRj4x9A6k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//PkZAAAAAGkAAAAAAAAA0gAAAAATEFNRTMuMTAwqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuMTAwqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq");
  audioBite.volume = 0.5;
  
  // Crear contenedor de la lluvia
  lluviaContainer = document.createElement("div");
  lluviaContainer.id = "lluvia-emojis";
  Object.assign(lluviaContainer.style, {
    position: "fixed",
    top: 0,
    left: 0,
    width: "100%",
    height: "100%",
    pointerEvents: "none",
    overflow: "hidden",
    zIndex: 9999
  });
  document.body.appendChild(lluviaContainer);
  
  const emojisComida = [ "ğŸ", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«", "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ",
 "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ†", "ğŸ¥‘", "ğŸ«›", "ğŸ¥¦", "ğŸ¥¬", "ğŸ¥’", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸŒ½", "ğŸ¥•", "ğŸ«’", "ğŸ§„",
 "ğŸ§…", "ğŸ¥”", "ğŸ ", "ğŸ«š", "ğŸ¥", "ğŸ¥¯", "ğŸ", "ğŸ¥–", "ğŸ¥¨", "ğŸ§€", "ğŸ¥š", "ğŸ³", "ğŸ§ˆ", "ğŸ¥",
 "ğŸ§‡", "ğŸ¥“", "ğŸ¥©", "ğŸ—", "ğŸ–", "ğŸ¦´", "ğŸŒ­", "ğŸ”", "ğŸŸ", "ğŸ•", "ğŸ«“", "ğŸ¥ª", "ğŸ¥™", "ğŸ§†", "ğŸŒ®",
 "ğŸŒ¯", "ğŸ«”", "ğŸ¥—", "ğŸ¥˜", "ğŸ«•", "ğŸ¥«", "ğŸ«™", "ğŸ", "ğŸœ", "ğŸ²", "ğŸ›", "ğŸ£", "ğŸ±", "ğŸ¥Ÿ", "ğŸ¦ª",
 "ğŸ¤", "ğŸ™", "ğŸš", "ğŸ˜", "ğŸ¥", "ğŸ¥ ", "ğŸ¥®", "ğŸ¢", "ğŸ¡", "ğŸ§", "ğŸ¨", "ğŸ¦", "ğŸ¥§", "ğŸ§", "ğŸ°",
 "ğŸ‚", "ğŸ®", "ğŸ­", "ğŸ¬", "ğŸ«", "ğŸ¿", "ğŸ©", "ğŸª", "ğŸŒ°", "ğŸ¥œ", "ğŸ«˜"];
 
  function crearEmoji() {
    const span = document.createElement("span");
    const fontSize = 48; // tamaÃ±o fijo para cÃ¡lculo de lÃ­mites
    span.innerText = emojisComida[Math.floor(Math.random() * emojisComida.length)];
    span.style.position = "absolute";
    span.style.top = `0px`;
    span.style.fontSize = `${fontSize}px`;
    span.style.filter = "drop-shadow(0 0 2px rgba(0, 0, 0, 0.7))";
    span.style.willChange = "transform";
    span.style.pointerEvents = "auto";
    
    // Limitar posiciÃ³n horizontal para que no se salga de la pantalla
    const maxLeft = window.innerWidth - fontSize;
    span.style.left = `${Math.random() * maxLeft}px`;
    
    // Clic para sonido
    span.onclick = () => {
  // ğŸ”‡ Si el audio estÃ¡ sonando, lo detenemos
  if (!audioBite.paused) {
    audioBite.pause();
    audioBite.currentTime = 0;
  }
  
  // â–¶ï¸ Reproducir el nuevo sonido
  audioBite.play().catch(() => {});
  
  // ğŸ§¹ Remover emoji clickeado
  span.remove();
  emojisActivos = emojisActivos.filter(e => e.el !== span);
};
    
    lluviaContainer.appendChild(span);
    emojisActivos.push({
      el: span,
      y: -fontSize,
      velocidad: 1 + Math.random() * 1
    });
  }
  
  // AnimaciÃ³n fluida
  function animar() {
    if (!lluviaActiva) return;
    
    const alturaViewport = window.innerHeight;
    
    for (let i = emojisActivos.length - 1; i >= 0; i--) {
      const e = emojisActivos[i];
      e.y += e.velocidad;
      e.el.style.transform = `translate3d(0, ${e.y}px, 0)`; // usar GPU
      
      // Eliminar emojis fuera de pantalla
      if (e.y > alturaViewport + 50) {
        e.el.remove();
        emojisActivos.splice(i, 1);
      }
    }
    
    requestAnimationFrame(animar);
  }
  
  // Crear emojis cada X ms
  spawnInterval = setInterval(crearEmoji, 1200);
  
  animar();
}

function detenerLluvia() {
  if (!lluviaActiva) return;
  if (spawnInterval) clearInterval(spawnInterval);
  
  emojisActivos.forEach(e => e.el.remove());
  emojisActivos = [];
  
  if (lluviaContainer) lluviaContainer.remove();
  lluviaActiva = false;
}

function verificarLluvia() {
  const usuarioActivoObj = usuariosMap[usuarioActivo];
  let activarLluvia = false;
  
  if (usuarioActivoObj) {
    const comidasUsuario = Object.keys(usuarioActivoObj.comidas);
    activarLluvia =
      comidasUsuario.length > 0 &&
      comidasUsuario.every(nombre => {
        const key = `${usuarioActivoObj.nombre}-${nombre}`;
        return datosComidas[key]?.length >= 1; // âœ… 1 alimento mÃ­nimo
      });
  }
  
  if (activarLluvia) {
    iniciarLluvia();
  } else {
    detenerLluvia();
  }
}

function renderizarDistribucion(usuario) {
  if (!usuario) usuario = usuariosMap[usuarioActivo];
  
  const contenedor = document.getElementById("tabla-distribucion-vdr");
  if (!contenedor) return;
  
  const panel = document.createElement("section");
  panel.style.margin = "0.5rem";
  
  // Usamos los valores temporales si existen, si no los definitivos
  const valoresTemp = usuario.distribucionTemp || usuario.distribucionVDR || { ...distribucionVDR };
  
  panel.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Comidas / Total</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>VDR%</th>
        </tr>
      </thead>
      <tbody>
        ${
          comidas.concat("Total").map(c => {
            const vdrValor = valoresTemp[c] || 0;
            return `
              <tr>
                <td>${c}</td>
                <td>0.00</td>
                <td>g</td>
                <td style="color:#2e7d32;">
                  ${
                    c === "Total"
                    ? `${vdrValor}%`
                    : `<span contenteditable="true" inputmode="decimal" data-max-digitos="2" data-comida="${c}" 
                        style="display:inline-block;">${vdrValor}</span>%`
                  }
                </td>
              </tr>`;
          }).join("")
        }
      </tbody>
    </table>
  `;
  
  contenedor.innerHTML = "";
  contenedor.appendChild(panel);
  
  // Guardamos cambios solo en distribucionTemp
  contenedor.querySelectorAll("span[contenteditable]").forEach(span => {
    span.addEventListener("input", () => {
      const comida = span.dataset.comida;
      if (!usuario.distribucionTemp) usuario.distribucionTemp = { ...usuario.distribucionVDR };
      let val = parseFloat(span.textContent);
      if (isNaN(val)) val = 0;
      usuario.distribucionTemp[comida] = val;
    });
  });
  Input(contenedor);
}

function renderPanelVDR(usuario) {
  const contenedor = document.getElementById("tabla-vdr");
  if (!contenedor || !usuario) return;
  
  const userVDR = usuario.vdr; // usar VDR del usuario
  const fragment = document.createDocumentFragment();
  
  for (const [categoria, contenido] of Object.entries(nutrientes)) {
    if (categoria.toLowerCase().includes("fisicoquÃ­micas")) continue;
    
    const section = document.createElement("section");
    section.style.margin = "0.5rem";
    
    const tabla = document.createElement("table");
    tabla.innerHTML = `
      <thead>
        <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;background:#f0f0f0;font-weight:600">${categoria}</td></tr>
      </tbody>
    `;
    const tbody = tabla.querySelector("tbody");
    
    (function render(nodo) {
      if (Array.isArray(nodo)) {
        nodo.forEach(n => {
          const valor = userVDR[n.nombre];
          const displayValor = typeof valor === "number" ? valor : "";
          const porc = "100%";
          const color = "#2e7d32";
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${n.nombre}</td>
            <td>
              <div contenteditable="true" inputmode="decimal" data-max-digitos="4"
                   data-nutriente="${n.nombre}" 
                   class="input-editor"
                   placeholder="0.00">${displayValor}</div>
            </td>
            <td>${n.unidad}</td>
            <td style="color:${color}">${porc}</td>
          `;
          tbody.appendChild(tr);
        });
      } else if (nodo && typeof nodo === "object") {
        for (const [subtitulo, subn] of Object.entries(nodo)) {
          tbody.insertAdjacentHTML(
            "beforeend",
            `<tr><td colspan="4" style="text-align:center;background:#f0f0f0;font-weight:600;font-size:.8rem">${subtitulo}</td></tr>`
          );
          render(subn);
        }
      }
    })(contenido);
    
    section.appendChild(tabla);
    fragment.appendChild(section);
  }
  
  contenedor.innerHTML = "";
  contenedor.appendChild(fragment);
  Input(contenedor);
}

function renderEditorManual(comida) {
  const cont = document.getElementById(`editor-${comida}`);
  if (!cont) return;
  
  const frag = document.createDocumentFragment();
  datosManualesUnidades[comida] ||= {};
  datosManuales[comida] ||= {};
  
  function formatNumber(v) {
    if (isNaN(v)) return "";
    return parseFloat(v.toFixed(2)).toString();
  }
  
  for (const [cat, contn] of Object.entries(nutrientes)) {
    const t = document.createElement("table");
    t.style.marginBottom = ".5rem";
    t.innerHTML = `
      <thead>
        <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;background:#f9f9f9;font-weight:600;font-size:.8rem">${cat}</td></tr>
      </tbody>
    `;
    const tb = t.querySelector("tbody");
    
    (function r(nodo) {
      if (Array.isArray(nodo)) {
        nodo.forEach(n => {
          let usuario, comidaReal;
          if (comida.includes("-")) {
            [usuario, comidaReal] = comida.split("-");
          } else {
            usuario = usuarioActivo;
            comidaReal = comida;
          }
          
          const calculo = calcularComida(usuario, comidaReal) || {};
          const valManual = datosManuales[comida][n.nombre] || 0;
          const uA = datosManualesUnidades[comida][n.nombre] || n.unidad;
          const total = convertir(valManual, uA, n.unidad) + (calculo[n.nombre] || 0);
          
          const base = usuariosMap[usuario]?.vdr?.[n.nombre] || 0;
          const porc = base ? ((total / base) * 100).toFixed(1) : "0.0";
          
          const obj = usuariosMap[usuario]?.distribucionVDR?.[comidaReal] || 25;
          const m = obj * 0.05;
          
          const col =
            porc >= obj - m && porc <= obj + m ?
            coloresVDR.verde :
            (porc >= obj - 2 * m && porc < obj - m) ||
            (porc > obj + m && porc <= obj + 2 * m) ?
            coloresVDR.amarillo :
            coloresVDR.rojo;
          
          const tipoOrig = tipoUnidad(n.unidad);
          let unidades = [];
          
          if (tipoOrig) {
            unidades = Object.keys(conversiones[tipoOrig]);
            if ((tipoOrig === "masa" || tipoOrig === "volumen") && n.nombre === "Agua") {
              const tipoExtra = tipoOrig === "masa" ? "volumen" : "masa";
              unidades = [...new Set([...unidades, ...Object.keys(conversiones[tipoExtra])])];
            }
          }
          
          const opts = unidades
            .map(u => `<option value="${u}" ${u === uA ? "selected" : ""} data-unidad-original="${n.unidad}">${u}</option>`)
            .join("");
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${n.nombre}</td>
            <td><div contenteditable="true" inputmode="decimal" data-nutriente="${n.nombre}" class="w-full" placeholder="0.00"></div></td>
            <td><select class="select-editor" tabindex="-1" data-unidad="${n.nombre}">${opts}</select></td>
            <td id="vdr-${comida}-${n.nombre}" style="color:${col}">${porc}%</td>
          `;
          tb.appendChild(tr);
          
          const cel = tr.querySelector("[contenteditable]");
          
          // Input editable con validaciÃ³n lÃ­mite
          cel.addEventListener("input", e => {
            let texto = e.target.textContent;
            texto = texto.replace(/[^0-9.,]/g, "").replace(",", ".");
            const partes = texto.split(".");
            if (partes.length > 2) texto = partes[0] + "." + partes.slice(1).join("");
            
            const match = texto.match(/^(\d{0,7})(?:\.(\d{0,2}))?$/);
            if (!match) {
              const [enteros, decimales] = texto.split(".");
              const ent = (enteros || "").slice(0, 7);
              const dec = (decimales || "").slice(0, 2);
              texto = dec ? `${ent}.${dec}` : ent;
            }
            
            const selRange = window.getSelection();
            const rango = selRange.getRangeAt(0);
            const pos = rango.startOffset;
            
            e.target.textContent = texto;
            
            const newRange = document.createRange();
            newRange.setStart(e.target.firstChild || e.target, Math.min(pos, texto.length));
            newRange.collapse(true);
            selRange.removeAllRanges();
            selRange.addRange(newRange);
            
            const valorNuevo = parseFloat(texto) || 0;
            
            // âš ï¸ Total actual usando calcularComida
            const totales = calcularComida(usuario, comidaReal) || {};
            const totalActual = totales[n.nombre] || 0;
            
            if (totalActual + valorNuevo > 9999999) {
  // âœ… Primero quitar foco
  cel.blur();
  
  // âœ… Luego mostrar el toast despuÃ©s de 200 ms
  setTimeout(() => {
    mostrarToast(`No se puede agregar mÃ¡s "${n.nombre}", superarÃ­a el lÃ­mite de 7 dÃ­gitos enteros.`, 2500);
  }, 200);
  
  cel.textContent = "";
  return;
}
            
            datosManuales[comida][n.nombre] = valorNuevo;
            VDREditor(comida, n.nombre, tr.querySelector("select")?.value);
          });
          
          // Select de unidad con validaciÃ³n lÃ­mite
          tr.querySelector("select").addEventListener("change", e => {
            const nuevaUnidad = e.target.value;
            const unidadActual = datosManualesUnidades[comida][n.nombre] || n.unidad;
            const valorConvertido = convertir(datosManuales[comida][n.nombre] || 0, unidadActual, nuevaUnidad);
            
            // âš ï¸ Total actual usando calcularComida
            const totales = calcularComida(usuario, comidaReal) || {};
            const totalActual = totales[n.nombre] || 0;
            
            if (totalActual + valorConvertido > 9999999) {
  // âœ… Primero quitar foco del input activo (si lo hay)
  document.activeElement?.blur();
  
  // âœ… Mostrar toast despuÃ©s de 200 ms
  setTimeout(() => {
    mostrarToast(`No se puede convertir "${n.nombre}", superarÃ­a el lÃ­mite de 7 dÃ­gitos enteros.`, 2500);
  }, 200);
  
  e.target.value = unidadActual;
  return;
}
            
            cel.textContent = valorConvertido ? formatNumber(valorConvertido) : "";
            datosManuales[comida][n.nombre] = valorConvertido;
            datosManualesUnidades[comida][n.nombre] = nuevaUnidad;
            VDREditor(comida, n.nombre, nuevaUnidad);
          });
        });
      } else if (nodo && typeof nodo === "object") {
        for (const [s, sub] of Object.entries(nodo)) {
          tb.insertAdjacentHTML(
            "beforeend",
            `<tr><td colspan="4" style="text-align:center;font-weight:600;background:#f0f0f0;font-size:.8rem">${s}</td></tr>`
          );
          r(sub);
        }
      }
    })(contn);
    
    frag.appendChild(t);
  }
  
  cont.innerHTML = "";
  cont.appendChild(frag);
  Input(cont);
}

function aplicarManual(comida) {
  const editorEl = document.getElementById(`editor-${comida}`);
  if (!editorEl) return false;

  const celdas = [...editorEl.querySelectorAll('[contenteditable][data-nutriente]')];
  let huboCambios = false;

  for (const celda of celdas) {
    const nombre = celda.dataset.nutriente;
    if (!nombre) continue;

    const valorCrudo = (celda.textContent || "").trim().replace(",", ".");
    const cantidadIngresada = parseFloat(valorCrudo);

    if (!isFinite(cantidadIngresada) || cantidadIngresada === 0) continue;

    const fila = celda.closest("tr");
    const sel = fila?.querySelector(`select[data-unidad="${nombre}"]`);
    const unidadIngresada =
      sel?.value ||
      datosManualesUnidades[comida]?.[nombre] ||
      nutrientesPlanos.find(n => n.nombre === nombre)?.unidad;

    if (!unidadIngresada) continue;

    const unidadBase = nutrientesPlanos.find(n => n.nombre === nombre)?.unidad || unidadIngresada;
    const cantidadConvertida = convertir(cantidadIngresada, unidadIngresada, unidadBase);

    // Determinar usuario y comidaReal para calcularComida correctamente
    let usuario, comidaReal;
    if (comida.includes("-")) {
      [usuario, comidaReal] = comida.split("-");
    } else {
      usuario = usuarioActivo;
      comidaReal = comida;
    }

    // Totales actuales reales (fuente de verdad)
    const totalesActuales = calcularComida(usuario, comidaReal) || {};
    const actualEnBase = totalesActuales[nombre] || 0;
    const nuevoTotal = actualEnBase + cantidadConvertida;

    if (nuevoTotal > 9999999) {
      // simplemente ignorar el intento y limpiar
      celda.textContent = "";
      continue;
    }

    datosComidas[comida] ||= [];

    // Agregar elemento manual (ya en unidad base)
    datosComidas[comida].push({
      alimento: {
        nombre,
        unidad: unidadIngresada,
        esManual: true,
        displayManual: `${nombre} ${cantidadIngresada} ${unidadIngresada}`,
        composicion: { [nombre]: cantidadConvertida }
      },
      peso: 100
    });

    huboCambios = true;

    // Limpiar input y disparar evento para actualizar render
    celda.textContent = "";
    const ev = typeof InputEvent === "function"
      ? new InputEvent("input", { bubbles: true })
      : new Event("input", { bubbles: true });
    celda.dispatchEvent(ev);

    // Resetear unidad a la original si corresponde
    if (sel) {
      const opcionOriginal = sel.querySelector("option[data-unidad-original]");
      const unidadOriginal = opcionOriginal?.dataset.unidadOriginal || unidadBase;
      sel.value = unidadOriginal;
      VDREditor(comida, nombre, unidadOriginal);
    }
  }

  if (huboCambios) {
    actualizarListaAgregados(comida);
  }

  return huboCambios;
}

function VDREditor(comida, nutriente, unidad = null) {
  let [usuario, comidaReal] = comida.includes("-") ?
    comida.split("-") : [usuarioActivo, comida];
  
  const calculo = calcularComida(usuario, comidaReal) || {};
  const datosManual = datosManuales[comida] || {};
  
  const n = nutrientesPlanos.find(n => n.nombre === nutriente);
  if (!n) return;
  
  const val = datosManual[n.nombre] || 0;
  
  // ğŸ”§ usar la unidad seleccionada si se pasa, sino la original
  const u = unidad || n.unidad;
  const total = convertir(val, u, n.unidad) + (calculo[n.nombre] || 0);
  
  const cel = document.getElementById(`vdr-${comida}-${n.nombre}`);
  if (!cel) return;
  
  const dist = usuariosMap[usuario]?.distribucionVDR || {};
  const obj = dist[comidaReal] || 25;
  const m = obj * 0.05;
  
  const base = usuariosMap[usuario]?.vdr?.[n.nombre] || 0;
  const p = base ? (total / base) * 100 : 0;
  
  cel.textContent = p.toFixed(1) + "%";
  cel.style.color =
    p >= obj - m && p <= obj + m ? coloresVDR.verde :
    (p >= obj - 2 * m && p < obj - m) || (p > obj + m && p <= obj + 2 * m) ? coloresVDR.amarillo :
    coloresVDR.rojo;
}

function ocultarGrafico(comida) {
  if (graficos[comida]) {
    graficos[comida].destroy();
    delete graficos[comida];
    primerRender[comida] = false;
  }
}

function renderGrafico(comida, totales) {
  var canvas = document.getElementById("grafico-" + comida);
  if (!canvas) return;
  
  // Listener de pÃ©rdida de contexto
  if (!canvas._contextListenersAdded) {
    canvas.addEventListener("contextlost", function(e) {
      console.warn("Contexto perdido en", comida);
      e.preventDefault();
      handleContextLost(comida);
    });
    canvas._contextListenersAdded = true;
  }
  
  var ctx = canvas.getContext("2d");
  var labels = ["EnergÃ­a", "ProteÃ­nas", "Carbohidratos", "Grasas totales"];
  var datos = labels.map(function(l) { return totales[l] || 0; });
  
  // Primer render: sin animaciÃ³n
  if (!graficos[comida]) {
    graficos[comida] = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{
          data: datos,
          backgroundColor: ["#00BCD4", "#4CAF50", "#FFEB3B", "#F44336"]
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 0 },
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#000" }
          }
        }
      }
    });
    
    primerRender[comida] = true;
  } else {
    graficos[comida].data.datasets[0].data = datos;
    graficos[comida].options.animation = { duration: 15000 };
    graficos[comida].update();
  }
  
  graficos[comida]._ultimosTotales = totales;
}

function handleContextLost(comida) {
  console.warn(`ğŸ§± Contexto perdido en ${comida}, recreando canvas...`);
  
  const viejoCanvas = document.getElementById(`grafico-${comida}`);
  if (!viejoCanvas) return;
  
  // ğŸ§± Crear un nuevo canvas en su lugar
  const nuevoCanvas = document.createElement("canvas");
  nuevoCanvas.id = viejoCanvas.id;
  nuevoCanvas.className = viejoCanvas.className;
  nuevoCanvas.style.cssText = viejoCanvas.style.cssText;
  viejoCanvas.parentNode.replaceChild(nuevoCanvas, viejoCanvas);
  
  // âš™ï¸ Recuperar el Ãºltimo estado del grÃ¡fico (si existÃ­a)
  const totales = graficos[comida]?._ultimosTotales || {};
  
  // ğŸ”¥ Destruir cualquier instancia previa
  if (graficos[comida]) {
    try { graficos[comida].destroy(); } catch {}
    delete graficos[comida];
  }
  
  // ğŸ•’ Esperar un instante para asegurar que el DOM estÃ© listo
  setTimeout(() => {
    // Permitir volver a agregar el listener al nuevo canvas
    nuevoCanvas._contextListenersAdded = false;
    
    // ğŸ§© Determinar si el grÃ¡fico pertenece al usuario activo
    const [nombreUsuario] = comida.split("-");
    const esUsuarioActivo = usuarioActivo === nombreUsuario;
    
    if (esUsuarioActivo) {
      // ğŸ¯ Usuario activo â†’ render normal con primerRender respetado
      renderGrafico(comida, totales);
      primerRender[comida] = true;
    } else {
      // ğŸ’¤ Otro usuario â†’ render silencioso, sin animaciÃ³n ni bloqueo
      renderizarGraficosDeTodosLosUsuarios();
    }
  }, 100);
}

function renderizarGraficosDeTodosLosUsuarios() {
  Object.keys(usuariosMap).forEach(function(nombreUsuario) {
    var usuario = usuariosMap[nombreUsuario];
    if (!usuario.comidas) return;
    
    Object.keys(usuario.comidas).forEach(function(nombreComida) {
      var key = usuario.nombre + "-" + nombreComida;
      var comida = usuario.comidas[nombreComida];
      if (!comida.totales) return;
      
      var canvas = document.getElementById("grafico-" + key);
      if (canvas) renderGrafico(key, comida.totales);
    });
  });
}

function renderTabla(comida, totales) {
  const contenedor = document.getElementById(`tabla-${comida}`);
  if (!contenedor) return;
  
  const frag = document.createDocumentFragment();
  
  let usuario = usuariosMap[usuarioActivo];
  let comidaReal = comida;
  if (comida.includes("-")) {
    const parts = comida.split("-");
    if (parts[0] === "total") {
      usuario = usuariosMap[parts[1]];
      comidaReal = "total";
    } else {
      usuario = usuariosMap[parts[0]];
      comidaReal = parts[1];
    }
  }
  
  for (const [cat, cont] of Object.entries(nutrientes)) {
    if (comidaReal === "total" && cat.toLowerCase().includes("fisicoquÃ­micas")) continue;
    
    const tabla = document.createElement("table");
    tabla.style.marginBottom = ".5rem";
    tabla.innerHTML = `
      <thead><tr>
        <th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody = tabla.querySelector("tbody");
    
    function renderNodo(nodo, nombreCategoria) {
      let tieneNutrientes = false;
      
      if (Array.isArray(nodo)) {
        nodo.forEach(n => {
          const rawVal = totales[n.nombre];
          let val;
          
          if (rawVal == null || rawVal === 0) {
            val = "0.00";
          } else if (Number.isInteger(rawVal)) {
            val = rawVal;
          } else {
            val = rawVal.toFixed(2);
          }
          
          // Flag de lÃ­mite
          if (!limitesNutrientes[comida]) limitesNutrientes[comida] = {};
          const numVal = parseFloat(val);
          limitesNutrientes[comida][n.nombre] = numVal >= 9999999;
          
          if (mostrarTodosLosNutrientes[comida] || parseFloat(val) !== 0) {
            const base = usuario.vdr[n.nombre] || 0;
            let porcTxt = "-";
            let color = "#000";
            
            if (n.nombre !== "pH (alimento)" && n.nombre !== "pH estimado en estÃ³mago") {
              const porc = base ? ((parseFloat(val) / base) * 100).toFixed(1) : "0.0";
              const p = parseFloat(porc);
              porcTxt = porc + "%";
              
              if (comidaReal === "total") {
                color = p >= 95 && p <= 105 ? coloresVDR.verde :
                  (p >= 90 && p < 95) || (p > 105 && p <= 110) ? coloresVDR.amarillo :
                  coloresVDR.rojo;
              } else {
                const obj = usuario.distribucionVDR[comidaReal] || 25;
                const m = obj * 0.05;
                color = p >= obj - m && p <= obj + m ? coloresVDR.verde :
                  (p >= obj - 2 * m && p < obj - m) || (p > obj + m && p <= obj + 2 * m) ? coloresVDR.amarillo :
                  coloresVDR.rojo;
              }
            }
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="nombre-nutriente">${n.nombre}</td>
              <td>${val}</td>
              <td>${n.unidad}</td>
              <td style="color:${color}">${porcTxt}</td>
            `;
            tbody.appendChild(tr);
            tieneNutrientes = true;
            
            // DescripciÃ³n â€” fila oculta
            const descTr = document.createElement("tr");
            descTr.className = "descripcion-nutriente hidden";
            descTr.innerHTML = `
              <td colspan="4" style="
                font-size:.8rem;
                color:#black; font-weight:600; background:#f0f0f0;
              ">${n.descripcion || "Sin descripciÃ³n disponible."}</td>`;
            tbody.appendChild(descTr);
            
            // Mostrar / ocultar descripciÃ³n al tocar nombre
            tr.querySelector(".nombre-nutriente").addEventListener("click", () => {
              descTr.classList.toggle("hidden");
            });
          }
        });
      } else if (nodo && typeof nodo === "object") {
        for (const [sub, subn] of Object.entries(nodo)) {
          const antes = tbody.querySelectorAll("tr").length;
          const subTiene = renderNodo(subn, sub);
          
          if (subTiene) {
            const header = document.createElement("tr");
            header.innerHTML = `<td colspan="4" style="text-align:center;font-weight:600;background:#f0f0f0;font-size:.8rem">${sub}</td>`;
            tbody.insertBefore(header, tbody.children[antes]);
            tieneNutrientes = true;
          }
        }
      }
      
      return tieneNutrientes;
    }
    
    const tablaTiene = renderNodo(cont, cat);
    
    if (tablaTiene) {
      const headerPrincipal = document.createElement("tr");
      headerPrincipal.innerHTML = `<td colspan="4" style="text-align:center;font-weight:600;background:#f9f9f9;font-size:.8rem">${cat}</td>`;
      tbody.insertBefore(headerPrincipal, tbody.firstChild);
      frag.appendChild(tabla);
    }
  }
  
  contenedor.innerHTML = "";
  contenedor.appendChild(frag);
}

function Sistemas(usuario, totales) {
  const contenedor = document.getElementById(`contenido-perfiles-${usuario}`);
  if (!contenedor) return;
  contenedor.innerHTML = "";
  
  Object.entries(sistemas).forEach(([categoria, subcategorias]) => {
    const section = document.createElement("div");
    section.className = "section perfil-funcional";
    section.dataset.categoria = categoria;
    section.style.marginBottom = "1rem";
    let html = `<section>
      <h4 style="text-align:center">${categoria}</h4>
    `;
    
    Object.entries(subcategorias).forEach(([subcategoria, listaNutrientes]) => {
      html += `
      <h5 style="text-align:left; margin-bottom:0.5rem">${subcategoria}</h5>
      <table class="tabla" style="margin-bottom:1rem">
        <thead>
          <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>VDR%</th></tr>
        </thead>
        <tbody>
          ${listaNutrientes.map(nutriente => {
            const cantidad = +(totales[nutriente] || 0).toFixed(2);
            const nInfo = nutrientesPlanos.find(n => n.nombre === nutriente);
            const unidad = nInfo?.unidad || "";
            // âœ… VDR especÃ­fico del usuario
            const base = usuariosMap[usuario]?.vdr?.[nutriente] || 0;
            const porc = base ? (cantidad / base) * 100 : 0;
            const p = +porc.toFixed(1);
            const porcTxt = p.toFixed(1) + "%";
            let color;
            if (p >= 95 && p <= 105) color = coloresVDR.verde;
            else if ((p >= 90 && p < 95) || (p > 105 && p <= 110)) color = coloresVDR.amarillo;
            else color = coloresVDR.rojo;

            return `
              <tr data-nutriente="${nutriente}">
                <td>${nutriente}</td>
                <td class="cantidad">${cantidad !== 0 ? cantidad : "0.00"}</td>
                <td class="unidad">${unidad}</td>
                <td class="vdr" style="color:${color}">${porcTxt}</td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>`;
    });
    
    html += `</section>`;
    section.innerHTML = html;
    contenedor.appendChild(section);
  });
}

function calcularPHComida(alimentosComida) {
  let sumaH = 0, sumaHEst = 0;
  let pesoConPH = 0, pesoConHEst = 0;

  (alimentosComida || []).forEach(({ alimento, peso }) => {
    const pHAlimento = alimento?.composicion?.["pH (alimento)"];
    const pHEst = alimento?.composicion?.["pH estimado en estÃ³mago"];

    if (Number.isFinite(pHAlimento)) {
      sumaH += Math.pow(10, -pHAlimento) * peso;
      pesoConPH += peso;
    }
    if (Number.isFinite(pHEst)) {
      sumaHEst += Math.pow(10, -pHEst) * peso;
      pesoConHEst += peso;
    }
  });
  
  const pH = (pesoConPH > 0 && sumaH > 0) ? -Math.log10(sumaH / pesoConPH) : null;
  const pHEst = (pesoConHEst > 0 && sumaHEst > 0) ? -Math.log10(sumaHEst / pesoConHEst) : null;

  return { pH, pHEst };
}

function compartirResultados(key) {
  let usuario, comida;
  if (key.startsWith("total-")) {
    usuario = key.replace("total-", "");
    comida = "total";
  } else {
    [usuario, comida] = key.split("-");
  }
  
  const totales = calcularComida(usuario, comida);
  
  // ğŸ”¤ Nombre visual limpio
  const nombreUsuario = (usuariosMap[usuario]?.nombreVisual || usuario).replace(/[^\p{L}\s]/gu, '');
  
  let titulo = comida === "total" ?
    `ğŸ“Š Resultados Totales de ${nombreUsuario}` :
    `ğŸ½ï¸ ${comida} de ${nombreUsuario}`;
  
  let texto = `${titulo}\n\n`;
  
  nutrientesPlanos.forEach(n => {
    const val = +(totales[n.nombre] || 0).toFixed(2);
    if (val === 0) return;
    
    const base = usuariosMap[usuario].vdr[n.nombre] || 0;
    let porcTxt = "-";
    let icono = "";
    
    if (n.nombre !== "pH (alimento)" && n.nombre !== "pH estimado en estÃ³mago") {
      if (base) {
        const porc = +(val / base * 100).toFixed(1);
        porcTxt = porc + "%";
        
        if (comida === "total") {
          icono = porc >= 95 && porc <= 105 ? "âœ”ï¸" :
            (porc >= 90 && porc < 95) || (porc > 105 && porc <= 110) ? "â—" :
            "âŒ";
        } else {
          const obj = usuariosMap[usuario].distribucionVDR[comida] || 25;
          const m = obj * 0.05;
          icono = porc >= obj - m && porc <= obj + m ? "âœ”ï¸" :
            (porc >= obj - 2 * m && porc < obj - m) || (porc > obj + m && porc <= obj + 2 * m) ? "â—" :
            "âŒ";
        }
      }
    }
    
    texto += `${icono} ${n.nombre}: ${val} ${n.unidad} (${porcTxt})\n`;
  });
  
  navigator.clipboard.writeText(texto)
    .catch(err => console.error("Error copiando al portapapeles:", err));
  
  // ğŸ”¹ Mensaje adaptado para comidas y total
  const mensajeToast = comida === "total" ?
    `Total de ${nombreUsuario} copiado correctamente.` :
    `${comida.charAt(0).toUpperCase() + comida.slice(1)} de ${nombreUsuario} copiado correctamente.`;
  
  mostrarToast(mensajeToast);
  
  return texto;
}

function compartirAlimentos(usuarioComida) {
  const [usuarioOrigen, comida] = usuarioComida.split("-");
  
  const otrosUsuarios = ordenUsuarios
    .filter(u => u !== usuarioOrigen && u !== "Calculadora Nutricional");
  
  if (otrosUsuarios.length === 0) {
    return mostrarToast("No hay otros usuarios para compartir");
  }
  
  function soloLetras(str) {
    return str.replace(/[^\p{L}\s]/gu, '');
  }
  
  const opciones = otrosUsuarios.map(u => {
  const nombreOriginal = usuariosMap[u].nombreVisual || u;
  const nombreSoloLetras = soloLetras(nombreOriginal);
  return `
    <label class="compartir-opcion">
      <input type="checkbox" class="compartir-check" value="${u}" checked>
      <span style="color: black; font-weight: bold;">${nombreSoloLetras}</span>
    </label>
  `;
}).join("");
  
  mostrarConfirmacion(
    `<p>Compartir alimentos con:</p>${opciones}`,
    () => {
      const seleccionados = Array.from(document.querySelectorAll(".compartir-check:checked"))
        .map(chk => chk.value);
      
      if (seleccionados.length === 0) {
        return mostrarToast("No seleccionaste ningÃºn usuario");
      }
      
      const items = datosComidas[usuarioComida] || [];
      if (items.length === 0) {
        return mostrarToast("No hay alimentos para compartir");
      }
      
      const exitos = [];
      const bloqueados = [];
      
      // Recorremos cada usuario seleccionado y validamos
      for (const destUser of seleccionados) {
        const totalesDestino = calcularComida(destUser, comida) || {};
        let falla = false;
        const motivos = new Set();
        
        // Para cada item a compartir
        for (const i of items) {
          const peso = i.peso || 0;
          const compos = i.alimento?.composicion || {};
          
          // Para cada nutriente en la composiciÃ³n del alimento
          for (const [nutriente, valorPor100] of Object.entries(compos)) {
            // cantidad que se sumarÃ­a en la unidad base (calcularComida devuelve en base)
            const incremento = (valorPor100 * (peso / 100));
            const actual = totalesDestino[nutriente] || 0;
            if (actual + incremento > 9999999) {
              falla = true;
              motivos.add(nutriente);
            }
            // si ya hay falla, igualmente seguimos calculando para obtener todos los motivos
          }
        }
        
        if (falla) {
          bloqueados.push({ usuario: destUser, motivos: Array.from(motivos) });
          // no agregar nada para este destinatario
        } else {
          // agregar todos los items (se conserva la estructura que usabas)
          const keyDestino = `${destUser}-${comida}`;
          if (!datosComidas[keyDestino]) datosComidas[keyDestino] = [];
          items.forEach(i => {
            datosComidas[keyDestino].push({ alimento: i.alimento, peso: i.peso });
          });
          exitos.push(destUser);
        }
      } // end for cada destinatario
      
      // Mostrar resultados: Ã©xitos y bloqueos
if (exitos.length > 0) {
  const nombresExitos = exitos.map(u => soloLetras(usuariosMap[u].nombreVisual || u));
  mostrarToast(`
    <div style="
      width: 50vw;
      max-width: none;
      line-height: 1.2;
      text-align: center;
      font-family: inherit;
    ">
      <span style="display:block; font-weight:600;">Alimentos compartidos con:</span>
      <div style="text-align:left; margin-top:10px;">
        ${nombresExitos.map(n => `
          <div style="display:flex; align-items:center; margin-bottom:2px;">
            <span style="line-height:0;">â—</span>
            <span style="margin-left:2px;">${n}</span>
          </div>
        `).join("")}
      </div>
    </div>
  `, 2000);
}

if (bloqueados.length > 0) {
  const nombresBloqueados = bloqueados.map(b => {
    const nombre = soloLetras(usuariosMap[b.usuario].nombreVisual || b.usuario);
    return `
      <div style="display:flex; align-items:center; margin-bottom:2px;">
        <span style="line-height:0;">â—</span>
        <span style="margin-left:2px; color:black; font-weight:bold;">${nombre}</span>
      </div>
    `;
  }).join("");
  
  mostrarToast(`
    <div style="
      width: 50vw;
      max-width: none;
      line-height: 1.2;
      text-align: center;
      font-family: inherit;
    ">
      <span style="display:block; font-weight:600; margin-bottom:6px;">
        No se pudo compartir alimentos con:
      </span>
      <div style="text-align:left; margin-top:10px;">
        ${nombresBloqueados}
      </div>
      <div style="margin-top:10px;">
        Porque uno o mÃ¡s nutrientes superarÃ­an el lÃ­mite de 10 millones.
      </div>
    </div>
  `, 3000);
}
    },
    () => {
      mostrarToast("OperaciÃ³n cancelada");
    }
  );
  
  // ajustar texto botÃ³n confirmar si hace falta
  const botonAceptar = document.getElementById("alerta-aceptar");
  if (botonAceptar) botonAceptar.textContent = "Aceptar";
}

const toastQueue = [];
let toastActivo = false;

function mostrarToast(mensaje, duracion = 1000) {
  toastQueue.push({ mensaje, duracion });
  procesarToast();
}

function procesarToast() {
  if (toastActivo) return; // ya hay un toast mostrÃ¡ndose
  
  if (toastQueue.length === 0) return;
  
  const { mensaje, duracion } = toastQueue.shift();
  const toast = document.getElementById("toast");
  if (!toast) return;
  
  const contenido = toast.querySelector(".toast-contenido");
  contenido.innerHTML = mensaje;
  
  toast.classList.add("mostrar");
  document.body.style.overflow = 'hidden';
  toastActivo = true;
  
  const cerrarToast = () => {
    toast.classList.remove("mostrar");
    document.body.style.overflow = '';
    toastActivo = false;
    // Esperar un pequeÃ±o delay antes de mostrar el siguiente
    setTimeout(procesarToast, 200);
  };
  
  // Cerrar toast automÃ¡ticamente despuÃ©s de duracion
  const timeoutId = setTimeout(cerrarToast, duracion);
  
  // TambiÃ©n permitir cerrar con click fuera
  const clickFuera = (e) => {
    if (e.target === toast) {
      clearTimeout(timeoutId);
      cerrarToast();
      toast.removeEventListener("click", clickFuera);
    }
  };
  toast.addEventListener("click", clickFuera);
}

function mostrarConfirmacion(mensaje, onAceptar, onCancelar, opcionesBoton = {}) {
  const modal = document.getElementById("alerta-modal");
  const texto = modal.querySelector("#alerta-texto");
  const btnAceptar = document.getElementById("alerta-aceptar");
  const btnCancelar = document.getElementById("alerta-cancelar");
  
  texto.innerHTML = mensaje;
  
  // Guardar estilos originales del botÃ³n
  const textoOriginal = btnAceptar.innerHTML;
  const bgOriginal = btnAceptar.style.backgroundColor;
  const colorOriginal = btnAceptar.style.color;
  
  // Aplicar estilos personalizados si existen
  if (opcionesBoton.textoAceptar) btnAceptar.innerHTML = opcionesBoton.textoAceptar;
  if (opcionesBoton.colorAceptar) btnAceptar.style.backgroundColor = opcionesBoton.colorAceptar;
  if (opcionesBoton.colorTexto) btnAceptar.style.color = opcionesBoton.colorTexto;
  
  // Bloquear scroll
  document.body.style.overflow = 'hidden';
  document.documentElement.style.overflow = 'hidden';
  const touchHandler = (e) => e.preventDefault();
  modal.addEventListener('touchmove', touchHandler, { passive: false });
  
  modal.classList.remove("hidden");
  setTimeout(() => modal.classList.add("mostrar"), 0);
  
  const cerrarModal = () => {
    modal.classList.remove("mostrar");
    setTimeout(() => modal.classList.add("hidden"), 0);
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    modal.removeEventListener("click", clickFuera);
    modal.removeEventListener('touchmove', touchHandler);
    
    // Restaurar estilos originales del botÃ³n
    btnAceptar.innerHTML = textoOriginal;
    btnAceptar.style.backgroundColor = bgOriginal;
    btnAceptar.style.color = colorOriginal;
  };
  
  btnAceptar.onclick = () => {
    setTimeout(() => {
      cerrarModal();
      if (onAceptar) onAceptar();
    }, 100);
  };
  
  btnCancelar.onclick = () => {
    setTimeout(() => {
      cerrarModal();
      if (onCancelar) onCancelar();
    }, 100);
  };
  
  const clickFuera = (e) => {
    if (e.target === modal) {
      cerrarModal();
      if (onCancelar) onCancelar();
    }
  };
  
  modal.addEventListener("click", clickFuera);
}
</script>
</body>
</html>